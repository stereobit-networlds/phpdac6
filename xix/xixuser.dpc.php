<?php
$__DPCSEC['XIXUSER_DPC']='1;1;1;1;1;1;1;1;1';

if (!defined("XIXUSER_DPC")) {
define("XIXUSER_DPC",true);

$__DPC['XIXUSER_DPC'] = 'xixuser';

$__EVENTS['XIXUSER_DPC'][0]= "xixuser";
$__EVENTS['XIXUSER_DPC'][1]= "xixset";
$__EVENTS['XIXUSER_DPC'][2]= 'get_usage';
$__EVENTS['XIXUSER_DPC'][3]= 'get_user_reminders';
$__EVENTS['XIXUSER_DPC'][4]= 'toggle_user_reminder';
$__EVENTS['XIXUSER_DPC'][5]= 'change_user_details';
$__EVENTS['XIXUSER_DPC'][6]= "xixuserslist";
$__EVENTS['XIXUSER_DPC'][7]= 'show_user_details';
$__EVENTS['XIXUSER_DPC'][8]= 'is_social';
$__EVENTS['XIXUSER_DPC'][9]= 'get_user_socialize';
$__EVENTS['XIXUSER_DPC'][10]= 'toggle_user_socialize';
$__EVENTS['XIXUSER_DPC'][11]= 'show_xixuser';
$__EVENTS['XIXUSER_DPC'][12]= 'getexchanges';
$__EVENTS['XIXUSER_DPC'][13]= 'getpurchases';
$__EVENTS['XIXUSER_DPC'][14]= 'gettransports';
$__EVENTS['XIXUSER_DPC'][15]= 'getprojects';
$__EVENTS['XIXUSER_DPC'][16]= 'getusage';
$__EVENTS['XIXUSER_DPC'][17]= 'getusers';
$__EVENTS['XIXUSER_DPC'][18]= 'md5user';
$__EVENTS['XIXUSER_DPC'][19]= 'xixcp';

$__ACTIONS['XIXUSER_DPC'][0]= "xixuser";
$__ACTIONS['XIXUSER_DPC'][1]= "xixset";
$__ACTIONS['XIXUSER_DPC'][2]= 'get_usage';
$__ACTIONS['XIXUSER_DPC'][3]= 'get_user_reminders';
$__ACTIONS['XIXUSER_DPC'][4]= 'toggle_user_reminder';
$__ACTIONS['XIXUSER_DPC'][5]= 'change_user_details';
$__ACTIONS['XIXUSER_DPC'][6]= "xixuserslist";
$__ACTIONS['XIXUSER_DPC'][7]= 'show_user_details';
$__ACTIONS['XIXUSER_DPC'][8]= 'is_social';
$__ACTIONS['XIXUSER_DPC'][9]= 'get_user_socialize';
$__ACTIONS['XIXUSER_DPC'][10]= 'toggle_user_socialize';
$__ACTIONS['XIXUSER_DPC'][11]= 'show_xixuser';
$__ACTIONS['XIXUSER_DPC'][12]= 'getexchanges';
$__ACTIONS['XIXUSER_DPC'][13]= 'getpurchases';
$__ACTIONS['XIXUSER_DPC'][14]= 'gettransports';
$__ACTIONS['XIXUSER_DPC'][15]= 'getprojects';
$__ACTIONS['XIXUSER_DPC'][16]= 'getusage';
$__ACTIONS['XIXUSER_DPC'][17]= 'getusers';
$__ACTIONS['XIXUSER_DPC'][18]= 'md5user';
$__ACTIONS['XIXUSER_DPC'][19]= 'xixcp';

$__LOCALE['XIXUSER_DPC'][0]='XIXUSER_DPC;XIX User;XIX Χρήστης';
$__LOCALE['XIXUSER_DPC'][1]='_loading;Loading...;Φόρτωση...';
$__LOCALE['XIXUSER_DPC'][2]='_usage;My usage;Χρήση';
$__LOCALE['XIXUSER_DPC'][3]='_settings;My settings;Ρυθμίσεις';
$__LOCALE['XIXUSER_DPC'][4]='_details;My details;Στοιχεία';
$__LOCALE['XIXUSER_DPC'][5]='_update;Update;Ενημέρωση';
$__LOCALE['XIXUSER_DPC'][6]='_nickname;Name;Όνομα';
$__LOCALE['XIXUSER_DPC'][7]='_email;email;Ηλ. ταχυδρομείο';
$__LOCALE['XIXUSER_DPC'][8]='_remindersbymail;Send me reminders by email;Ενημέρωση με ηλ. ταχυδρομείο';
$__LOCALE['XIXUSER_DPC'][9]='_settingstext;Please verify that your details below are correct.;Επιβεβαιώστε τις ρυθμίσεις σας.';
$__LOCALE['XIXUSER_DPC'][10]='_detailstext;Update my details.;Ενημέρωση στοιχείων.';
$__LOCALE['XIXUSER_DPC'][11]='_savingandrefresh;Saving and refreshing...;Ενημέρωση';
$__LOCALE['XIXUSER_DPC'][12]='_saving;Saving...;Ενημέρωση';
$__LOCALE['XIXUSER_DPC'][13]='_usrnamecheck;Name must be <u>letters only</u> and be <u>4 to 12 letters long</u>. ;Το ψευδώνυμό σας πρέπει να είναι με <u>γράμματα μόνο</u> και να έχει μήκος απο <u>4 έως 19 χαρακτήρες</u>.';
$__LOCALE['XIXUSER_DPC'][14]='_reservations;Reservations;Καταχωρήσεις';
$__LOCALE['XIXUSER_DPC'][15]='_cost;Cost;Κόστος';
$__LOCALE['XIXUSER_DPC'][16]='_costperres;Current price per reservation;Κόστος ανα καταχώρηση';
$__LOCALE['XIXUSER_DPC'][17]='_active;Active;Ενεργό';
$__LOCALE['XIXUSER_DPC'][18]='_deleted;Inactive;Μη ενεργό';
$__LOCALE['XIXUSER_DPC'][19]='_resid;Reg date;Ημερ. καταχ.';
$__LOCALE['XIXUSER_DPC'][20]='_resdate;Action date;Ημερομηνία δράσης';
$__LOCALE['XIXUSER_DPC'][21]='_resuser;User;Χρήστης';
$__LOCALE['XIXUSER_DPC'][22]='_prjid;Reg date;Ημερ. κατ.';
$__LOCALE['XIXUSER_DPC'][23]='_prjdate;From-To;Απο -έως';
$__LOCALE['XIXUSER_DPC'][24]='_prjuser;User;Χρήστης';
$__LOCALE['XIXUSER_DPC'][25]='_project;Project;Δράση';
$__LOCALE['XIXUSER_DPC'][26]='_projects;XIX Projects;XIX Δράσεις';
$__LOCALE['XIXUSER_DPC'][27]='_success;Success;Επιτυχώς';
$__LOCALE['XIXUSER_DPC'][28]='_failed;Failed;Πρόβλημα';
$__LOCALE['XIXUSER_DPC'][29]='_notauserornotintime;Not a user or not in time;Δεν υπάρχουν συμμετέχοντες ή εκτός χρόνου';
$__LOCALE['XIXUSER_DPC'][30]='_notauser;Not a user;Δεν υπάρχουν συμμετέχοντες';
$__LOCALE['XIXUSER_DPC'][31]='_isubject;Invitation for;Πρόσκληση σε δράση';
$__LOCALE['XIXUSER_DPC'][32]='_rsubject;Reminder for;Ειδοποίηση για δράση';
$__LOCALE['XIXUSER_DPC'][33]='_longitude;Longitude;Γεωγραφικό μήκος';
$__LOCALE['XIXUSER_DPC'][34]='_latitude;Latitude;Γεωγραφικό πλάτος';
$__LOCALE['XIXUSER_DPC'][35]='_updategeo;Location;Γεωγραφική θέση';
$__LOCALE['XIXUSER_DPC'][36]='_pressbutton;Press;Ενημέρωση';
$__LOCALE['XIXUSER_DPC'][37]='_clickuser;Press;Θέση';
$__LOCALE['XIXUSER_DPC'][38]='_resid;Reg date;Ημερ. κατ.';
$__LOCALE['XIXUSER_DPC'][39]='_resdate;Act date;Ημερ. εκτ.';
$__LOCALE['XIXUSER_DPC'][40]='_resuser;User;Χρήστης';
$__LOCALE['XIXUSER_DPC'][41]='_findgeo;Find location;Πώς θα παω';
$__LOCALE['XIXUSER_DPC'][42]='_remindersbysocial;Post reminders to social media;Ενημέρωση στα κοινωνικά δίκτυα';
$__LOCALE['XIXUSER_DPC'][43]='_date;Date;Ημερ.';
$__LOCALE['XIXUSER_DPC'][44]='_item;Item;Προϊόν';
$__LOCALE['XIXUSER_DPC'][45]='_customer;Customer;Πελάτης';
$__LOCALE['XIXUSER_DPC'][46]='_exchanges;Sales;Παρέδωσα';
$__LOCALE['XIXUSER_DPC'][47]='_purchases;Purchases;Παρέλαβα';
$__LOCALE['XIXUSER_DPC'][48]='_seller;Seller;Προμηθευτής';
$__LOCALE['XIXUSER_DPC'][49]='_transports;Deliveries;Μεταφορές';
$__LOCALE['XIXUSER_DPC'][50]='_trans;Delivery;Διανομέας';
$__LOCALE['XIXUSER_DPC'][51]='_myprojects;My Projects;Οι δράσεις μου';
$__LOCALE['XIXUSER_DPC'][52]='_involve;Involved;Συμμετοχή';
$__LOCALE['XIXUSER_DPC'][53]='_opendates;Open dates;Διαθεσιμότητα';
$__LOCALE['XIXUSER_DPC'][54]='_xixapps;Applications;Εφαρμογές';
$__LOCALE['XIXUSER_DPC'][55]='_xixusers;XIX Users;ΧΙΧ Χρήστες';
$__LOCALE['XIXUSER_DPC'][56]='_social;Social;Κοιν.';
$__LOCALE['XIXUSER_DPC'][57]='_remind;Reminder;Υπενθ.';
$__LOCALE['XIXUSER_DPC'][58]='_map;Map;Χάρτης';
$__LOCALE['XIXUSER_DPC'][59]='_xixconf;Details;Στοιχεία';

class xixuser {

    var $prpath, $urlpath, $infolder, $url;
    var $user, $global_css_animations, $global_price, $global_currency;
	var $global_reservation_reminders;
	var $isxix;
	
	static $staticpath;

	function __construct() {
		
		$this->prpath = paramload('SHELL','prpath'); //cp path of root app
		$this->urlpath = paramload('SHELL','urlpath'); //root path of root app
		$this->infolder = paramload('ID','hostinpath'); //must be null	
		$this->url = paramload('SHELL','urlbase'); //root domain name 		
		
		$this->isxix = false;
		$this->user = decode($UserName);
		$this->global_css_animations = '1';
		
		$pr = remote_paramload('XIXUSER','price',$this->path);
		$this->global_price = $pr ? $pr : 1;
		
		$cc = remote_paramload('XIXUSER','currency',$this->path);
		$this->global_currency = $cc ? $cc : '&euro;';

		$this->global_reservation_reminders	= '1';
		
		//timezone	   
        date_default_timezone_set('Europe/Athens');
		
		self::$staticpath = paramload('SHELL','urlpath');
		
		$this->javascript();
	}
	
    function event($event) {

	  switch ($event) {
	  
	    case 'xixcp'   : die($this->xixcp()); break;
	  
	    case 'getusers': if (GetReq('ajax')) die($this->list_all_users_browser(true)); break;//$this->list_all_users(true);
	    case 'getusage': if (GetReq('ajax')) die($this->get_xixusage(null,null,null,true)); break;
	    case 'getprojects': if (GetReq('ajax')) die($this->get_xixprojects(null,null,null,true)); break;
        case 'getexchanges': if (GetReq('ajax')) die($this->get_xixexchange(null,null,true)); break;
        case 'getpurchases': if (GetReq('ajax')) die($this->get_xixpurchases(null,null,true)); break;		
	    case 'gettransports': if (GetReq('ajax')) die($this->get_xixtransports(null,null,true)); break;
	    case 'is_social'   : die($this->is_social()); break;		  
	    case 'show_xixuser' : die($this->show_xixuser());break;			
	    case 'xixset' : 	
		case 'get_usage'   :  die($this->get_usage()); break;
		case 'get_user_reminders': die($this->get_user_reminders()); break;
		case 'toggle_user_reminder': die($this->toggle_user_reminder()); break;
		case 'get_user_socialize':  die($this->get_user_socialize());break;	
		case 'toggle_user_socialize': die($this->toggle_user_socialize());break;				
		case 'change_user_details' : 
		     $user_name = GetParam('user_name');
			 $user_longitude = GetParam('user_longitude');
			 $user_latitude = GetParam('user_latitude');
		     die($this->change_user_details($user_name, $user_longitude, $user_latitude));
			 break;
			 
		case 'show_user_details' : 
		     $user_id = GetParam('user_id');
			 $user_email = GetParam('user_email');
		     $user_name = GetParam('user_name');
			 $user_longitude = GetParam('user_longitude');
			 $user_latitude = GetParam('user_latitude');
			 $user_details = GetParam('user_details');
		     die($this->show_user_details($user_id, $user_email, $user_name, $user_longitude, $user_latitude, $user_details));
			 break;			 
			 
		case 'xixuserslist': /*if (defined('RESERVATIONS_DPC'))
		                        GetGlobal('controller')->calldpc_method('reservations.get_phocal_map_javascript');
		                     else 
								$this->get_map_javascript(); 
							 */ //js included 	
		                     break;	 
        case 'md5user'     :							 
		case 'xixuser'     :		
	    default            : $this->isxix = $this->register(); 
      }
    }

    function action($action) {

	  switch ($action) {
	  
	    case 'xixcp'   : break;
	  
	    case 'getusers': if (!GetReq('template')) {
							$out = $this->setNavigator(localize('_users',getlocal()));
							$out .= $this->list_all_users_browser(); 
						 }
                         else 						 
						    $out .= $this->list_all_users_browser(true); 
		                 break;
	    case 'getusage': if (!GetReq('template')) {
							$title = (GetReq('inprojects')) ? localize('_involve',getlocal()) : localize('_opendates',getlocal());
							$out = $this->setNavigator($title);
							$out .= $this->get_xixusage(); 
						 }
                         else 
							$out .= $this->get_xixusage(null,null,null,true);//use template 

		                 break;
	    case 'getprojects': if (!GetReq('template')) {
								$title = (GetReq('not')) ? localize('_projects',getlocal()) : localize('_myprojects',getlocal());	
								$out = $this->setNavigator($title);
								$out .= $this->get_xixprojects(); 
							}
							else	
								$out .= $this->get_xixprojects(null,null,null,true); 
		                    break;
        case 'getexchanges': if (!GetReq('template')) {
								$out = $this->setNavigator(localize('_exchanges',getlocal()));
								$out .= $this->get_xixexchange(); 
							 }
                             else							 
								$out = $this->get_xixexchange(null,null,true);
		                     break;
        case 'getpurchases': if (!GetReq('template')) {
								$out = $this->setNavigator(localize('_purchases',getlocal()));
								$out .= $this->get_xixpurchases(); 
							 }	
							 else
								$out = $this->get_xixpurchases(null,null,true); 
		                     break;		
	    case 'gettransports': if (!GetReq('template')) {
								$out = $this->setNavigator(localize('_transports',getlocal()));
								$out .= $this->get_xixtransports(); 
							  }
                              else   							  
								$out .= $this->get_xixtransports(null,null,true); 
		                      break;	  
	    case 'is_social': break;
	    case 'show_xixuser' : break;
	    case 'xixset' : break;	
		case 'get_usage':break;
		case 'get_user_reminders': break;
		case 'toggle_user_reminder':break;
		case 'get_user_socialize': break;
		case 'toggle_user_socialize':break;
		case 'change_user_details' : break;
		case 'show_user_details' : break;		
		case 'xixuserslist': $out = $this->list_all_users_browser(); break;
		case 'md5user'     : $out = md5(GetReq('user')?GetReq('user'):decode(GetGlobal('UserName'))); break;
		case 'xixuser'     : 
	    default            : $out = $this->render();
	  }
	  
	  return ($out);
    }
	
	//override global func
	protected function setNavigator($title=null) {
	
		if ($title) {
			$ret = '<h2>'.$title.'</h2>';
			//$ret = setNavigator($title);
			return ($ret);
		}
		return false;
	}
	
	//login or register
	protected function login_or_register() {
	    
	    //get template file
		$t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.','loginorregister.htm') ; 
		//echo $t;
		if (is_readable($t)) {
		 $mytemplate = file_get_contents($t);
		 $tokensout = 1;
		}
		
        if (defined('SHLOGIN_DPC')) {
		    //netpanel>newapp = xixpanel>xix
 		    $a = GetGlobal('controller')->calldpc_method("shlogin.quickform use +addapp+xixpanel>xix+status+1");
		}						  
		if (defined('SHUSERS_DPC'))
 		    $b = GetGlobal('controller')->calldpc_method("shusers.regform");
										 			
		$res = $a . $b; //any return data
		if ($res) {
		    $tokens[] = $a;
			$tokens[] = $b;
									
		    $ret = $this->combine_tokens($mytemplate,$tokens,true);								
	    } 
        
		return ($ret);
	}	
	
	protected function javascript() {
		$UserName = GetGlobal('UserName');
        if (!$UserName) return false;		
	
        if (iniload('JAVASCRIPT')) {
	   
	        $code = $this->javascript_code();	   	
		    $js = new jscript;
		
            //v3 maps
			$geolanguage = getlocal() ? 'el' : 'en';
			$v3url = 'http://maps.google.com/maps/api/js?sensor=false&language='.$geolanguage;
            //$v3url = 'http://maps.google.com/maps/api/js?v=3.exp&sensor=false&key=AIzaSyDgNfkKVLswLHyY4tpCT7oJQjIBDVLpoYs&language='.$geolanguage;  			
		    $js->load_js($v3url,null,null,null,true);		   		   		   
			
            $js->load_js($code,null,1);//,null,null,true); //no obf		   			   
		    unset ($js);
	    }	
	}	
	
	protected function javascript_code()  {

	    $ajaxurl = seturl("ajax=1&t=");
		
		$geolanguage = getlocal() ? 'el' : 'en';			
	
		$Loading = localize('_loading',getlocal());
		$One_click_is_enough = localize('_ocie',getlocal());
		$savingandrefresh = localize('_savingandrefresh' ,getlocal());
		$saving = localize('_saving' ,getlocal());		
		
		$userdata = $this->get_xixuser('user_name,longitude,latitude');
			
		$sesdata.= 'ulongitude = '.$userdata['longitude'].';';
		$sesdata.= 'ulatitude = '.$userdata['latitude'].';';		
		
		$isdamin = $this->is_admin() ? '1' : '0';
		
		$global_css_animations = GetGlobal('controller')->calldpc_var('fronthtmlpage.global_css_animations');		
		   
		$sesdata.= 'session_logged_in = 1;';
		$sesdata.= 'session_user_id = \'' . $UserName . '\';';
		$sesdata.= 'session_user_name = \'' . decode($UserName) . '\';';
		$sesdata.= 'session_user_is_admin = \'' . $isadmin . '\';';
		$sesdata.= 'session_xixuser = \'' . $userdata['user_name'] . '\';';
			
		$sesdata .= "global_cookie_prefix = 'xixuser' ;";		
		$sesdata .= "global_css_animations = {$global_css_animations} ;";		
		
		$jscript = <<<EOF

$sesdata	

function show_apps(pdiv, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';	
	var utmp = (utmp) ? '&template=1' : '';
	
    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  	
 
	$.get('xix.php?ajax=1&t=xixshowapps'+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_users(pdiv, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';	
	var utmp = (utmp) ? '&template=1' : '';
	
    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  
 
	$.get('{$ajaxurl}getusers'+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_usage(pdiv, inprojects, fromtoday, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	var inprojects = inprojects ? '&inprojects=1' : '';
	var fromtoday = fromtoday ? '&fromtoday=1' : '';
	var utmp = (utmp) ? '&template=1' : '';

    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  	
 
	$.get('{$ajaxurl}getusage'+inprojects+fromtoday+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_user(pdiv)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	
    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  	
 
	$.get('{$ajaxurl}show_xixuser', function(data) { 
		$(pdiv).html(data); 
	});
};

function show_projects(pdiv, user, unot, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	var user = user ? '&user='+user : '';
	var unot = unot ? '&not=1' : '';
	var utmp = (utmp) ? '&template=1' : '';
 
    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  

	$.get('{$ajaxurl}getprojects'+user+unot+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_exchanges(pdiv, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	var utmp = (utmp) ? '&template=1' : '';
 
    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  
	
	$.get('{$ajaxurl}getexchanges'+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_purchases(pdiv, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	var utmp = (utmp) ? '&template=1' : '';
	
	//$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  
 
	$.get('{$ajaxurl}getpurchases'+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_transports(pdiv, utmp)
{
    var pdiv = (pdiv) ? '#'+pdiv : '#content_div';
	var utmp = (utmp) ? '&template=1' : '';

    //$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');  

	$.get('{$ajaxurl}gettransports'+utmp, function(data) { 
		$(pdiv).html(data); 
	});
};

function show_xixuser(iproject)
{
    var iproject = parseInt(iproject);

	page_load();
	div_hide('#content_div');
	$.get('{$ajaxurl}show_xixuser&iproject='+iproject, function(data) { 
		$('#content_div').html(data); 
		div_fadein('#content_div'); 
		page_loaded(); 
	});
};

function create_user()
{
	var user_name = $('#user_name_input').val();
	var user_email = $('#user_email_input').val();
	var user_password = $('#user_password_input').val();
	var user_password_confirm = $('#user_password_confirm_input').val();

	if($('#user_secret_code_input').length)
	{
		var user_secret_code =  $('#user_secret_code_input').val();
	}
	else
	{
		var user_secret_code = '';
	}

	if(user_password != user_password_confirm)
	{
		$('#new_user_message_p').html('<span class="error_span">Passwords do not match</span>').slideDown('fast');
		$('#user_password_input').val('');
		$('#user_password_confirm_input').val('');
		input_focus('#user_password_input');
	}
	else
	{
		$('#new_user_message_p').html('<img src="images/loading.gif" alt="Loading"> Creating user...').slideDown('fast');

		$.post('login.php?create_user', { user_name: user_name, user_email: user_email, user_password: user_password, user_secret_code: user_secret_code }, function(data)
		{
			if(data == 1)
			{
				input_focus();

				setTimeout(function()
				{
					$('#new_user_message_p').html('User created successfully! Logging in... <img src="images/loading.gif" alt="Loading">');
					setTimeout(function() { window.location.replace('#login'); }, 2000);
				}, 1000);
			}
			else
			{
				input_focus();
				$('#new_user_message_p').html(data);
			}
		});
	}
};

function change_user_permissions()
{
	if(typeof $(".user_radio:checked").val() !='undefined')
	{
		var user_id = $(".user_radio:checked").val();

		$('#user_administration_message_p').html('<img src="images/loading.gif" alt="Loading"> Changing permissions...').slideDown('fast');

		$.post('{$ajaxurl}change_user_permissions', { user_id: user_id }, function(data)
		{
			if(data == 1)
			{
				setTimeout(function()
				{
					list_users();
					$('#user_administration_message_p').html('Permissions changed successfully. The user must re-login to get the new permissions');
				}, 1000);
			}
			else
			{
				$('#user_administration_message_p').html(data);
			}
		});
	}
	else
	{
		$('#user_administration_message_p').html('<span class="error_span">You must pick a user</span>').slideDown('fast');
	}
};

function get_usage()
{
	$.get('{$ajaxurl}get_usage', function(data) { $('#usage_div').html(data); });
};

function get_user_reminders()
{
	$.get('{$ajaxurl}get_user_reminders', function(data) { $('#reservation_reminders_span').html(data); });
};

function toggle_user_reminder()
{
	$('#settings_message_p').html('<img src="images/loading.gif" alt="Loading"> {$saving}').slideDown('fast');

	$.post('{$ajaxurl}toggle_user_reminder', function(data)
	{
		if(data == 1)
		{
			setTimeout(function()
			{
				if($('#users_div').length)
				{
					list_users();		
				}

				get_user_reminders();
				$('#settings_message_p').slideUp('fast');
			}, 1000);
		}
		else
		{
			$('#settings_message_p').html(data);
		}
	});
};	

function get_user_socialize()
{
	$.get('{$ajaxurl}get_user_socialize', function(data) { $('#reservation_socialize_span').html(data); });
};

function toggle_user_socialize()
{
	$('#settings_message_p').html('<img src="images/loading.gif" alt="Loading"> {$saving}').slideDown('fast');

	$.post('{$ajaxurl}toggle_user_socialize', function(data)
	{
		if(data == 1)
		{
			setTimeout(function()
			{
				get_user_socialize();
				$('#settings_message_p').slideUp('fast');
			}, 1000);
		}
		else
		{
			$('#settings_message_p').html(data);
		}
	});
};

function change_user_details()
{
	var user_name = $('#user_name_input').val();
	var user_latitude = $('#user_latitude_input').val();
	var user_longitude = $('#user_longitude_input').val();
	var user_password_confirm = $('#user_password_confirm_input').val();

	$('#user_details_message_p').html('<img src="images/loading.gif" alt="Loading"> {$savingandrefresh}').slideDown('fast');

	$.post('{$ajaxurl}change_user_details', { user_name: user_name, user_longitude: user_longitude, user_latitude: user_latitude }, function(data)
	{
			if(data == 1)
			{
				input_focus();
				setTimeout(function() { window.location.replace('.'); }, 1000);
			}
			else
			{
				input_focus();
				$('#user_details_message_p').html(data);
			}
	});
};

function show_user_details(id, email, name, lati, long, details, pdiv, divmap)
{
    var user_id = id;
	var user_email = email;
	var user_name = name;
	var user_latitude = lati;
	var user_longitude = long;
	var user_details = details ? details : ''; 
	var pdiv = pdiv ? '#'+pdiv : '#user_show_message_p';
	var divmap = divmap ? divmap : '';

	$(pdiv).html('<img src="images/loading.gif" alt="Loading"> {$Loading}').slideDown('fast');

	$.post('{$ajaxurl}show_user_details', { user_id: user_id, user_email: user_email, user_name: user_name, user_longitude: user_longitude, user_latitude: user_latitude, user_details: user_details }, function(data)
	{
		$(pdiv).html(data);
		showUserPosition(user_latitude,user_longitude, divmap);
	});
};

function getLocation()  {

	navigator.geolocation.getCurrentPosition(function(position) {
		document.getElementById('user_latitude_input').value = position.coords.latitude;
        document.getElementById('user_longitude_input').value = position.coords.longitude;  
	});
    showUserPosition();	
};

function showUserPosition(lat, lon, divmap) {
  lat= lat ? lat : document.getElementById('user_latitude_input').value;
  lon= lon ? lon : document.getElementById('user_longitude_input').value;
  //alert(lat+' '+lon);
  latlon=new google.maps.LatLng(lat, lon);
  
  var divmap = divmap ? divmap : 'mapholder';
  mapholder=document.getElementById(divmap);
  mapholder.style.height='250px';
  mapholder.style.width='100%';

  var myOptions={
	center:latlon,zoom:14,
	mapTypeId:google.maps.MapTypeId.ROADMAP,
	mapTypeControl:false,
	navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
  };
  var map=new google.maps.Map(document.getElementById(divmap),myOptions);
  var marker=new google.maps.Marker({position:latlon,map:map,title:"You are here!"});
  
}; 
  
EOF;

    //No repeat js code:if no js from res then retype js funcs
	if (!defined('RESERVATIONS_DPC')) {
	
		$jscript .= <<<RESDEFJS
function page_load(page)
{
	// All
	setTimeout(function()
	{
		if($('#content_div').css('opacity') == 0)
		{
			notify('{$Loading}', 300);
		}
	}, 500);

	// Individual
	if(page == 'reservation')
	{
		setTimeout(function()
		{
			if($('#reservation_table_div').is(':hidden'))
			{
				notify('{$Loading}', 300);
			}
		}, 500);
	}		
	else if(page == 'week')
	{
		setTimeout(function()
		{
			if($('#reservation_table_div').css('opacity') == 0)
			{
				notify('{$Loading}', 300);
			}
		}, 500);
	}
};

function page_loaded(page)
{
	// All

	// Individual
	if(page == 'about')
	{
		$('#about_latest_version_p').html('<img src="images/loading.gif" alt="Loading"> Getting latest version...');

		setTimeout(function()
		{
			$.get('main.php?latest_version', function(data)
			{
				if($('#about_latest_version_p').length)
				{
					$('#about_latest_version_p').html(data);
				}
			});
		}, 1000);
	}
};

function div_fadein(id)
{
	setTimeout(function()
	{
		if(global_css_animations == 1)
		{
			$(id).addClass('div_fadein');
		}
		else
		{
			$(id).animate({ opacity: 1 }, 250);
		}
	}, 1);
};

function div_hide(id)
{
	$(id).removeClass('div_fadein');
	$(id).css('opacity', '0');
};

function notify(text, time)
{
	if(typeof text != 'undefined')
	{
		if(typeof notify_timeout != 'undefined')
		{
			clearTimeout(notify_timeout);
		}

		$('#notification_inner_cell_div').css('opacity', '1');

		if($('#notification_div').is(':hidden'))
		{
			$('#notification_inner_cell_div').html(text);
			$('#notification_div').slideDown('fast');
		}
		else
		{
			$('#notification_inner_cell_div').animate({ opacity: 0 }, 250, function() { $('#notification_inner_cell_div').html(text); $('#notification_inner_cell_div').animate({ opacity: 1 }, 250); });
		}

		notify_timeout = setTimeout(function() { $('#notification_inner_cell_div').animate({ opacity: 0 }, 250, function() { $('#notification_div').slideUp('fast'); }); }, 1000 * time);
	}
	else
	{
		if($('#notification_div').is(':visible'))
		{
			$('#notification_inner_cell_div').animate({ opacity: 0 }, 250, function() { $('#notification_div').slideUp('fast'); });
		}
	}
};

/*function input_focus(id)
{
	if(offclick_event == 'touchend')
	{
		$('input').blur();
	}
	if(typeof id != 'undefined')
	{
		$(id).focus();
	}
};*/
/*
$(document).ready( function()
{
	// Detect touch support
	if('ontouchstart' in document.documentElement)
	{
		onclick_event = 'touchstart';
		offclick_event = 'touchend';
	}
	else
	{
		onclick_event = 'mousedown';
		offclick_event = 'mouseup';
	}

	// Visual feedback on click
	$(document).on(onclick_event, 'input:submit, input:button, .reservation_time_div', function() { $(this).css('opacity', '0.5'); });
	$(document).on(offclick_event+ ' mouseout', 'input:submit, input:button, .reservation_time_div', function() { $(this).css('opacity', '1.0'); });

	// Buttons
	$(document).on('click', '#reservation_hide_button', function() { hidereservations(); });	
	$(document).on('click', '#reservation_today_button', function() { showweek(global_week_number, 'today'); });
	$(document).on('click', '#reset_user_password_button', function() { reset_user_password(); });
	$(document).on('click', '#change_user_permissions_button', function() { change_user_permissions(); });
	$(document).on('click', '#delete_user_reservations_button', function() { delete_user_data('reservations'); });
	$(document).on('click', '#delete_user_button', function() { delete_user_data('user'); });
	$(document).on('click', '#delete_all_reservations_button', function() { delete_all('reservations'); });
	$(document).on('click', '#delete_all_users_button', function() { delete_all('users'); });
	$(document).on('click', '#delete_everything_button', function() { delete_all('everything'); });
	$(document).on('click', '#add_one_reservation_button', function() { add_one_reservation(); });

	// Checkboxes
	//$(document).on('click', '#user_reminders_checkbox', function() { toggle_user_reminder(); });
	//$(document).on('click', '#user_socialize_checkbox', function() { toggle_user_socialize(); });	

	// Forms
	//$(document).on('submit', '#login_form', function() { login(); return false; });
	//$(document).on('submit', '#new_user_form', function() { create_user(); return false; });
	//$(document).on('submit', '#system_configuration_form', function() { save_system_configuration(); return false; });
	//$(document).on('submit', '#user_details_form', function() { change_user_details(); return false; });

	// Links
	//$(document).on('click mouseover', '#user_secret_code_a', function() { div_fadein('#user_secret_code_div'); return false; });
	// Divisions
	//$(document).on('mouseout', '.reservation_time_cell_div', function() { read_reservation_details(); });
	// Mouse pointer
	//$(document).on('mouseover', 'input:button, input:submit, .reservation_time_div', function() { this.style.cursor = 'pointer'; });
});*/

function hash()
{
	var hash = window.location.hash.slice(1);

	if(hash == '')
	{
		if(typeof session_logged_in != 'undefined')  
		{
			//showreservations();//hidden when page loads
		}
		else
		{
			//showlogin();
			//hidereservations();
		}
	}
	else
	{
		if(hash == 'about')
		{
			showabout();
		}
		else if(hash == 'new_user')
		{
			shownew_user();
		}
		else if(hash == 'forgot_password')
		{
			showforgot_password();
		}
		else if(hash == 'help')
		{
			showhelp();
		}
		else if(hash == 'cp')
		{
			showcp();
		}
		else if(hash == 'logout')
		{
			logout();
		}
		else
		{
			window.location.replace('.');
		}
	}
};

$(window).load(function()
{
	// Make sure cookies are enabled
/*
	$.cookie(global_cookie_prefix+'_cookies_test', '1');
	var test_cookies_cookie = $.cookie(global_cookie_prefix+'_cookies_test');

	if(test_cookies_cookie == null)
	{
		window.location.replace('error.php?error_code=3');
	}
	else
	{
		$.cookie(global_cookie_prefix+'_cookies_test', null);
*/   
		hash();

		$(window).bind('hashchange', function ()
		{
			hash();
		});
/*	} */
});

$(document).ready( function()
{
	$.ajaxSetup({ cache: false });
});		
RESDEFJS;
		
    }

		$jscript .= <<<MYRJS
function input_focus(id)
{
	if(offclick_event == 'touchend')
	{
		$('input').blur();
	}
	if(typeof id != 'undefined')
	{
		$(id).focus();
	}
};
		
$(document).ready( function()
{
	// Detect touch support
	if('ontouchstart' in document.documentElement)
	{
		onclick_event = 'touchstart';
		offclick_event = 'touchend';
	}
	else
	{
		onclick_event = 'mousedown';
		offclick_event = 'mouseup';
	}

	// Checkboxes
	$(document).on('click', '#user_reminders_checkbox', function() { toggle_user_reminder(); });
	$(document).on('click', '#user_socialize_checkbox', function() { toggle_user_socialize(); });	

	// Buttons
	$(document).on('submit', '#user_details_form', function() { change_user_details(); return false; });

});		
MYRJS;
		
		return ($jscript);		
	}
	
	public function xixcp($div=null, $template=false, $out_template=false) {
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;

	    //call from javascript ajax scroll
	    if (!GetReq('ajax')) {
			$out = GetGlobal('controller')->calldpc_method('fronthtmlpage.get_scrollid use '.get_class($this).'+xixcp+'."div|template|out_template+$div|$template|$out_template"); 		
			return ($out);
		}
		//get GET func params when call from scroll
		foreach ($_GET as $gname=>$gvalue) 
			$$gname = $gvalue;		
		
		$utmp = ($template) ? '1' : '0';
        $div = $div ? $div : "xixcp_div";	

		$ret = $this->myf_button(localize('_xixconf',getlocal()),null,null,'show_user("'.$div.'")','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_myprojects',getlocal()),null,null,'show_projects("'.$div.'",session_user_name,0,'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_projects',getlocal()),null,null,'show_projects("'.$div.'",session_user_name,1,'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_involve',getlocal()),null,null,'show_usage("'.$div.'",1,1,'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_opendates',getlocal()),null,null,'show_usage("'.$div.'",0,1,'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_exchanges',getlocal()),null,null,'show_exchanges("'.$div.'",'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_purchases',getlocal()),null,null,'show_purchases("'.$div.'",'.$utmp.')','btn btn-large') . '&nbsp;';
		$ret.= $this->myf_button(localize('_transports',getlocal()),null,null,'show_transports("'.$div.'",'.$utmp.')','btn btn-large') . '&nbsp;';		
		$ret.= $this->myf_button(localize('_xixusers',getlocal()),null,null,'show_users("'.$div.'",'.$utmp.')','btn btn-large') . '&nbsp;';				
		$ret.= $this->myf_button(localize('_xixapps',getlocal()),null,null,'show_apps("'.$div.'",'.$utmp.')','btn btn-large') . '&nbsp;';		

		if ($out_template) {
			//use template
			$tokens = array(0=>$ret);
			$template = 'xixcp.htm';
			$t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.',$template) ;
			if (is_readable($t)) 
				$tdata = @file_get_contents($t);			
				
	   		if (($tdata) && (!empty($tokens))) 		
				$out = $this->combine_tokens2($tdata, $tokens, true);
			else
				$out = $ret;		
		}
		else
			$out = $ret;
	
		return ($out);
	}
	
	//not used
	public function update_geolocation() {
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;
		
		$ret = "<div id='geo_div'>Click the button to get your coordinates:</div>";
	    $ret.= "<button class='btn' onclick='getLocation()'>Geo</button>";
		$ret.= "<div id='mapholder'></div>";
		return ($ret);
	}	
	
	public function get_href($title=null,$project_id=null) {
	    
		//check if project is fullfilled
		if ((defined('MGANTTI_DPC')) && ($title)) {
			$f = GetGlobal('controller')->calldpc_method("mgantti.is_project_full use ".$project_id);
		    $icon = $f ? "<i class='icon-check'></i>&nbsp;" : "<i class='icon-refresh'></i>&nbsp;";
	 	}
		else
			$icon = null;

		//href ..href='{$_SERVER['REQUEST_URI']}#show_xixuser'..goto /?	
		if ($title)
		    return("<a class='btn btn-small' onclick='javascript: show_xixuser($project_id)'>".$icon.$title."</a>");
		else
			return("javascript: show_xixuser($project_id)");
	}	
	
	public function get_user_location($user=null, $crc32=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;
		$this_user = decode($UserName);
		
		if ($user) {
		    if ($crc32) {
			    //..is this user, or find the user
				//echo $user,'-',hash('crc32',$this_user);
			    $user =  ($user==hash('crc32',$this_user)) ? 
				          $this_user:
					      $this->find_crc32_user($user);
            }			
			//else as is...
		}
		else 
			$user = $this_user;
			
	   	$xy = $this->get_xixuser('longitude,latitude', $user);
		
		if (!empty($xy)) {
			$ret = $xy['latitude'].','.$xy['longitude'];	
			return ($ret); 
        }
		return false;
	}	
	
	protected function find_crc32_user($crc32user=null) {
	    if (!$crc32user) return false;
		
		return false;
	}

	protected function is_admin($id=null) {
		$is_super_owner = false;
		
		if (defined('GANTTI_DPC')) //super owner 
			$is_super_owner = GetGlobal('controller')->calldpc_method("gantti.is_super_owner");
		//echo '>',$is_super_owner;
		
		return 	($is_super_owner);	
		//???
	    $sid = $id ? $id : 5;
		
		$adminsecid = GetSessionParam('ADMINSecID') ? GetSessionParam('ADMINSecID') : $GLOBALS['ADMINSecID'];
		$seclevid = ($adminsecid>1) ? intval($adminsecid)-1 : 1;
		if (($adminsecid) && ($seclevid>=$sid))
			return true;	
			
		return false;	
	}	
	
	function show_xixuser($nomap=false, $notemplate=false) {
	   
	    $this->isxix = $this->register(); 
	
		return ($this->render($nomap, $notemplate));
	}
	
	public function render($nomap=false, $notemplate=false) {
		$UserName = GetGlobal('UserName');
		if (!$UserName) return false;	
	    $iproject = GetReq('iproject');
		$user = decode($UserName);
		
		$userdata = $this->get_xixuser('user_name,longitude,latitude');
		$username = $userdata['user_name'];
		$longitude = $userdata['longitude'];
		$latitude = $userdata['latitude'];
		
		$xixlabel = localize('XIXUSER_DPC' ,getlocal());
		$usagelabel = localize('_usage' ,getlocal());
		$settingslabel = localize('_settings' ,getlocal());
		$detailslabel = localize('_details' ,getlocal());
		$updatelabel = localize('_update' ,getlocal());
		$nicknamelabel = localize('_nickname' ,getlocal());
		$emaillabel = localize('_email' ,getlocal());
		$remindersbymail = localize('_remindersbymail' ,getlocal());
		$remindersbysocial = localize('_remindersbysocial' ,getlocal());
		$settingstext = localize('_settingstext', getlocal());
		$detailstext = null;//localize('_detailstext', getlocal());
		$sendnotifications = localize('_sendnotifications', getlocal());
		$mailnotification = localize('_mailnotification', getlocal());
		$sendinvitations = localize('_sendinvitations', getlocal());
		$longitude_label = localize('_longitude', getlocal());
		$latitude_label = localize('_latitude', getlocal());
		$update_geo_button = localize('_updategeo', getlocal());
		$find_geo_button = localize('_findgeo', getlocal());
				
		$user_location_button = "<button class='btn' onclick='showUserPosition()'>{$update_geo_button}</button>";
		if ((defined('MGANTTI_DPC')) && ($iproject))  
			$project_directions_button = "<button class='btn' onclick='showDirections(0,0,0,1,$iproject)'>{$find_geo_button}</button>";
				
		if (!$this->isxix) //not a record in xixusers
			return ('Unknown XIX user');
			
        //map div
		$mapholder = ($nomap) ? null : "<div id='mapholder'></div><div id='phoca_dir'></div>";
		$mapdetails = "<h3>{$detailslabel}</h3><p class='smalltext_p'>{$detailstext}{$user_location_button}&nbsp;{$project_directions_button}</p>{$mapholder}";				

		if ((defined('MGANTTI_DPC')) && ($iproject)) {
	
            //in window	
			$ret = "
<div class=\"box_div\" id=\"cp_div\">
<div class=\"box_top_div\">{$xixlabel} {$this->xixuser}</div>
<div class=\"box_body_div\">			
";	
				
		    $project_data = GetGlobal('controller')->calldpc_method("mgantti.get_project use ".$iproject."+title,start,end,owner,include,exclude");

			$projectname = $project_data['title'];
			$owner = $project_data['owner'];
			$start = strtotime($project_data['start']);
			$end = strtotime($project_data['end']);
			$now = strtotime(date('Y-m-d'));
			
			//if project, owner and intime
			if (($end>$now) && ($owner == $user)) {
		
				$pf = GetGlobal('controller')->calldpc_method("mgantti.is_project_full use ".$iproject);
				$invitation_button = ($project_data['include'] && (!$pf))  ? "<input type=\"button\" class=\"btn\" id=\"send_invitation_notifications_button\" value=\"{$sendinvitations}\">&nbsp;" : null;
				$send_mail_button = "<h3>{$mailnotification}</h3><p>{$invitation_button}<input type=\"button\" class=\"btn\" id=\"send_mail_notifications_button\" value=\"{$sendnotifications}\"></p>";
			}	
			else
				$send_mail_button = '';
	
			$from = date('d-m-Y',$start);		
			$to = date('d-m-Y',$end);	

			$usage_list = $this->get_usage($iproject, $owner); 
		    $ret .= "<h3><span id=\"iproject_span\">{$iproject} -</span> {$usagelabel} {$projectname} {$from}-{$to}</h3><div id=\"usage_div\">" .
			        $usage_list .
					"</div>{$send_mail_button}<p id=\"usage_message_p\"></p>";
			
		}	   
        else {
		    $usage_list = $this->get_usage(); 
			$ret .= "<h3>{$usagelabel}</h3><div id=\"usage_div\">".
			        $usage_list .
					"</div><p id=\"usage_message_p\"></p>";			   
		}
				
		$ret .= <<<XIXFRM
	<h3>{$settingslabel}</h3>
	<p class="smalltext_p">{$settingstext}</p>
	<p><span id="reservation_reminders_span">{$this->get_user_reminders()}</span> <label for="user_reminders_checkbox">{$remindersbymail}</label><br/>
	   <span id="reservation_socialize_span">{$this->get_user_socialize()}</span> <label for="user_socialize_checkbox">{$remindersbysocial}</label></p>
	<p id="settings_message_p"></p>	
	$mapdetails
	<div id="user_details_div">	
	<form action="." id="user_details_form" autocomplete="off">
	<label for="user_longitude_input">{$longitude_label}:</label><br>
	<input type="text" id="user_longitude_input" value="{$longitude}"><br><br>
	<label for="user_latitude_input">{$latitude_label}:</label><br>
	<input type="text" id="user_latitude_input" value="{$latitude}"><br><br>	
	<label for="user_name_input">{$nicknamelabel}:</label><br>
	<input type="text" id="user_name_input" value="{$username}"><br><br>	
	<p><input type="submit" class="btn" onClick='change_user_details()' value="{$updatelabel}"></p>
	</form>
	<p id="user_details_message_p"></p>
	</div>	
XIXFRM;
		
		
		if ($iproject) {
		
		    //in window
			$ret .= "</div></div>";		
		}
		else {
		    if ($notemplate) {
				$out = $ret;
			}
			else {
				//use template
				$tokens = array(0=>$ret);
				$template = 'xixpanel.htm';
				$t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.',$template) ;
				if (is_readable($t)) 
					$tdata = @file_get_contents($t);			
	   
				if (($tdata) && (!empty($tokens))) 		
					$out = $this->combine_tokens2($tdata, $tokens, true);
				else
					$out = $ret;		
			}	
			return ($out);		
        }
		
		return ($ret);		
	}
	
	/*function _render($nomap=false) {
		$UserName = GetGlobal('UserName');
		if (!$UserName) return false;	
	    //return ('xixuser');
		
		$user = decode($UserName);
		//$username = array_shift($this->get_xixuser('user_name'));
		$userdata = $this->get_xixuser('user_name,longitude,latitude');
		$username = $userdata['user_name'];
		$longitude = $userdata['longitude'];
		$latitude = $userdata['latitude'];
		
		$xixlabel = localize('XIXUSER_DPC' ,getlocal());
		$usagelabel = localize('_usage' ,getlocal());
		$settingslabel = localize('_settings' ,getlocal());
		$detailslabel = localize('_details' ,getlocal());
		$updatelabel = localize('_update' ,getlocal());
		$nicknamelabel = localize('_nickname' ,getlocal());
		$emaillabel = localize('_email' ,getlocal());
		$remindersbymail = localize('_remindersbymail' ,getlocal());
		$settingstext = localize('_settingstext', getlocal());
		$detailstext = localize('_detailstext', getlocal());
		$longitude_label = localize('_longitude', getlocal());
		$latitude_label = localize('_latitude', getlocal());
		$update_geo_button = localize('_updategeo', getlocal());
					
		
		if (!$this->isxix) //not a record in xixusers
			return ('Unknown XIX user');
			
        //map div
		$mapdiv = ($nomap) ? null : "<div id='mapholder'></div>";
		
	    $ret = <<<XIXFORM
	<h3>{$usagelabel}</h3>
	<div id="usage_div">{$this->get_usage()}</div>
	<p id="usage_message_p"></p>
	<hr>	
	<h3>{$settingslabel}</h3>
	<p class="smalltext_p">{$settingstext}</p>
	<p><span id="user_reminders_span">{$this->get_user_reminders()}</span> <label for="user_reminders_checkbox">{$remindersbymail}</label></p>
	<p id="settings_message_p"></p>
	<hr>	
	<h3>{$detailslabel}</h3>
	<p class="smalltext_p">{$detailstext}</p>
	<button class='btn' onclick='getLocation()'>{$update_geo_button}</button>
	</p>{$mapdiv}
	<form action="." id="user_details_form" autocomplete="off"><p>
	<div id="user_details_div"><div>
	<label for="user_longitude_input">{$longitude_label}:</label><br>
	<input type="text" id="user_longitude_input" value="{$longitude}"><br><br>
	<label for="user_latitude_input">{$latitude_label}:</label><br>
	<input type="text" id="user_latitude_input" value="{$latitude}"><br><br>	
	<label for="user_name_input">{$nicknamelabel}:</label><br>
	<input type="text" id="user_name_input" value="{$username}"><br><br>
	<p><input type="submit" class="btn" value="{$updatelabel}"></p>
	</p></form>
	<p id="user_details_message_p"></p>
XIXFORM;
		
		//use template
		$tokens = array(0=>$ret);
		$template = 'xixpanel.htm';
	    $t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.',$template) ;
	    if (is_readable($t)) 
			$tdata = @file_get_contents($t);			
	   
	    if (($tdata) && (!empty($tokens))) 		
			$out = $this->combine_tokens2($tdata, $tokens, true);
		else
            $out = $ret;		
		return ($out);
	}*/
	
	//write logged in user as xix user
	protected function register() {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = decode($UserName);

		$query = "SELECT user_email from xixusers WHERE user_email='{$user}'";
		$result = $db->Execute($query,2);
		
		if ($result->fields['user_email'])	{
			return true; //alredy in
		}
        else {
			$query = "INSERT INTO xixusers SET user_email='{$user}',user_name='{$user}'";
			$result = $db->Execute($query,1);	
            return true; 			
        }

        return false;		
	}
	
	//get xixuser data or auto insert logged in user if no record
	protected function get_xixuser($retfields=null,$user_id=null,$crc32=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = decode($UserName);

		$qf = $retfields ? ','.$retfields : null; 
		$query = "SELECT user_email{$qf} from xixusers WHERE";
		if ($user_id)
			$query .= " user_email='{$user_id}'";
		else
			$query .= " user_email='{$user}'";
		//echo $query;	
		$result = $db->Execute($query,2);
		
		if ($result->fields['user_email'])	{
		    if ($retfields) {
			    $retarray = array();
			    $fx = explode(',',$retfields);
			    foreach ($fx as $field)
					$retarray[$field] = $result->fields[$field];	
				return (array) $retarray;	
			}
			else
				return true; //alredy in
		}
        else {
		    if (!$user_id) {//its only for reg himselfs users
				$query = "INSERT INTO xixusers SET user_email='{$user}',user_name='{$user}'";
				$result = $db->Execute($query,1);	
				//return true; 	
            }			
        }
        //echo $query,'<br/>'; 
        return false;		
	}	
	
	//user exchanges / sales
	public function get_xixexchange($retcounter=null, $owner=null, $template=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = decode($UserName);
		$use_template = $template ? false : true;		
		$exchanges = null;
		$today = date('Y-m-d');//date from db is Y-m-d
		
		//$date_label = localize('_date',getlocal());
		//$item_label = localize('_item',getlocal());
		//$cust_label = localize('_customer',getlocal());		

		if (!$retcounter) {
		
			$query = "SELECT id,date,name,code,cid,qty,value,verify,receiver from trdata WHERE";
			$query .= " code<>'transport'"; 
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner='{$user}'";
			$query .= ' order by date DESC LIMIT 99';	
			//echo $query;	
			$result = $db->Execute($query,2);

			$count = 0; 
			if (!empty($result->fields)) {
			  
			  foreach ($result as $n=>$rec) {
				$count+=1;	
                $c = sprintf('%02d',$count);				
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['date'])));
				
				$xcus = $rec['receiver'] ? @array_shift($this->get_xixuser('user_name',$rec['receiver'])) : null;
				$customer = $xcus ? $xcus : null;
				$ptitle = seturl('t=kshow&cat=&id='.$rec['code'],$rec['name']);//no category//,null,null,null,1);
			    $icon = "<i class='icon-group'/>";

		        $exchanges[] = $c .' '. $insdate . '||' . 
				         $ptitle . ' ('.$rec['qty'].')' . $rec['value'] . '||' . 
					     $icon . $customer;						 
			  }

              $title = localize('_exchanges',getlocal());			  
		      $ppager = GetReq('pl')?GetReq('pl'):10;
			  $browser = new browse($exchanges,$title,$this->getpage($exchanges,null),null,null,'getexchanges',$use_template, true);
			  $out .= $browser->render("getexchanges",$ppager,$this,1,1,0,0);
			  unset ($browser);				  
            }	
				
			return ($out);			
		}
		else {//return counter
		    
			$query = "SELECT count('id') as exc from trdata WHERE";
			$query .= " code<>'transport'"; 			
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner='{$user}'";
			//echo $query;	
			$result = $db->Execute($query,2);	
            $exchanges = $result->fields['exc'];			
		}

        return ($exchanges); 		
	}	
	
	//user purchases
	public function get_xixpurchases($retcounter=null, $owner=null, $template=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;
		$use_template = $template ? false : true;		
		$user = decode($UserName);
		$purchases = null;
		$today = date('Y-m-d');//date from db is Y-m-d
		
		if (!$retcounter) {
		
			$query = "SELECT id,date,name,code,cid,qty,value,verify,owner from trdata WHERE";
			$query .= " cid='{$user}' AND code<>'transport'"; 
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner<>'{$user}'";
			$query .= ' order by date DESC LIMIT 99';	
			//echo $query;	
			$result = $db->Execute($query,2);

			$count = 0; 
			if (!empty($result->fields)) {
			  
			  foreach ($result as $n=>$rec) {
				$count+=1;	
                $c = sprintf('%02d',$count);				
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['date'])));
				
				$xseller = $rec['owner'] ? @array_shift($this->get_xixuser('user_name',$rec['owner'])) : null;
				$seller = $xseller ? $xseller : $rec['owner'];
				$ptitle = seturl('t=kshow&cat=&id='.$rec['code'],$rec['name']);//no category//,null,null,null,1);
			    $icon = "<i class='icon-group'/>";

		        $purchases[] =  $c .' '. $insdate . '||' . 
								$ptitle . ' ('.$rec['qty'].')' . $rec['value'] . '||' . 
								$icon . $seller;							 
			  }

              $title = localize('_purchases',getlocal());			  
		      $ppager = GetReq('pl')?GetReq('pl'):10;
			  $browser = new browse($purchases,$title,$this->getpage($purchases,null),null,null,'getpurchases',$use_template, true);
			  $out .= $browser->render("getpurchases",$ppager,$this,1,1,0,0);
			  unset ($browser);				  
            }	
				
			return ($out);			
		}
		else {//return counter
		    
			$query = "SELECT count('id') as pur from trdata WHERE";
			$query .= " cid='{$user}' AND code<>'transport'"; 
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner<>'{$user}'";

			$result = $db->Execute($query,2);	
            $purchases = $result->fields['pur'];			
		}

        return ($purchases); 		
	}	

	//user transports
	public function get_xixtransports($retcounter=null, $owner=null, $template=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$use_template = $template ? false : true;
		$user = decode($UserName);
		$transports = null;
		$today = date('Y-m-d');//date from db is Y-m-d
		
		if (!$retcounter) {
		
			$query = "SELECT id,date,name,code,cid,tid,qty,value,verify,owner from trdata WHERE";
			$query .= " cid='{$user}' AND code='transport'"; 
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner=''";
			$query .= ' order by date DESC LIMIT 99';	
			//echo $query;	
			$result = $db->Execute($query,2);

			$count = 0; 
			if (!empty($result->fields)) {
			  
			  foreach ($result as $n=>$rec) {
				$count+=1;	
                $c = sprintf('%02d',$count);				
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['date'])));
				
				$xdeliv = $rec['owner'] ? @array_shift($this->get_xixuser('user_name',$rec['owner'])) : null;
				$deliveras = $xdeliv ? $xdeliv : null;
				//$ptitle = "<a href='transport/{$rec['tid']}/'>{$rec['name']}-{$rec['tid']}</a>";
				$ptitle = seturl('t=transport&id='.$rec['tid'],$rec['name'].'-'.$rec['tid'],null,null,null,1);
			    $icon = "<i class='icon-group'/>";

		        $transports[] = $c .' '. $insdate . '||'.
								$ptitle . ' ('.$rec['qty'].')' . $rec['value'] . '||'.
								$icon . $deliveras;							 
			  }	
			  
              $title = localize('_transports',getlocal());			  
		      $ppager = GetReq('pl')?GetReq('pl'):10;
			  $browser = new browse($transports,$title,$this->getpage($transports,null),null,null,'gettransports',$use_template, true);
			  $out .= $browser->render("gettransports",$ppager,$this,1,1,0,0);
			  unset ($browser);				  
            }	
				
			return ($out);			
		}
		else {//return counter
		    
			$query = "SELECT count('id') as trans from trdata WHERE";
			$query .= " cid='{$user}' AND code='transport'"; 
			$query.= ($owner) ? " AND owner='{$owner}'" : " AND owner=''";

			$result = $db->Execute($query,2);	
            $transports = $result->fields['trans'];			
		}

        return ($transports); 		
	}	
	
	//select open projects
	public function get_xixprojects($retcounter=null, $owner=null, $not=false, $template=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = $owner ? $owner : decode($UserName);
		$not = $not ? $not : GetReq('not');
		$use_template = $template ? false : true;
		$projects = null;
		$today = date('Y-m-d');//date from db is Y-m-d
		
		if (!$retcounter) {
		
			$query = "SELECT id,date,title,code,cat,start,end,owner from projects WHERE";
			$query .= " active=1"; 
			
			$query.= ($not) ? " AND owner<>'{$user}' AND (private=0 OR (private=1 AND include like '%{$user}%') OR owner='{$user}')" :
			                  " AND owner='{$user}'";
			$query .= ' order by start DESC';	
			//echo $query;	
			$result = $db->Execute($query,2);

			$count = 0; 
			if (!empty($result->fields)) {
			  
			  foreach ($result as $n=>$rec) {
				$count+=1;	
                $c = sprintf('%02d',$count);				
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['date'])));

				if ((strtotime($today)>=strtotime($rec['start'])) && 
				    (strtotime($today)<=strtotime($rec['end']))) {
					$startdate = $this->highlight_today(date('d-m-Y',strtotime($rec['start'])), true);
					$enddate = $this->highlight_today(date('d-m-Y',strtotime($rec['end'])), true);
				}
				else {
					$startdate = date('d-m-Y',strtotime($rec['start']));
					$enddate = date('d-m-Y',strtotime($rec['end']));
				}
				
				$owner = $rec['owner'] ? @array_shift($this->get_xixuser('user_name',$rec['owner'])) : null;
				$sowner = $owner ? '<br>('.$owner.')' : null;
				$ptitle = seturl('t=kshow&cat='.$rec['cat'].'&id='.$rec['code'],$rec['title'],null,null,null,1);
			    $icon = "<i class='icon-group'/>";

		        $projects[] = $c .' '. $insdate . '||' . 
				         $startdate .'-'. $enddate . '||' . 
					     $icon . $ptitle . $sowner;						 
			  }
			  
              $title = ($not) ? localize('_projects',getlocal()) : localize('_myprojects',getlocal());			  
		      $ppager = GetReq('pl')?GetReq('pl'):10;
			  $browser = new browse($projects,$title,$this->getpage($projects,null),null,null,'getprojects',$use_template, true);
			  $out .= $browser->render("getprojects",$ppager,$this,1,1,0,0);
			  unset ($browser);			
		
			  $out .= '</table>';				  
            }	
				
			return ($out);			
		}
		else {//return counter
		    
			$query = "SELECT count('id') as xix from projects WHERE";
			$query.= ($owner) ? " owner='{$user}'" : null;
			$query .= " AND active=1 AND private=0";	
			//echo $query;	
			$result = $db->Execute($query,2);	
            $projects = $result->fields['xix'];			
		}

        return ($projects); 		
	}

	//select users usage from all projects
	//if inprojects then uasage in projects else out of any project
	public function get_xixusage($retcounter=null, $inprojects=false, $fromtoday=false, $template=false) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = decode($UserName);
		$inprojects = $inprojects ? $inprojects : GetReq('inprojects');
		$fromtoday = $fromtoday ? $fromtoday : GetReq('fromtoday');
		$use_template = $template ? false : true;
		$usage = null;	
	
		//$id_label = localize('_resid',getlocal());
		//$date_label = localize('_resdate',getlocal());
		//$user_label = localize('_resuser',getlocal());
		//$project_label = localize('_project',getlocal());

		if (!$retcounter) {
		
			$today = date('Y-m-d');
			$year = date('Y');
			$week = date('w');
			$day_of_week = date('N');
					
		    if ($inprojects) {
				$query = "SELECT r.id,r.rdate,r.ryear,r.rweek,r.rday,r.rtime,r.rprice,r.rname,r.remail,r.active,r.deleted,p.title,p.code,p.cat FROM reservations r, projects p WHERE";
				$query .= " r.project_id=p.id AND r.ruser_id='{$user}' AND r.active=1";
				if ($fromtoday) 
					$query .= " AND r.ryear='{$year}' AND r.rweek>='{$week}'";
				$query .= ' order by r.rweek DESC';			
			}
			else {
				$query = "SELECT id,code,rdate,ryear,rweek,rday,rtime,rprice,rname,remail,active,deleted FROM reservations WHERE";
				$query .= " project_id=0 AND ruser_id='{$user}' AND active=1";
				if ($fromtoday)
					$query .= " AND ryear='{$year}' AND rweek>='{$week}'";	
				$query .= ' order by rweek DESC';
			}
			//echo $query;	
			$result = $db->Execute($query,2);
			
			//$my_label = ($inprojects) ? $project_label : $user_label;
			$nickname = @array_shift($this->get_xixuser('user_name'));

			$count = 0; 
			if (!empty($result->fields)) {
			  
			  foreach ($result as $n=>$rec) {
				$count+=1;	
                $c = sprintf('%03d',$count);				
				$active_deleted = $rec['active'] ? 
				                  "<li class='icon-check'/>" : 
				                  ($rec['deleted'] ? "<li class='icon-circle'/>" : "<li class='icon-circle'/>");
				$ww = sprintf('%02d',$rec['rweek']);
				$resdate = $this->highlight_today(date('d-m-Y', strtotime("{$rec['ryear']}W{$ww}{$rec['rday']}")));
				//$resdate = $rec['rday'].'-'.$ww.'-'.$rec['ryear']; 
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['rdate'])));
				
				$u_details = $nickname ? $nickname : ($rec['rname'] ? $rec['rname'] : $rec['remail']);
				
				$ptitle = seturl('t=kshow&cat='.$rec['cat'].'&id='.$rec['code'],$rec['title'],null,null,null,1);
				$details = ($inprojects) ? "<li class='icon-group'/>".$ptitle : "<li class='icon-user'/>".$u_details;
				
				$usage[] = $c .' '. $insdate . '||' . 
				         $resdate .' '. $rec['rtime'] .' '. $active_deleted . '||' . 
					     $details;						 
			  }

              $bcall = ($inprojects) ? 'usageinprojects' : 'usage';
              $title = ($inprojects) ? localize('_involve',getlocal()) : localize('_opendates',getlocal());			  
		      $ppager = GetReq('pl')?GetReq('pl'):10;
			  $browser = new browse($usage,$title,$this->getpage($usage,null),null,null,$bcall,$use_template, true);
			  $out .= $browser->render("getusage",$ppager,$this,1,1,0,0);
			  unset ($browser);			
		
			  $out .= '</table>';				  
            }				
			
			return ($out);				
		}
		else {//return counter
			$query = "SELECT count('id') as xix from reservations WHERE";
			$query .= " ruser_id='{$user}' AND active=1";	
			//echo $query;	
			$result = $db->Execute($query,2);	
            $usage = $result->fields['xix'];			
		}

        return ($usage); 		
	}	
	
	protected function get_usage($project_id=null, $ouser=null) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = decode($UserName);
		$owner = $ouser ? $ouser : $user;
		$usage = null;
		
		$res_label = localize('RESERVATIONS_DPC',getlocal());
		$cost_label = localize('_cost',getlocal());
		$costpr_label = localize('_costperres',getlocal());
		
		if ($project_id) {
		
			$id_label = localize('_resid',getlocal());
			$date_label = localize('_resdate',getlocal());
			$user_label = localize('_resuser',getlocal());		
		
			$query = "SELECT id,rdate,ryear,rweek,rday,rtime,rprice,rname,remail,active,deleted,rapprove,oapprove from reservations WHERE";
			$query.= " project_id='{$project_id}'";
			
			//if not owner fetch user's reservations 
			//else all users involved reservations
			//if ($user != @array_shift($this->get_project($project_id,'owner')))
			if ($user != $owner)
				$query.= " AND ruser_id='{$user}'";
			$query .= 'order by rdate';	
			//echo $query;	
			$result = $db->Execute($query,2);

			$count = 0; 
			if (!empty($result->fields)) {
			  $usage.= "<table id='usage_table'><tr><th>{$id_label}</th><th>{$date_label}</th><th>{$user_label}</th></tr>";
			  foreach ($result as $n=>$rec) {
				$count+=1;	
				$c = sprintf('%03d',$count);	
				$active_deleted = $rec['active'] ? 
				                  "<li class='icon-check'/>" : 
				                 ($rec['deleted'] ? "<li class='icon-circle'/>" : "<li class='icon-circle'/>");
				$ww = sprintf('%02d',$rec['rweek']);
				$resdate = $this->highlight_today(date('d-m-Y', strtotime("{$rec['ryear']}W{$ww}{$rec['rday']}")));
				//$resdate = $rec['rday'].'-'.$ww.'-'.$rec['ryear']; 
				$insdate = $this->highlight_today(date('d-m-Y',strtotime($rec['rdate'])));
				
				$rapprove = $rec['rapprove'] ? "<li class='icon-bell'/>" : null;
				$oapprove = $rec['oapprove'] ? "<li class='icon-bookmark'/>" : null;
				
		        $usage.= '<tr><td>' .
				         $c .' '. $insdate . 
						 '</td><td>' . 
				         $resdate .' '. $rec['rtime'] .' '. $active_deleted . 
				         '</td><td>' . 
					     $rec['rname'] .  ' (' . $rec['remail'] . ')' . $rapprove . $oapprove . 						 
				         '</td></tr>';				
			  }
              $usage.= '</table>';	
            }			
		}
		
		$usage.= "<table id=\"usage_table\"><tr><th>{$res_label}</th><th>{$cost_label}</th><th>{$costpr_label}</th></tr><tr><td>" . 
		         $this->count_reservations($project_id) . 
				 '</td><td>' . 
				 $this->cost_reservations($project_id) .  ' ' . 
				 $this->global_currency . 
				 '</td><td>' . 
				 $this->global_price . ' ' . 
				 $this->global_currency . 
				 '</td></tr></table>';
				 
		return($usage);
	}	

	protected function count_reservations($xuser=null) {
		$db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = $xuser ? $xuser : decode($UserName);
		
		$query = "SELECT id from reservations WHERE ruser_id='{$user}'";
		$result = $db->Execute($query,2);

		$count = 0; 
        foreach ($result as $n=>$rec)
			$count+=1;	
		
		return($count);
	}

	public function cost_reservations($xuser=null) {
		$db = GetGlobal('db');	
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;			
		$user = $xuser ? $xuser : decode($UserName);
		
		$query = "SELECT rprice from reservations WHERE ruser_id='{$user}' AND oapprove=1 ";
		$result = $db->Execute($query,2);
		
		$cost = 0;		
        foreach ($result as $n=>$rec)
			$cost += $rec['rprice'];			

		return($cost);
	}	
	
	protected function list_users($users_array=null) {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;
		
		$user = decode($UserName);

		//$query = mysql_query("SELECT * FROM xixusers ORDER BY user_is_admin DESC, user_name")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');
		if ($this->is_admin(7))	{//all
			$query = "SELECT user_reservation_reminder FROM xixusers'";
		}	
		else {//current or selected list
			$query = "SELECT user_reservation_reminder FROM xixusers WHERE user_email='{$user}'";		
			if (!empty($users_array)) {
				foreach ($users_array as $u=>$usr)
					$query .= " AND user_email={$usr}";
			}
		}	
		$query .= " ORDER BY user_name";	
		$result = $db->Execute($query,2);		

		$users = '<table id="users_table"><tr><th>ID</th><th>Admin</th><th>Name</th><th>Email</th><th>Reminders</th><th>Usage</th><th>Cost</th><th></th></tr>';

		//while($user = mysql_fetch_array($query)) {
		foreach ($result as $u=>$user) {
			$users .= '<tr id="user_tr_' . $user['user_id'] . '"><td><label for="user_radio_' . $user['user_id'] . '">' . $user['user_id'] . '</label></td><td>' . $user['user_is_admin'] . '</td><td><label for="user_radio_' . $user['user_id'] . '">' . $user['user_name'] . '</label></td><td><label for="user_radio_' . $user['user_id'] . '">' . $user['user_email'] . '</label></td><td>' . $user['user_reservation_reminder'] . '</td><td>' . $this->count_reservations() . '</td><td>' . $this->cost_reservations() . ' ' . $this->global_currency . '</td><td><input type="radio" name="user_radio" class="user_radio" id="user_radio_' . $user['user_id'] . '" value="' . $user['user_id'] . '"></td></tr>';
		}

		$users .= '</table>';

		return($users);
	}		
	
	protected function change_user_permissions() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;
		
		$user = decode($UserName);
		
		//if ($user_id == $_SESSION['user_id']) {
		if (!$this->is_admin(7)) {	
			return('<span class="error_span">Sorry, you can\'t use your superuser powers to remove them</span>');
		}
		else {
			//mysql_query("UPDATE " . global_mysql_users_table . " SET user_is_admin = 1 - user_is_admin WHERE user_id='$user_id'")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');
			$query = "UPDATE xixusers SET user_is_admin = 1 - user_is_admin WHERE user_email='{$user}'";	
			$result = $db->Execute($query,1);	
			return(1);
		}
	}	
	
	protected function get_user_reminders() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;

        $user = decode($UserName);		
		
		$query = "SELECT user_reservation_reminder FROM xixusers WHERE user_email='{$user}'";
		$result = $db->Execute($query,2);			
	
		if ($result->fields['user_reservation_reminder'] == 1)	{
			$return = '<input type="checkbox" id="user_reminders_checkbox" checked="checked">';
		}
		else {
			$return = '<input type="checkbox" id="user_reminders_checkbox">';
		}

		return($return);
	}

	protected function toggle_user_reminder() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;		
	
		$user_id = decode($UserName);//$_SESSION['user_id'];
		//mysql_query("UPDATE " . global_mysql_users_table . " SET user_reservation_reminder = 1 - user_reservation_reminder WHERE user_id='$user_id'")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');

		$query = "UPDATE xixusers SET user_reservation_reminder = 1 - user_reservation_reminder WHERE user_email='{$user_id}'";	
		$result = $db->Execute($query,1);		
		
		return(1);
	}
	
	protected function get_user_socialize() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;	
		$user = decode($UserName);
		
		$query = "SELECT user_reservation_socialize FROM xixusers WHERE user_email='{$user}'";
		$result = $db->Execute($query,2);			
	
		if ($result->fields['user_reservation_socialize'] == 1)	{
			$return = '<input type="checkbox" id="user_socialize_checkbox" checked="checked">';
		}
		else {
			$return = '<input type="checkbox" id="user_socialize_checkbox">';
		}

		return($return);
	}	
	
	//alias get_reservation_socialize return boolean
	protected function is_social() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;	
		$user = decode($UserName);
		
		$query = "SELECT user_reservation_socialize FROM xixusers WHERE user_email='{$user}'";
		$result = $db->Execute($query,2);			
	
		if ($result->fields['user_reservation_socialize'] == 1)	
			return (true);

		return(false);
	}		

	protected function toggle_user_socialize() {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;		
		$user_id = decode($UserName);

		$query = "UPDATE xixusers SET user_reservation_socialize = 1 - user_reservation_socialize WHERE user_email='{$user_id}'";	
		$result = $db->Execute($query,1);		
		
		return(1);
	}		
	
	//called as list
	protected function list_all_users($template=false) {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) {
			//return false; //login
			//return ($this->login_or_register());
			
			if (defined('SHLOGIN_DPC')) {
				$ret = GetGlobal('controller')->calldpc_method('shlogin.html_form');				
				return ($ret);
			}
            return false;			
		}	
		
		$current_user = decode($UserName);
		$clickuser = localize('_clickuser',getlocal());

		$query = "SELECT user_id,user_email,user_name,user_reservation_reminder,user_reservation_socialize,longitude,latitude from xixusers";
		$query .= " ORDER BY user_name";	
		$result = $db->Execute($query,2);		

		//header
		//$users = '<p id="user_show_message_p"></p>';
		//$users .= "<div id='mapholder'></div>";
		$users .= '<table id="users_table"><tr><th>ID</th><th>Name</th><th>Email</th><th>Social</th><th>Reminders</th><th>Usage</th><th>Cost</th><th>Map</th></tr>';
		
        $i =0;
		foreach ($result as $u=>$user) {
		    $i+=1;
			
			$lo = $user['longitude'];
			$la = $user['latitude'];
			$name = $user['user_name'];
			$uid = $user['user_id'];
			$uemail = $user['user_email'];
			
			//line
			$users .= '<tr id="user_tr_' . $uid . '">' .
			          '<td>' . $i . '</td>' . 
					  '<td>' . "<p id='user_show_message_p_{$uid}'>{$name}</p>". 
							   "<div id='mapholder_{$uid}'></div>" . '</td>'.
					  '<td>' . $user['user_email'] . '</td>' .
					  '<td>' . $user['user_reservation_socialize'] . '</td>' .
					  '<td>' . $user['user_reservation_reminder'] . '</td>'.
					  '<td>' . $this->count_reservations($uemail) . '</td>'.
					  '<td>' . $this->cost_reservations($uemail) . ' ' . $this->global_currency . '</td>' .
					  '<td>'. "<button class='btn btn-small' id='user_{$uid}' onclick='show_user_details(\"{$uid}\",\"{$uemail}\",\"{$name}\",{$la},{$lo},1,\"user_show_message_p_{$uid}\",\"mapholder_{$uid}\")'>{$clickuser}</button>" . '</td>'.
					  '</tr>';	
					  		
		}
		$users .= '</table>';
		
		if ($template) {
			//use template
			$tokens = array(0=>$users,1=>localize('_xixusers',getlocal()));
			$template = 'xixpanel.htm';
			$t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.',$template) ;
			if (is_readable($t)) 
				$tdata = @file_get_contents($t);			
	   
			if (($tdata) && (!empty($tokens))) 		
				$out = $this->combine_tokens2($tdata, $tokens, true);
			else
				$out = $users;
				
			return ($out);			
        }
		return($users);
	}	
	
	protected function show_user_details($user_id, $user_email, $user_name, $user_longitude, $user_latitude, $user_details=false) {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;		
	
        $longi = $user_longitude ? $user_longitude : 0;		
		$latit = $user_latitude ? $user_latitude : 0;		
		
		$ret  = '<h2>'.$user_name.'</h2>'.$user_email;//.$user_longitude.'x'.$user_latitude;
		
		if (($user_details) && ($user_email==decode($UserName))) 
			$ret .= $this->show_xixuser(true);
		
		return ($ret);
    }
	
	protected function change_user_details($user_name, $user_longitude, $user_latitude) {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;		
	
        $longi = $user_longitude ? $user_longitude : 0;		
		$latit = $user_latitude ? $user_latitude : 0;	
	
		$user_id = decode($UserName);
		$user_name_check = localize('_usrnamecheck' ,getlocal());

		if($this->validate_user_name($user_name) != true) {
			return("<span class=\"error_span\">{$user_name_check}</span>");
		}

		if($this->user_name_exists($user_name) == true /*&& $user_name != $_SESSION['user_name']*/) {
			return('<span class="error_span">Name is already in use. If you have the same name as someone else, use another spelling that identifies you</span>');
		}

		//mysql_query("UPDATE " . global_mysql_reservations_table . " SET reservation_user_name='$user_name', reservation_user_email='$user_email' WHERE reservation_user_id='$user_id'")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');
		$query = "UPDATE xixusers SET user_name='{$user_name}',longitude={$longi},latitude={$latit} WHERE user_email='{$user_id}'";		
		$result = $db->Execute($query,1);
 
		return(1);
	}	
	
	// String validation

	function validate_user_name($user_name) {
		//if(preg_match('/^[a-z æøåÆØÅ]{4,12}$/i', $user_name)) {
		if(preg_match('/^[0-9 A-Za-z α-ωΑ-Ω άίόώέή]{4,19}$/u', $user_name)) {
			return(true);
		}
	}

	function validate_user_email($user_email) {
		if(filter_var($user_email, FILTER_VALIDATE_EMAIL) && strlen($user_email) < 51) {
			return(true);
		}
	}

	function validate_user_password($user_password) {
		if(strlen($user_password) > 3 && trim($user_password) != '') {
			return(true);
		}
	}

	function validate_price($price) {
		if(is_numeric($price)) {
			return(true);
		}
	}	
	
	// User validation

	function user_name_exists($user_name) {
		$db = GetGlobal('db');	
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;	

		$user = decode($UserName);
		
		$query = "SELECT user_name FROM xixusers WHERE user_name='{$user_name}'";
		$query.= " AND user_email<>'$user'";//exclude current user
		$result = $db->Execute($query,2);			
	
		if ($result->fields['user_name'])
			return true;
		
		return false;	
	}

	function user_email_exists($user_email) {
		$db = GetGlobal('db');	
	    $UserName = GetGlobal('UserName');
		if (!$UserName) return false;	
		
		$query = "SELECT user_email FROM xixusers WHERE user_email='{$user_email}'";
		$result = $db->Execute($query,2);			
	
		if ($result->fields['user_email'])
			return true;
		
		return false;		
	}	

	protected function highlight_today($day, $force=false) {
	    $today = date('d-m-Y');
		
		$retday = ((strtotime($today)==strtotime($day)) || ($force)) ?
		          str_ireplace($day, '<span id="selected_span">' . $day . '</span>', $day) :
				  $day;
				
		return $retday;
	}	
	
	//remiders,invitations run by cron
	public function reminders_job($isinvitation=false, $tellowner=false) {
		$db = GetGlobal('db');
		$week_number = $this->global_week_number;
		$day_number = $this->global_day_number;	
		$global_organization = 'XIX';	
		$global_reservation_reminders_email = 'noreply@xix.gr';
		$global_url = array_shift(arrayload('SHELL','ip'));//'www.xix.gr';
		$send_from = paramload('SMTPMAIL','user');
		//$project_id = GetReq('iproject');
		$press_button = localize('_pressbutton',getlocal());
		$register_url = '<a href="'.$global_url . '/xix/'.'">'.$press_button.'</a>'; //xix.php
		$ret = null;
		$tellowner = true; //owner messaging
		//return ('mails send '.$project_id);//true;

		/*if (php_sapi_name() == 'cli' && 
		    empty($_SERVER['REMOTE_ADDR']) || 
			isset($_GET['code']) && 
			$_GET['code'] == $this->global_reservation_reminders_code) {*/
		//if ($project_id) {
		//if (php_sapi_name() == 'cli' && empty($_SERVER['REMOTE_ADDR'])) {
		
		    $notauser = localize('_notauser',getlocal());
			$notauserornotintime = localize('_notauserornotintime',getlocal());
		    $success = localize('_success',getlocal());
			$failed = localize('_failed',getlocal());
			$inv_subject = localize('_isubject',getlocal());
			$rem_subject = localize('_rsubject',getlocal());
			
			$today = date('Y-m-d');
			
            if ($isinvitation) {
				$iquery = "SELECT id,code,cat,owner,start,end,title,class,type,plan,exclude,include FROM projects WHERE";
				//$iquery.= " active=1 AND start = date '".$today."'";		
				$iquery.= " active =1 AND start<= date '". $today ."' AND end> date '" . $today . "'";
				$iresult = $db->Execute($iquery,2);
				
				foreach ($iresult as $p=>$rec) {
				
				    $ret .= "\r\n\nProject:".$rec['title']."\r\n\n";
				
				    $nickname = @array_shift($this->get_xixuser('user_name',$rec['owner']));
					$xixname = $nickname ? $nickname : $rec['owner'];
					$ex = explode(',',$rec['exclude']);
					$in = explode(',',$rec['include']);
					$start = date('d-m-Y',strtotime($rec['start']));
					$end = date('d-m-Y',strtotime($rec['end']));
					$plan = $rec['plan'] ? $rec['plan'] : 'daily';
					//print_r($in);
					$project_url =  '<a href="'.$global_url .'/'. seturl('t=kshow&cat='.$rec['cat'].'&id='.$rec['code'],null,null,null,null,1).'">'.$press_button.'</a>';
					
					foreach ($in as $m=>$mail) {
						if (!in_array($mail,$ex)) {
					
							$subject = $inv_subject.' '.$rec['title'];
							$headers = "From: " . $global_organization . " <" . $global_reservation_reminders_email . ">\r\n";
							$headers .= "MIME-Version: 1.0\r\n";
							//$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							
							if (!$message = $this->create_message_body('xixreminder.htm',
				                                           array('0'=>$iresult->fields['title'],
														         '1'=>$start.','.$end,
																 '2'=>$plan,
																 '3'=>$project_url,
																 '4'=>$register_url,
																 '5'=>$xixname,))) {
								$message = "This is a invitation for {$rec['title']} starting from {$start} to {$end}.\r\n\nYou have been invited by {$xixname} to make a reservation at the following plan(s): " . $plan . "\r\n\nIf you don't have a XIX account, create your XIX profile to make your reservation.\r\n\n" . $global_url;
								$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							}
							else
								$headers .= "Content-type: text/html; charset=utf-8\r\n";
								
							//$s = mail($mail, '=?UTF-8?B?'.base64_encode($subject).'?=', $message, $headers, "-f".$global_reservation_reminders_email);
							$s = $this->sendmail_inqueue($send_from,$mail,$subject,$message,1,1);
							$ret .= $s ? $mail." {$success}\r\n" : $mail." {$failed}\r\n";					
						}	
					}	
				
					//update flag
					$uquery = "UPDATE projects SET invsend = invsend + 1";
					$uquery.= " WHERE id=".$rec['id'];		
					$uresult = $db->Execute($uquery,1);
				}
				return ($ret?$ret:$notauser);//.$iquery);
            }

            $year = date('Y');			
			$week = date('W');
			$day_of_week = date('N');

			//select from users
			//$query = mysql_query("SELECT * FROM " . global_mysql_users_table . " WHERE user_reservation_reminder='1'")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');
			//$query = "SELECT x.user_email,r.project_id,p.title,p.owner FROM xixusers x, reservations r, projects p WHERE x.user_reservation_reminder='1'";
			//$query.= " AND r.project_id=".$project_id ." AND p.id=".$project_id;		
			
			$query = "SELECT id,code,cat,owner,start,end,title FROM projects WHERE";
			$query.= " active=1 AND start<= date '". $today ."' AND end> date '" . $today . "'";
			$result = $db->Execute($query,2);			
			//echo $query;
			//while($user = mysql_fetch_array($query)) {
			foreach ($result as $r=>$rec) {
                //echo $rec['title'],'>';
			    $ret .= "\r\n\nProject:".$rec['title']."\r\n\n";
			
				$owner = $rec['owner'];
				$project_id = $rec['id'];
				$project_title = $rec['title'] ? $rec['title'] : null;
                $project_url =  '<a href="'.$global_url .'/'. seturl('t=kshow&cat='.$rec['cat'].'&id='.$rec['code'],null,null,null,null,1).'">'.$press_button.'</a>';

				//$query2 = mysql_query("SELECT * FROM " . global_mysql_reservations_table . " WHERE reservation_user_id='$user_id' AND reservation_week='$week_number' AND reservation_day='$day_number' ORDER BY reservation_time")or die('<span class="error_span"><u>MySQL error:</u> ' . htmlspecialchars(mysql_error()) . '</span>');
				$query2 = "SELECT id,ruser_id,rtime,remail FROM reservations WHERE ryear='$year' AND rweek='$week' AND rday='$day_of_week'";
				$query2.= " AND active=1 AND project_id=".$project_id;
				$query2.= " ORDER BY rtime"; 	
				$result2 = $db->Execute($query2,2);
                //echo $query2;
				//if(mysql_num_rows($query2) > 0) {
				if (!empty($result2)) {
				
				    $towner = false;

					foreach ($result2 as $r2=>$rec2) {
					
					    $reservation_id = $rec2['id'];
						$verify_url = '<a href="'.$global_url .'/xix.php?t=userverify&cat='.$rec['cat'].'&id='.$rec['code'].'&pid='.$reservation_id.'">'.$press_button.'</a>';
				
					
						$query3 = "SELECT user_email,user_name,user_reservation_reminder FROM xixusers WHERE user_email='{$rec2['remail']}'"; 	
						$result3 = $db->Execute($query3,2);
					    
						if ($result3->fields['user_reservation_reminder']=='1') {
						
						    $user_date = date('d-m-Y');
							$user_time = $rec2['rtime'];
							$subject = $rem_subject.' '.$project_title;
							$headers = "From: " . $global_organization . " <" . $global_reservation_reminders_email . ">\r\n";
							$headers .= "MIME-Version: 1.0\r\n";
							//$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							
							if (!$message = $this->create_message_body('xixreminder.htm',
				                                           array('0'=>$project_title,
														         '1'=>$user_date,
																 '2'=>$user_time,
																 '3'=>$project_url,
																 '4'=>$verify_url,
																 '5'=>$xixname,))) {
								$message = "This is a reservation reminder for today.\r\n\nYou have made a reservation at the following time(s): " . $user_time . "\r\n\nIf you don't want to receive reservation reminders, you can turn it off in the control panel.\r\n\n" . $global_url;
								$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							}
							else
								$headers .= "Content-type: text/html; charset=utf-8\r\n";
															
							//$s = mail($rec2['remail'], '=?UTF-8?B?'.base64_encode($subject).'?=', $message, $headers, "-f".$global_reservation_reminders_email);
							$s = $this->sendmail_inqueue($send_from,$rec2['remail'],$subject,$message,1,1);
							$ret .= $s ? $rec2['remail']." {$success}\r\n" : $rec2['remail']." {$failed}\r\n";
						}
						
						//reminder for project owner
						if ($tellowner) {
						
						    $ownerverify_url = '<a href="'.$global_url .'/xix.php?t=ownerverify&cat='.$rec['cat'].'&id='.$rec['code'].'&pid='.$project_id . '">'.$press_button.'</a>';
							$time = $rec2['rtime'];
							$subject = $rem_subject.' '.$project_title;
							$headers = "From: " . $global_organization . " <" . $global_reservation_reminders_email . ">\r\n";
							$headers .= "MIME-Version: 1.0\r\n";
							//$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							
							if (!$message = $this->create_message_body('xixownertell.htm',
				                                           array('0'=>$result3->fields['title'],
														         '1'=>$rec['start'].','.$rec['end'],
																 '2'=>$project_url,
																 '3'=>$today.','.$time,
																 '4'=>$result3->fields['user_name'],
																 '5'=>$ownerverify_url,)))	{
								$message = "This is a reservation reminder for today.\r\n\nYou have made a reservation at the following time(s): " . $time . "\r\n\nIf you don't want to receive reservation reminders, you can turn it off in the control panel.\r\n\n" . $global_url;
								$headers .= "Content-type: text/plain; charset=utf-8\r\n";
							}
							else
								$headers .= "Content-type: text/html; charset=utf-8\r\n";
													
							//send mail to owner
							//$towner = mail($owner, '=?UTF-8?B?'.base64_encode($subject).'?=', $message, $headers, "-f".$global_reservation_reminders_email);
							$towner = $this->sendmail_inqueue($send_from,$owner,$subject,$message,1,1);
							//$ret .= $s ? $owner." {$success}\r\n" : $rec2['remail']." {$failed}\r\n";
						}
					}
				}	
				
				//owner flag
				$ret .= $towner ? $owner . "\r\n\n received a note as project owner." : null;
				
				//update flag
				$uquery = "UPDATE projects SET remsend = remsend + 1";
				$uquery.= " WHERE id=".$project_id;		
				$uresult = $db->Execute($uquery,1);	
				return ($ret);
			//}
		}	
	}	
	
	//template based message body
	protected function create_message_body($template=null, $tokens=null) {
		if (!$template) return false;
		
		//use template
		//$tokens = array(0=>$ret);
		//$template = 'xixpanel.htm';
	    $t = $this->urlpath .'/' . $this->infolder . '/cp/html/'. str_replace('.',getlocal().'.',$template) ;
	    if (is_readable($t)) 
			$tdata = @file_get_contents($t);			
	   
	    if (($tdata) && (!empty($tokens))) 		
			$out = $this->combine_tokens2($tdata, $tokens, true);
		else
            $out = $ret;
			
		return ($out);		
	}

	//send mail to db queue
	function sendmail_inqueue($from,$to,$subject,$mail_text='',$is_html=false, $trackmail=false) {
	   $db = GetGlobal('db');	
	   $ishtml = $is_html?$is_html:0;
       $sFormErr = GetGlobal('sFormErr');
	   $ccs = null;//GetParam('cc'); //echo $ccs;		 	      
	   $bccs = null;//GetParam('bcc');	//echo $bccs;	
	   $altbody = null;//GetParam('alttext'); 
	   $origin = $this->prpath; 
	   $user = paramload('SMTPMAIL','user');
	   $pass = paramload('SMTPMAIL','password');
	   $name = paramload('SMTPMAIL','realm');
	   $server = paramload('SMTPMAIL','smtpserver');//null; //default values
	   $appname = null;//'xix';
	    		
	   if ($trackmail) {
		 
       	 $i = rand(1000,1999);//++$m; 	 
		 $trackid = date('YmdHms') . $i . 'a@' . $appname;		 
		 
		 if (!$ishtml) {
		   $ishtml = 1;		 
		   $html_mail_text = '<HTML><BODY>' . $mail_text . '</BODY></HTML>';
		   $body = $this->add_tracker_to_mailbody($html_mail_text,$trackid,$to,$ishtml);
		 }
		 else //already html body ...leave it as is
	       $body = $this->add_tracker_to_mailbody($mail_text,$trackid,$to,$ishtml);
	   }
	   else
	     $body = $mail_text;

       if ((checkmail($from)) && ($subject)) {//echo $to,'<br>';
	   
         //add to db...local table
		 $datetime = date('Y-m-d h:s:m');
		 $active = 1;
         if (($trackmail) && (isset($trackid))) 
		   $sSQL = "insert into mailqueue (timein,active,sender,receiver,subject,body,altbody,cc,bcc,ishtml,encoding,origin,user,pass,name,server,trackid) ";
		 else  		 
		   $sSQL = "insert into mailqueue (timein,active,sender,receiver,subject,body,altbody,cc,bcc,ishtml,encoding,origin,user,pass,name,server) ";
		   
		 $sSQL .=  "values (" .
				 $db->qstr($datetime) . "," . $active . "," .
		 	     $db->qstr(strtolower($from)) . "," . $db->qstr(strtolower($to)) . "," .
			     $db->qstr($subject) . "," . 
				 $db->qstr($body) . "," .
				 $db->qstr($altbody) . "," .				 
				 $db->qstr($ccs) . "," .
				 $db->qstr($bccs) . "," .
				 $ishtml . "," .
				 $db->qstr('utf-8') . "," .  
		         $db->qstr($origin) . "," .			 
				 $db->qstr($user) . "," .
				 $db->qstr($pass) .	"," .	
				 $db->qstr($name) . "," .
				 $db->qstr($server);
				 
         if (($trackmail) && (isset($trackid))) {
		    $sSQL .= "," . $db->qstr($trackid) . ")";
		 }
		 else				 					 
			$sSQL .= ")"; 
	     //echo $sSQL;			
	     $result = $db->Execute($sSQL,1);			 
		 //$ret = $result->Affected_Rows();
					     	  	
  	     return true;
       }

	   return false;			 
	}	
	
	function add_tracker_to_mailbody($mailbody=null,$id=null,$receiver=null,$is_html=false) {
	
	   if (!$id) return;
	   
	   $i = rawurlencode(encode($id));
	
	   if ($receiver) {
	     $r = rawurlencode(encode($receiver));
	     $ret = "<img src=\"http://www.xix.gr/mtrack.php?i=$i&r=$r\" border=\"0\" width=\"1\" height=\"2\">";
	   }
	   else
	     $ret = "<img src=\"http://www.xix.gr/mtrack.php?i=$i\" border=\"0\" width=\"1\" height=\"2\">";
		 
	   if (($is_html) && (stristr($mailbody,'</BODY>')))
	     $out = str_ireplace('</BODY>',$ret.'</BODY>',$mailbody);
	   else
	     $out = $mailbody . $ret;

       @file_put_contents($this->prpath.'/trackcode.txt',$out);	 	 
		 
	   return ($out);	 
	} 	
	
	
	
	//called as list browser
	protected function list_all_users_browser($template=false) {
	    $db = GetGlobal('db');
	    $UserName = GetGlobal('UserName');
		$use_template = $template ? false : true;
		
		if (!$UserName) {
			
			if (defined('SHLOGIN_DPC')) {
				$ret = GetGlobal('controller')->calldpc_method('shlogin.html_form');				
				return ($ret);
			}
            return false;			
		}	
		
		$clickuser = localize('_clickuser',getlocal());
		$current_user = decode($UserName);

		$query = "SELECT user_id,user_email,user_name,user_reservation_reminder,user_reservation_socialize,longitude,latitude from xixusers";
		$query .= " ORDER BY user_name";	
		$result = $db->Execute($query,2);		

        $i =0;
		foreach ($result as $u=>$user) {
		    $i+=1;
			
			$lo = $user['longitude'];
			$la = $user['latitude'];
			$name = $user['user_name'] ? $user['user_name'] : $user['user_email'];
			$uid = $user['user_id'];
			$uemail = $user['user_email'];
			$usocial = $user['user_reservation_socialize'];
			$uremind = $user['user_reservation_reminder'];
			
			//line
			$users[] = $i . '||' . 
			           "<p id='user_show_message_p_{$uid}'>{$name}</p><div id='mapholder_{$uid}'></div>" .'||'. 
					   $uemail . '||' .
					   $usocial . '||' .
					   $uremind . '||'.
					   $uemail . '||'.
					   $uemail . '||' .
					   "<button class='btn btn-small' id='user_{$uid}' onclick='show_user_details(\"{$uid}\",\"{$uemail}\",\"{$name}\",{$la},{$lo},1,\"user_show_message_p_{$uid}\",\"mapholder_{$uid}\")'>{$clickuser}</button>";						  		
		}

		//$out = '<table id="users_table">';
		
		$ppager = GetReq('pl')?GetReq('pl'):10;
        $browser = new browse($users,localize('_xixusers',getlocal()),$this->getpage($users,null),null,null,'users',$use_template);
	    $out .= $browser->render("xixuserslist",$ppager,$this,1,1,0,0);
	    unset ($browser);			
		
		$out .= '</table>';
		
        return ($out);
	}	
	
	function getpage($array,$id){
	
	   if (count($array)>0) {
         //while(list ($num, $data) = each ($array)) {
         foreach ($array as $num => $data) {
		    $msplit = explode("||",$data);
			if ($msplit[1]==$id) return floor(($num+1) / $this->pagenum)+1;
		 }	  
		 
		 return 1;
	   }	 
	}

    function browse($packdata,$view,$cmd=null) {
	    //echo '>',$cmd;
		
	    $data = explode("||",$packdata); 
	    //print_r($data);
	
        $out = '<tr><td>';
	    //$out.= implode('</td><td>', $data);

	    switch ($cmd) {	
			case 'getpurchases' :
		    case 'getexchanges' :		
			case 'gettransports' :
		    case 'getprojects' :
            case 'usageinprojects':		
		    case 'usage' :  $out.= $data[0] . '</td><td>';
							$out.= $data[1] . '</td><td>';
							$out.= $data[2];
                            break;			
			case 'users' :
			default      :		
							$out.= $data[0] . '</td><td>';
							$out.= $data[1] . '</td><td>';
							$out.= $data[2] . '</td><td>';
							$out.= $data[3] . '</td><td>';
							$out.= $data[4] . '</td><td>';
							$out.= $this->count_reservations($data[5]) . '</td><td>';
							$out.= $this->cost_reservations($data[6]) . ' ' . $this->global_currency . '</td><td>';
							$out.= $data[7];
		}							
		
	    $out.= '</td></tr>';

	    return ($out);
	}		
	
	function headtitle($view=null,$cmd=null) {
	    //echo '>',$cmd;
	    switch ($cmd) {
		    case 'getpurchases' :
			                $out = '<table id="purchases_table"><tr><th>'.
							         localize('_date',getlocal()).'</th><th>'.
									 localize('_item',getlocal()).'</th><th>'.
									 localize('_seller',getlocal()).'</th></tr>';  
                            break;			
		    case 'getexchanges' :
			                $out = '<table id="exchange_table"><tr><th>'.
							         localize('_date',getlocal()).'</th><th>'.
									 localize('_item',getlocal()).'</th><th>'.
									 localize('_customer',getlocal()).'</th></tr>';  
                            break;			
		    case 'gettransports' :
			                $out = '<table id="transports_table"><tr><th>'.
							         localize('_date',getlocal()).'</th><th>'.
									 localize('_item',getlocal()).'</th><th>'.
									 localize('_trans',getlocal()).'</th></tr>';  
                            break;			
		    case 'getprojects' :
			                $out = '<table id="projects_table"><tr><th>'.
							         localize('_prjid',getlocal()).'</th><th>'.
									 localize('_prjdate',getlocal()).'</th><th>'.
									 localize('_project',getlocal()).'</th></tr>';  
                            break;	
		    case 'usageinprojects' :
			                $out = '<table id="usage_table"><tr><th>'.
							         localize('_resid',getlocal()).'</th><th>'.
									 localize('_resdate',getlocal()).'</th><th>'.
									 localize('_project',getlocal()).'</th></tr>';  
                            break;			
		    case 'usage' :
			                $out = '<table id="usage_table"><tr><th>'.
							         localize('_resid',getlocal()).'</th><th>'.
									 localize('_resdate',getlocal()).'</th><th>'.
									 localize('_resuser',getlocal()).'</th></tr>';  
                            break;			
			case 'users' :
			default      :
						    $out = '<table id="users_table"><tr><th>ID</th><th>'.
								localize('_resuser',getlocal()).'</th><th>'.
								localize('_email',getlocal()).'</th><th>'.
								localize('_social',getlocal()).'</th><th>'.
								localize('_remind',getlocal()).'</th><th>'.
								localize('_usage',getlocal()).'</th><th>'.
								localize('_cost',getlocal()).'</th><th>'.
								localize('_map',getlocal()).'</th></tr>';	   
		}						
	    return ($out);
	}		
	
	
	//tokens method	 $x
	protected function combine_tokens($template_contents,$tokens, $execafter=null) {
	
	    if (!is_array($tokens)) return;
		
		if ((!$execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
		  $fp = new fronthtmlpage(null);
		  $ret = $fp->process_commands($template_contents);
		  unset ($fp);
          //$ret = GetGlobal('controller')->calldpc_method("fronthtmlpage.process_commands use ".$template_contents);		  		
		}		  		
		else
		  $ret = $template_contents;
		  
		//echo $ret;
	    foreach ($tokens as $i=>$tok) {
            //echo $tok,'<br>';
		    $ret = str_replace("$".$i,$tok,$ret);
	    }
		//clean unused token marks
		for ($x=$i;$x<20;$x++)
		  $ret = str_replace("$".$x,'',$ret);
		//echo $ret;
		
		//execute after replace tokens
		if (($execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
		  $fp = new fronthtmlpage(null);
		  $retout = $fp->process_commands($ret);
		  unset ($fp);
          
		  return ($retout);
		}		
		
		return ($ret);
	}		
	
	//tokens method	 $x$
	protected function combine_tokens2($template_contents,$tokens, $execafter=null) {
	
	    if (!is_array($tokens)) return;
		
		if ((!$execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
		  $fp = new fronthtmlpage(null);
		  $ret = $fp->process_commands($template_contents);
		  unset ($fp);
          //$ret = GetGlobal('controller')->calldpc_method("fronthtmlpage.process_commands use ".$template_contents);		  		
		}		  		
		else
		  $ret = $template_contents;
		  
		//echo $ret;
	    foreach ($tokens as $i=>$tok) {
            //echo $tok,'<br>';
		    $ret = str_replace("$".$i."$",$tok,$ret);
	    }
		//clean unused token marks
		for ($x=$i;$x<20;$x++)
		  $ret = str_replace("$".$x."$",'',$ret);
		//echo $ret;
		
		//execute after replace tokens
		if (($execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
		  $fp = new fronthtmlpage(null);
		  $retout = $fp->process_commands($ret);
		  unset ($fp);
          
		  return ($retout);
		}		
		
		return ($ret);
	}	

	public static function myf_button($title,$link=null,$image=null, $js=null, $class=null) {

	   $path = self::$staticpath;
	   $js = $js ? "onclick='javascript:".$js."'" : null;
	   $class = $class ? 'btn' : null;
	   
	   if (($image) && (is_readable($path."/images/".$image.".png"))) {
	      //echo 'a';
	      $imglink = "<a href=\"$link\" title='$title' $js><img src='images/".$image.".png'/></a>";
	   }
	   
	   if (preg_match('/MSIE/i',$_SERVER['HTTP_USER_AGENT'])) { 
	      //echo 'ie';
		  $_b = $imglink ? $imglink : "[$title]";
		  $ret = "&nbsp;<a href=\"$link\" $js>$_b</a>&nbsp;";
		  return ($ret);
	   }	
	   
	   if ($imglink)
	       return ($imglink);
       //else //button
		 //  return ("<a class='$class' id='btn' $js>{$title}</button>");	   
	   if ($link)
	      $ret = "<a href=\"$link\">";  
	   $ret .= "<input type=\"button\" class=\"$class\" $js value=\"".$title."\" />";
	   if ($link)
          $ret .= "</a>";
		  
	   return ($ret);
	}	
};
}
?>