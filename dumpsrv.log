<?php

$__DPCSEC['SEARCHTOPIC_']='1;1;1;1;2;2;2;2;9';
$__DPCSEC['VIEWSTLS_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['ADMBROWSE_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['ALLBROWSE_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['PDFBROWSE_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['EXCELBROWSE_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['MAILBROWSE_']='1;1;1;1;1;1;1;2;9';
$__DPCSEC['PAGELENGTH_']='1;1;1;1;1;1;1;2;9';

if (!defined("BROWSER_DPC")) {
define("BROWSER_DPC",true);

$__DPC['BROWSER_DPC'] = 'browse';

$__EVENTS['BROWSER_DPC'][0]='searchtopic';
$__ACTIONS['BROWSER_DPC'][0]='searchtopic';

$__DPCATTR['BROWSER_DPC']['searchtopic'] = 'searchtopic,0,0,0,0,0,1,0,0,1'; 

$__LOCALE['BROWSER_DPC'][0]='_VIEWSTYLES;View styles;Μορφή';
$__LOCALE['BROWSER_DPC'][1]='_SORT;Sort;Ταξ.';
$__LOCALE['BROWSER_DPC'][2]='_PAGE;Page;Σελίδα';
$__LOCALE['BROWSER_DPC'][3]='_EMPTYDIR;Not availbale products;Κανένα διαθέσιμο προϊόν';
$__LOCALE['BROWSER_DPC'][4]='_NEXT;Next;Επόμενο';
$__LOCALE['BROWSER_DPC'][5]='_PREV;Prev;Προηγούμενο';
$__LOCALE['BROWSER_DPC'][6]='_BEGIN;Begin;Αρχή';
$__LOCALE['BROWSER_DPC'][7]='_END;End;Τέλος';
$__LOCALE['BROWSER_DPC'][8]='_ALLBROWSE;Show All;Προβολή Όλων';
$__LOCALE['BROWSER_DPC'][9]='_SEARCH;Search;Αναζήτηση';
$__LOCALE['BROWSER_DPC'][10]='_GROUPOF;Group;Ομαδα';

class browse {

	var $userLevelID;

    var $outpoint;
    var $rightarrow;
    var $view_on;
	var $home;
	var $pagedfiles;
	var $page;
	var $pagenum;
	var $title;
	var $datalist;
	var $sortmethod;
	var $defaultview;

    var $start_b;
    var $end_b;
	var $next_b;
    var $prev_b;
	var $selpage;
	var $stylearray;
	var $styler;
	var $columns;	
	
	var $dosearch;
	var $searchtext;
	
	var $timeout;
	
	var $alltitle;
	var $agent;

	function browse($data='',$title='',$selpage=1,$styler="",$columns="") {
	    $UserSecID = GetGlobal('UserSecID');
	    $__USERAGENT = GetGlobal('__USERAGENT');
	    $GRX = GetGlobal('GRX');	
		$PL = GetReq('pl');

        $this->userLevelID = (((decode($UserSecID))) ? (decode($UserSecID)) : 0);
		$this->agent = $__USERAGENT;
		
	    $this->searchtext = trim(GetParam("searcht"));	
		if (!$this->searchtext) $this->searchtext = GetReq('a'); //set $a as search topic
        if ($this->searchtext) $this->dosearch = 1; 
		                  else $this->dosearch = 0; 
		
        $this->datalist     = $data;       
        $this->title        = $title;
		$this->sortmethod   = GetSessionParam('sort'); 
		$this->pagedfiles   = array();
		$this->page         = 0;
		$this->pagenum      = ($PL ? $PL:10); //default
		$this->selpage      = $selpage;
		$this->columns      = $columns; //added due to a xml support
				
		$this->stylearray   = explode(",",$styler);
		$this->styler       = $styler;	
		
	    $this->timeout = paramload('SHELL','timeout');				 
		
        if ($GRX) {
             $this->outpoint = loadTheme('point');      
             $this->rightarrow = loadTheme('rarrow');
             $this->start_b = loadTheme('start',localize('_BEGIN',getlocal()));
             $this->end_b = loadTheme('end',localize('_END',getlocal()));
             $this->next_b = loadTheme('next',localize('_NEXT',getlocal()));
             $this->prev_b = loadTheme('prev',localize('_PREV',getlocal()));
		}
		else {
             $this->outpoint = "|";
	         $this->rightarrow = ">";
             $this->start_b = "<<";
             $this->end_b = ">>";
			 $this->next_b = ">";
             $this->prev_b = "<";
		}	
		
   	    $this->alltitle = localize('_ALLBROWSE',getlocal());	
        	
    }
	
	
   /* function event($event=null) {
	
       switch($event) {
          case "searchtopic" : $this->dosearch = 1; break; //has not effect	  
       }
	}
	
	function action($action=null) {
	}*/

	function render($viewtype=0,$pager,$class,$pagemaker=0,$topic=0,$sorter=0,$adminform=0,$excel=0,$pdf=0,$mail=0,$all=0) {

        if (is_array($this->datalist)) {
		    //set page length
			if ($pager) $this->pagenum = $pager;
            //sort files
		    $this->sort_files();
			
	        switch ($this->agent) {			
			
		      case 'CLI'  :
		      case 'TEXT' : 
	          case 'XML'  : 
              case 'XUL'  :
		      case 'GTK'  : $out = $this->browse_all_files($viewtype,$class);
			                break;
		      case 'HTML' :
              default     :	//paging only in HTML	
			                switch (GetReq('v')) {
							  case 'excel':  $out = $this->generateExcel(); 
							                 break;
							  case 'pdf'  :  //make array of pages		 
		                                     $this->read_pagefiles();
											 //make pdf
							                 $out = $this->generatePdf(); 
											 break;
							  case 'mail' :  $out = $this->generateMail(); 
							                 break;
							  case 'all'  :  $out = $this->viewAll($viewtype,$class);
							                 $out .= $this->browse_advance($topic,$excel,$pdf,$mail);  
							                 break;
							
							  default     :							
							                 if (($pagemaker) && (GetReq('param1')!='-all')) {
			                                   //get searched data
			                                   $this->selpage = $this->getpage($this->searchtext);
			                                   //make pages		 
		                                       $this->read_pagefiles();
                                               //preview 
		                                       $out = $this->browse_files($viewtype,$class,$pagemaker,$topic,$sorter,$adminform,$excel,$pdf,$mail,$all);		
		                                     }
			                                 else {
		                                       $out = $this->browse_all_files($viewtype,$class);
											   $out .= $this->browse_advance($topic,$excel,$pdf,$mail,null);
											 }  
							}				   
            }
		    return($out);
    	}
     }

 
    function read_pagefiles() {

		$meter = 0;
        $pnum = $this->pagenum;
			   
	    reset($this->datalist); //print_r($this->datalist);
        foreach ($this->datalist as $file_num => $filename) {	

			if ($meter >= $pnum) {
				$meter=0;
				$this->page+=1;
			}

			$this->pagedfiles[$this->page][$meter] = $filename; 
			$meter+=1;
		}

        reset ($this->datalist); 
        reset ($this->pagedfiles);

		//print_r($this->pagedfiles);
		return ($this->pagedfiles);
	}

    function browse_files($view,$class,$pagemaker,$topic,$sorter,$adminform,$excel,$pdf,$mail,$all) { 
		
		$t = GetReq('t');
		$p = GetReq('p'); 
     	$gr = urlencode(GetReq('g'));
		
        if (($adminform) && (seclevel('ADMBROWSE_',$this->userLevelID))) $out = $this->admin_start();		

        if ($this->pagedfiles) {
		    
			 //HEAD
	         switch ($this->agent) {
			 
		       case 'CLI'  :
		       case 'TEXT' : 
	           case 'XML'  : 
               case 'XUL'  :
		       case 'GTK'  : break;
		       case 'HTML' :
               default     :		

                         // view styles and sort method line
                         if (count($this->stylearray)>1)  $vs = $this->viewStyles();
			             if ($sorter) $sv = $this->sortStyles();				  

                         /*if (seclevel('ALLBROWSE_',$this->userLevelID)) {			 
	                       $data[] = seturl("t=$t&a=&g=$gr&v=all",$this->alltitle); //all view
	                       $attr[] = "left;25%;";			 
			             }*/
			 
                         if ((defined('PPDF_DPC')) && (seclevel('PDFBROWSE_',$this->userLevelID))) {	
			 
                           if (iniload('JAVASCRIPT')) {		
  	                         $plink = "<A href=\"" . seturl("t=$t&a=&g=$gr&p=$p") . "\"";	   
	                         //call javascript for opening a new browser win for the pdf doc		   
	                         $params = seturl("t=pdf&a=&g=$gr","",0,0,1) . ";PDF;statusbar=yes,scrollbars=yes,resizable=yes,width=640,height=480;";

				             $js = new jscript;
	                         $plink .= $js->JS_function("js_openwin",$params); 
                             unset ($js);

	                         $plink .= ">PDF</A>"; 
				  
				             $data[] = $plink;
	                       }
			               else			 		 
	                         $data[] = seturl("t=pdf&a=&g=$gr",'PDF'); //pdf view
				 
	                       $attr[] = "left;25%;";			 
			             }			 
			 
	                     $data[] = $vs . $sv; 
	                     $attr[] = "right;50%;";
                         if ($data)  { 
		                   $win1 = new window('',$data,$attr);
		                   $winout .= $win1->render("center::100%::0::group_form_headtitle::left::0::0::");
		                   unset ($win1);
		                 } 
             }//switch
			 
             //read current page array 
             if ($pagemaker) { 
		       if (!$p) $mypage=$this->selpage;
		           else $mypage=$p; 
			   $realpage = ($mypage-1);				   
			 }
			 else 
			   $realpage=0;				 
			   
			 $currentpagefiles = (array)$this->pagedfiles[$realpage];
			 //print_r($currentpagefiles);
			 
			 //BODY 
	         switch ($this->agent) {
			 
		   case 'CLI'  :
		   case 'TEXT' : $out = str_replace(",","|",$this->columns) . "\n";
		                 foreach ($currentpagefiles as $file_num => $filename)
					       $out .= str_replace(";","|",$filename) . "\n";
		                 break;
	       case 'XML'  : 
           case 'XUL'  :
		   case 'GTK'  : $xml = new pxml('XUL');
		                 $xml->addtag('GTKLIST','XUL',null,"columns=$this->columns|autoresize=true");
					     foreach ($currentpagefiles as $file_num => $filename)
					       $xml->addtag('GTKLISTITEM','GTKLIST',$filename,"id=$file_nuline");
					     $out = $xml->getxml();
					     unset($xml);	
		                 break;
		   case 'HTML' :
           default     : //INVOLVE CLASS METHODS headtitle() & browse() 	!!!		  		  
                         //print title head			 
                         if (method_exists($class,'headtitle')) 
						   $winout .= $class->headtitle($view);
		
		                 if (method_exists($class,'browse')) {		
	                       foreach ($currentpagefiles as $file_num => $filename) {	
				             $packdata = str_replace(";","||",$filename);
		                     $winout .= $class->browse($packdata,$view);
                           }
                         }
			             else 
			               die("Method 'browse' required !");	
			   				
						 //draw result			 
                         if ($winout)  { 		 	
		                   $win2 = new window($this->title,$winout);
		                   $out .= $win2->render("center::100%::0::group_article_body::left::0::0::");
		                   unset ($win2);				
		                 }
			             break;	
			 
			 }	//switch 	 			 
			 
	    } //if exist
        else { 
           $out = ''; //setTitle(localize('_EMPTYDIR',getlocal()));//"&nbsp";
        }
        if (($adminform) && (seclevel('ADMBROWSE_',$this->userLevelID))) $out .= $this->admin_end();
						
        $out .= $this->browse_advance($topic,$excel,$pdf,$mail,$all);									
		
		//view page browser
	    if ($pagemaker) $out .= $this->pageBrowser($view);	
				 			 
		
        return ($out);
    }

	
    ///////////////////////////////////////////////////////////
    //view page browser
    ///////////////////////////////////////////////////////////
    function pageBrowser($view) {//view is disbled as command
	    if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	    else
	      $edmode = null; 	
		
		$gr = urlencode(GetReq('g'));		
	    $p = GetReq('p');	
		$pl = GetReq('pl');			
		
		$view = $view?$view:GetReq('t');//view style is not a command anymore, so t=command		
		//echo '>',$view;  		

		$grouppager = 2;
        $ptext = localize('_PAGE',getlocal()) . " :";

        if ($this->page>0) {

          //initialize page
	      if (!$p) $p = $this->selpage;
          
          $groupprev = (($p-1) - $grouppager); 
		  if ($groupprev<=0) $groupprev = 0;
		                else $markstart = "..."; 
		  $groupnext = (($p-1) + $grouppager); 
		  if ($groupnext>$this->page) $groupnext = $this->page;
		                         else $markend = "...";

          //prev buttons
		  $prevpage = $p-1;
          $data .= seturl("t=$view&a=&g=$gr&p=1&pl=$pl".$edmode, $this->start_b) . "&nbsp;";
		  if ($prevpage>0) $data .= seturl("t=$view&a=&g=$gr&p=$prevpage&pl=$pl".$edmode, $this->prev_b);
		              else $data .= $this->prev_b;

          $data .= $markstart;
		  $data .= " " . $this->outpoint . " ";

		  for ($i=$groupprev; $i<=$groupnext; $i++) {
             $pp = $i+1;
             if ($pp==$p) {
			     $data .= seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl".$edmode,"<B>" . $pp . "</B>") . "&nbsp;" . $this->outpoint . "&nbsp;";
		     }
		     else {
                 $data .= seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl".$edmode,$pp) . "&nbsp;" . $this->outpoint . "&nbsp;";			 
		     }
          }
		  $data .= $markend;
 
          //next buttons
		  $nextpage = $p+1;
		  if ($nextpage<=$this->page+1) $data .= seturl("t=$view&a=&g=$gr&p=$nextpage&pl=$pl".$edmode , $this->next_b);	
		                           else $data .= $this->next_b; 
          $data .= "&nbsp;" . seturl("t=$view&a=&g=$gr&p=" . ($this->page+1) . "&pl=$pl".$edmode , $this->end_b );

          //buttons browser
		  $mydata[] = $data;
		  $myattr[] = "left;50%;";
		  
		  //page length
		  $mydata[] = $this->pagelength();
          $myattr[] = "center;30%;";
		  
          //page number
		  $mydata[] = "$ptext $p / " . ($this->page+1);
		  $myattr[] = "right;20%;";
		
		  $winb = new window('',$mydata,$myattr);
		  $out = $winb->render("center::100%::0::group_dir_title::right::0::0::");
		  unset ($winb);
        }

		return ($out);
    }
	
	function browse_all_files($view,$class) {
	
	    switch ($this->agent) {
			 
		   case 'CLI'  :
		   case 'TEXT' : $out = str_replace(",","|",$this->columns) . "\n";
		                 foreach ($this->datalist as $rec_num => $rec) 
					       $out .= str_replace(";","|",$rec) . "\n";
		                 break;
	       case 'XML'  : 
           case 'XUL'  :
		   case 'GTK'  : $xml = new pxml('XUL');
		                 $xml->addtag('GTKLIST','XUL',null,"columns=$this->columns|autoresize=true");
                         foreach ($this->datalist as $rec_num => $rec)
					       $xml->addtag('GTKLISTITEM','GTKLIST',$rec,"id=$rec_num");
					     $out = $xml->getxml();
					     unset($xml);	
		                 break;
		   case 'HTML' :
           default     : if (method_exists($class,'headtitle')) $winout .= $class->headtitle($view);	
	                     reset($this->datalist);
		                 if (method_exists($class,'browse')) {						 
                           foreach ($this->datalist as $rec_num => $rec) {
				             $packdata = str_replace(";","||",$rec);
		                     $winout .= $class->browse($packdata,$view);
		                   }
						 }  
                         if ($winout)  { 		 	
		                   $win2 = new window($this->title,$winout);
		                   $out = $win2->render("center::100%::0::group_article_body::left::0::0::");
		                   unset ($win2);				
		                 }		
		}
		return ($out);	
	}


    function viewStyles() {	
	    if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	    else
	      $edmode = null; 		

	    $g = GetReq('g');		
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a');		
		
        if (seclevel('VIEWSTLS_',$this->userLevelID)) {

          $vprint = localize('_VIEWSTYLES',getlocal()) . " :";

          foreach ($this->stylearray as $stylenum => $style) {		  
            if ($t==$style) $vprint .= "(".$style.")"; 
	                   else $vprint .= seturl("t=$t&a=$a&g=$g&p=$p&s=$style".$edmode, $style); 
		  }
		}
  			
        return ($vprint);
    }
	//select page length (num of lines)
	function pagelength() {
	    if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	    else
	      $edmode = null; 		
	    $g = GetReq('g');		
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a'); //not need??
	    $s = GetReq('s');
		$pl = GetReq('pl');		
		
        //if (seclevel('VIEWSTLS_',$this->userLevelID)) {

          $vprint = localize('_GROUPOF',getlocal()) . " :";

          for ($i=1;$i<6;$i++) {		  
            if ($pl==($i*10)) 
			  $vprint .= "(".$pl.")"; 
	        else 
			  $vprint .= seturl("t=$t&a=$a&g=$g&p=1&s=$s&pl=".($i*10).$edmode, "[".($i*10))."]"; 
		  }
		//}
  			
        return ($vprint);	
	}	

	function sortStyles() {
	    if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	    else
	      $edmode = null; 			
		$gr = urlencode(GetReq('g'));
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a');
		$s = GetReq('s');		

        $vprint .= localize('_SORT',getlocal()) . " :";

        if ($this->sortmethod==1) $vprint .= seturl("t=$t&a=1&g=$gr&p=$p&s=$s".$edmode, "<B>A</B>"); 
                             else $vprint .= seturl("t=$t&a=1&g=$gr&p=$p&s=$s".$edmode,"A"); 
        if ($this->sortmethod==-1) $vprint .= seturl("t=$t&a=-1&g=$gr&p=$p&s=$s".$edmode, "<B>Z</B>"); 
    	                      else $vprint .= seturl("t=$t&a=-1&g=$gr&p=$p&s=$s".$edmode,"Z"); 			  
        return ($vprint);
	}

	function sort_files() {

        //sorting (article=selected sort method, saved as session param)
        //first sort by saved method (if saved)
        switch ($this->sortmethod) {
	       case "1"  : ksort ($this->datalist,SORT_REGULAR); break; //asc
	       case "-1" : krsort ($this->datalist,SORT_REGULAR); break; //desc
           default : ksort ($this->datalist); //asc
        }					
        //secont sort by selected method (if selected) and save sort
        switch (GetReq('a')) {
	       case 1  : ksort ($this->datalist,SORT_STRING); SetSessionParam("sort", "1"); break; //asc
	       case -1 : krsort ($this->datalist,SORT_STRING); SetSessionParam("sort", "-1"); break; //desc
           default : ksort ($this->datalist); //asc		   
        }  
   		$this->sortmethod = GetSessionParam('sort');

		//print_r($this->dfiles);
	}


    ///////////////////////////////////////////////////////////////
    // directory administration (starting code called by read_dir) 
    ///////////////////////////////////////////////////////////////
    function admin_start() {
	   if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	   else
	      $edmode = null; 		   
	   $gr = urlencode(GetReq('g'));
	   $ar = urlencode(GetReq('a'));
	   $p = GetReq('p');
	   $t = GetReq('t');   
       $filename = seturl("t=$t&a=$ar&g=$gr&p=$p".$edmode);		   
 
       $out = "<FORM action=". "$filename" . " method=post class=\"thin\">"; 
  
       return ($out);
    }

    ///////////////////////////////////////////////////////////////
    // (ending code called by read_dir)
    ///////////////////////////////////////////////////////////////
    function admin_end() {
       //global $sFormErr;  	   
	   $sFormErr = GetGlobal('sFormErr');
	   
       //error message
       $toprint .= setError($sFormErr);
		   
	   $toprint .= $this->admin_commands();

	   $toprint .= "</FORM>"; //the end of the form

	   $toprint .= $this->admin_actions();		   
  
       return ($toprint);
     }
 
    function searchTopic()  {
	  if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	  else
	      $edmode = null; 		    
	  $t = GetReq('t');	
      $pl = GetReq('pl');	
	  $gr = urlencode(getReq('g')); 

      $filename = seturl("t=$t&a=&g=$gr&pl=$pl".$edmode);      

      $toprint  = "<FORM action=". $filename . " method=post class=\"thin\">";
      $toprint .= "<P><FONT face=\"Arial, Helvetica, sans-serif\" size=1><STRONG>";
      $toprint .= localize('_SEARCH',getlocal()) . ":";
	  $toprint .= "</STRONG> <INPUT name=searcht size=15></FONT>";
      $toprint .= "<FONT face=\"Arial, Helvetica, sans-serif\" size=1>";

      $toprint .= "<input type=\"submit\" name=\"Submit\" value=\"Ok\">"; 
      $toprint .= "<input type=\"hidden\" name=\"FormAction\" value=\"searchtopic\">";
      $toprint .= "</FONT></FORM>";

      return ($toprint);	   
	  //$data2[] = $toprint; 
  	  //$attr2[] = "left";

      //$swin = new window('',$data2,$attr2);
	  //$out .= $swin->render("center::100%::0::group_dir_body::left::0::0::");	
	  //unset ($swin);

      //return ($out);
    }
	
	function generateExcel() {
	  if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	  else
	      $edmode = null; 		
	  //check if extension exist
      if (defined(_EXCEL_)) {
	  
	    $t = GetReq('t');
		$a = GetReq('a');
		$g = GetReq('g');
		$p = GetReq('p');
	  
	    if (!GetReq('v')) {	//just generate link  
	      $out = seturl("t=$t&a=$a&g=$g&p=$p&v=excel".$edmode,'Excel') . "&nbsp;";
		}
		else { //generate excel

	      $excel = new ExcelGen($g,paramload('SHELL','urltitle'));
	      //initiate $row,$col variables
	      $row=0;
	      $col=0;
	
	      //write text in cell(0,0)
	      $excel->WriteText($row,$col,paramload('SHELL','urltitle').'-'.$g);
	      $row++;
		  
		  foreach ($this->datalist as $id=>$data) {
		  
		    set_time_limit(5);
		    
		    $field = explode(";",$data);
			
			$maxf = count($field);
			for ($i=0;$i<$maxf;$i++)
			  $excel->WriteText($row,$i,$field[$i]);			
			
			$row++;
		  }
		  set_time_limit($this->timeout);
	
	      //stream Excel for user to download or show on browser
	      $excel->SendFile();		
	      exit();	
		  DelReq('v'); //reset value for other browsing objects 
		}
	  }
	  
	  return ($out);
	}
	
	function generatePdf() {
	  if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	  else
	      $edmode = null; 		
	
      if (defined(_PDF_)) {
	  
	    $t = GetReq('t');
		$a = GetReq('a');
		$g = GetReq('g');
		$p = GetReq('p');
	  
	    if (!GetReq('v')) {	//just generate link 	  
	      $out = seturl("t=$t&a=$a&g=$g&p=$p&v=pdf".$edmode,'Pdf') . "&nbsp;";
		}
		else { //generate pdf doc
		
		  $pdfdoc = & new Cezpdf();
		  $eiro_diff = array(33=>'euro'); //replace char 33 (!) to 'euro'
		  $pdfdoc->selectFont(paramload('SHELL','fonts').'Helvetica.afm',
		                      array('encoding'=>'WinAnsiEncoding'),
							  array('differences'=>$euro_diff));	  
		  
		  if (is_array($this->pagedfiles)) {
		    foreach ($this->pagedfiles as $page=>$pagedata) {
			
			  set_time_limit(5);
			  
			  //$pdfdoc->ezNewPage(); //new page by default created
		      $pdfdoc->ezText(paramload('SHELL','urltitle'),50);
		      $pdfdoc->ezText($g,20);				
			  $farray = array();
		      foreach ($pagedata as $id=>$record) {
		        //$pdfdoc->ezText($record,10);				   
				$fields = explode(';',$record);
				$farray[] = $fields;				
		      }
			  $pdfdoc->ezTable($farray,
			                   array(0=>'a',1=>'b',/*2=>'c',3=>'d',4=>'e',*/   //associate keys with col names
							         /*5=>'f',*/6=>'g',8=>'h',7=>'i'), //and present only these columns
							   $g,//title
							   array('fontSize'=>6)/*
							   array('showLines'=>2,'showHeadings'=>1,'shaded'=>1, //attributes
							         'shadeCol'=>0.8,0.8,0.8,'shadeCol2'=>0.7,0.7,0.7,
									 'fontSize'=>10,'textCol'=>0,'titleFontSize'=>12,'rowGap'=>2)
							   */);		 
			  unset($farray);		  
			  $pdfdoc->ezNewPage(); //no blank page at start but to end			  
		    }	 
		  }
		  set_time_limit($this->timeout);
		  
		  $pdfdoc->ezStream();		   
		  
		  exit();
		  DelReq('v'); //reset value for other browsing objects 		  
		}  
	  }
	  
	  return ($out);
	}	
	
	function generateMail() {
	  if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	  else
	      $edmode = null; 		
	
      if ((defined("MAIL_DPC")) && (seclevel('MAIL_DPC',$this->userLevelID)) ) { 
	  
	    $t = GetReq('t');
		$a = GetReq('a');
		$g = GetReq('g');
		$p = GetReq('p');
	  
	    if (!GetReq('v')) {	//just generate link 	  
	      //$out = seturl("t=$t&a=$a&g=$g&p=$p&v=mail",'Mail') . "&nbsp;";
		  $out = seturl("t=mail&a=1".$edmode,'Mail') . "&nbsp;";//a=1 is the first window created (active)!!!!!
        }
		else { //create mail
		  DelReq('v'); //reset value for other browsing objects		
		}  
	  }
	  
	  return ($out);
	}	
	
	function viewall($viewtype,$class) {
	  if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	  else
	      $edmode = null; 		
	
      if (seclevel('ALLBROWSE_',$this->userLevelID)) {	
	  	
	    $t = GetReq('t');
		$a = GetReq('a');
		$g = GetReq('g');
		$p = GetReq('p');
	  
	    if (!GetReq('v')) {	//just generate link  
	      $out = seturl("t=$t&a=$a&g=$g&p=$p&v=all".$edmode,$this->alltitle) . "&nbsp;";
		}
		else { //generate all list
          $out = $this->browse_all_files($viewtype,$class);
		  DelReq('v'); //reset value for other browsing objects 
		}	
	  }
	  
	  return ($out);	  
	}
	
	function browse_advance($topic=0,$excel=0,$pdf=0,$mail=0,$all=0) {
	
		//search topic				
 	    if (($topic) && (seclevel('SEARCHTOPIC_',$this->userLevelID))) {
		  $data[] = $this->searchTopic();
		  $attr[] = "left;50%";
		}  
		
		//excel view				
 	    if (($excel) && (seclevel('EXCELBROWSE_',$this->userLevelID))) 
		  $cmds = $this->generateExcel();
		//pdf view				
 	    if (($pdf) && (seclevel('PDFBROWSE_',$this->userLevelID))) 
		  $cmds .= $this->generatePdf();
		//send mail				
 	    if (($mail) && (seclevel('MAILBROWSE_',$this->userLevelID))) 
		  $cmds .= $this->generateMail();
		//all list mail				
 	    if (($all) && (seclevel('ALLBROWSE_',$this->userLevelID)))  
		  $cmds .= $this->viewAll(null,null);
		
		$data[] = $cmds;
		$attr[] = "right;50%";  
					
	
        $swin = new window('',$data,$attr);
	    $out .= $swin->render("center::100%::0::group_dir_body::left::0::0::");	
	    unset ($swin);	
	  
	    return ($out);
	}
	
	
	
	function getpage($id){

      //print_r($array);
	  if ($id) {
	     $i=1;
		 $page=1;
         //ksort ($this->datalist,SORT_REGULAR);			 
		 reset($this->datalist);
         //while(list ($num, $data) = each ($this->datalist)) {
         foreach ($this->datalist as $num => $data) {	
		    $msplit = explode(";",$data); 
			
			if ( (stristr($msplit[0],$id)) || //code
			     (stristr($msplit[1],$id)) || //title
				 (stristr($msplit[6],$id)) || //descr
				 (stristr($msplit[8],$id))) { //price
				 
			     $a = $msplit[1];
				 SetReq('a',$msplit[1]);//NOT WORK
				 //$ret = floor(($i) / $this->pagenum);//+1;
				 //echo '++++',$i,'>',$ret,'>',$this->pagenum,'++++';
                 //echo $page;
			     return $page;//ret;
			}	 
			$i+=1; 
		    if ($i>($this->pagenum*$page)) $page+=1;//echo $page;			
		 }	  
	   }	 
	   return 1;
	}	
	
	//in form actions
    function admin_commands() {
      //global $__BROWSECOM;
	  //global $__DPC;
	  $__BROWSECOM = GetGlobal('__BROWSECOM');
	  $__DPC = GetGlobal('__DPC');	  
	  
	  if (is_array($__BROWSECOM)) {
	  
	    reset($__BROWSECOM);
	    foreach ($__BROWSECOM as $dpc_name => $func) {//print $func;
           if (defined($dpc_name)) {
			  $theclass = new $__DPC[$dpc_name];
              $out .= $theclass->$func();
			  unset ($theclass);
			}  
	    }
	    return $out;	 
	  }
    }		
	
	//after </form> actions
    function admin_actions() {
      //global $__BROWSEACT;
	  //global $__DPC;
	  $__BROWSEACT = GetGlobal('__BROWSEACT');
	  $__DPC = GetGlobal('__DPC');		  
	  
	  if (is_array($__BROWSEACT)) {
	  
	    reset($__BROWSEACT);
	    foreach ($__BROWSEACT as $dpc_name => $func) {//print $func;
           if (defined($dpc_name)) {
			  $theclass = new $__DPC[$dpc_name];
              $out .= $theclass->$func();
			  unset ($theclass);
		   }  
	    }
	    return $out;	 
	  }
    }	
   
};
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php

$__DPCSEC['SEARCHTOPIC_']='1;1;1;1;1;1;2;2;2;2;9';
$__DPCSEC['VIEWSTLS_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['ADMBROWSE_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['ALLBROWSE_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['PDFBROWSE_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['EXCELBROWSE_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['MAILBROWSE_']='1;1;1;1;1;1;1;1;1;2;9';
$__DPCSEC['PAGELENGTH_']='1;1;1;1;1;1;1;1;1;2;9';

if (!defined("BROWSER2_DPC")) {
define("BROWSER2_DPC",true);

$__DPC['BROWSER2_DPC'] = 'browse';

$__EVENTS['BROWSER2_DPC'][0]='searchtopic';
$__ACTIONS['BROWSER2_DPC'][0]='searchtopic';

$__DPCATTR['BROWSER_DPC']['searchtopic'] = 'searchtopic,0,0,0,0,0,1,0,0,1'; 

$__LOCALE['BROWSER2_DPC'][0]='_VIEWSTYLES;View styles;Μορφή';
$__LOCALE['BROWSER2_DPC'][1]='_SORT;Sort;Ταξ.';
$__LOCALE['BROWSER2_DPC'][2]='_PAGE;Page;Σελίδα';
$__LOCALE['BROWSER2_DPC'][3]='_EMPTYDIR;Not availbale products;Κανένα διαθέσιμο προϊόν';
$__LOCALE['BROWSER2_DPC'][4]='_NEXT;Next;Επόμενο';
$__LOCALE['BROWSER2_DPC'][5]='_PREV;Prev;Προηγούμενο';
$__LOCALE['BROWSER2_DPC'][6]='_BEGIN;Begin;Αρχή';
$__LOCALE['BROWSER2_DPC'][7]='_END;End;Τέλος';
$__LOCALE['BROWSER2_DPC'][8]='_ALLBROWSE;Show All;Προβολή Όλων';
$__LOCALE['BROWSER2_DPC'][9]='_SEARCH;Search;Αναζήτηση';
$__LOCALE['BROWSER2_DPC'][10]='_GROUPOF;Group;Ομαδα';

class browse {

	var $userLevelID;
    var $outpoint;
    var $rightarrow;
    var $view_on;
	var $home;
	var $pagedfiles;
	var $page;
	var $pagenum;
	var $title;
	var $datalist;
	var $sortmethod;
	var $defaultview;

    var $start_b;
    var $end_b;
	var $next_b;
    var $prev_b;
	var $selpage;
	var $stylearray;
	var $styler;
	var $columns;	
	
	var $dosearch;
	var $searchtext;
	
	var $timeout;
	
	var $alltitle;

	public function __construct($data='',$title='',$selpage=1,$styler="",$columns="") {
	    $UserSecID = GetGlobal('UserSecID');	
		$PL = GetReq('pl');

        $this->userLevelID = (((decode($UserSecID))) ? (decode($UserSecID)) : 0);
		
	    $this->searchtext = trim(GetParam("searcht"));	
		if (!$this->searchtext) $this->searchtext = GetReq('a'); //set $a as search topic
        if ($this->searchtext) $this->dosearch = 1; 
		                  else $this->dosearch = 0; 
		
        $this->datalist     = $data;       
        $this->title        = $title;
		$this->sortmethod   = GetSessionParam('sort'); 
		$this->pagedfiles   = array();
		$this->page         = 0;
		$this->pagenum      = ($PL ? $PL:10); //default
		$this->selpage      = $selpage;
		$this->columns      = $columns; //added due to a xml support
				
		$this->stylearray   = explode(",",$styler);
		$this->styler       = $styler;	
		
	    $this->timeout = paramload('SHELL','timeout');				 
		
        $this->outpoint = loadTheme('point');      
        $this->rightarrow = loadTheme('rarrow');
        $this->start_b = loadTheme('start',localize('_BEGIN',getlocal()));
        $this->end_b = loadTheme('end',localize('_END',getlocal()));
        $this->next_b = loadTheme('next',localize('_NEXT',getlocal()));
        $this->prev_b = loadTheme('prev',localize('_PREV',getlocal()));

   	    $this->alltitle = localize('_ALLBROWSE',getlocal());	
        	
    }
	
	public function render($viewtype=0,$pager,$class,$pagemaker=0,$topic=0,$sorter=0,$adminform=0,$excel=0,$pdf=0,$mail=0,$all=0) {

        if (is_array($this->datalist)) {
		    //set page length
			if ($pager) $this->pagenum = $pager;
            //sort files
		    $this->sort_files();
									
            if (($pagemaker) && (GetReq('param1')!='-all')) {
			    //get searched data
				$this->selpage = $this->getpage($this->searchtext);
			    //make pages		 
		        $this->read_pagefiles();
                //preview 
		        $out = $this->browse_files($viewtype,$class,$pagemaker,$topic,$sorter,$adminform,$excel,$pdf,$mail,$all);		
		    }
			else {
		        $out = $this->browse_all_files($viewtype,$class);
				$out .= $this->browse_advance($topic,$excel,$pdf,$mail,null);
			}  			   
		    return($out);
    	}
    }

    protected function read_pagefiles() {

		$meter = 0;
        $pnum = $this->pagenum;
			   
	    reset($this->datalist); //print_r($this->datalist);
        foreach ($this->datalist as $file_num => $filename) {	

			if ($meter >= $pnum) {
				$meter=0;
				$this->page+=1;
			}

			$this->pagedfiles[$this->page][$meter] = $filename; 
			$meter+=1;
		}

        reset ($this->datalist); 
        reset ($this->pagedfiles);

		return ($this->pagedfiles);
	}

    protected function browse_files($view,$class,$pagemaker,$topic,$sorter,$adminform,$excel,$pdf,$mail,$all) { 
		
		$t = GetReq('t');
		$p = GetReq('p'); 
     	$gr = urlencode(GetReq('g'));
		
        if (($adminform) && (seclevel('ADMBROWSE_',$this->userLevelID))) 
			$out = $this->admin_start();		

        if ($this->pagedfiles) {
		    		
            // view styles and sort method line
            if (count($this->stylearray)>1)  
				$vs = $this->viewStyles();
			if ($sorter) 
				$sv = $this->sortStyles();				  

			$winout .= $vs . $sv;
			
            //read current page array 
            if ($pagemaker) { 
		        if (!$p) $mypage=$this->selpage;
					else $mypage=$p; 
			    $realpage = ($mypage-1);				   
			}
			else 
			    $realpage=0;				 
			   
			$currentpagefiles = (array) $this->pagedfiles[$realpage];
		 
            if (method_exists($class,'headtitle')) 
			    $winout .= $class->headtitle($view);
		
		    if (method_exists($class,'browse')) {		
	            foreach ($currentpagefiles as $file_num => $filename) {	
			        $packdata = str_replace(";","||",$filename);
		            $winout .= $class->browse($packdata,$view);
                }
            }
			else 
			    die("Method 'browse' required !");	
			   				
			$out .= $winout;	 
	    } 
        else 
           $out = ''; 

        if (($adminform) && (seclevel('ADMBROWSE_',$this->userLevelID))) 
			$out .= $this->admin_end();
						
        $out .= $this->browse_advance($topic,$excel,$pdf,$mail,$all);									
		
		//view page browser
	    if ($pagemaker) 
			$out .= $this->pageBrowser($view);	
				 			 
		
        return ($out);
    }

	
    public function pageBrowser($view) {
		$gr = urlencode(GetReq('g'));		
	    $p = GetReq('p');	
		$pl = GetReq('pl');			
		$view = $view ? $view : GetReq('t'); 		

		$grouppager = 2;
        $ptext = localize('_PAGE',getlocal()) . " :";

        if ($this->page>0) {
			
			$template = _m('cmsrt.select_template use pagination-element');			

			//initialize page
			if (!$p) 
				$p = $this->selpage;
          
			$groupprev = (($p-1) - $grouppager); 
			if ($groupprev<=0) 
				$groupprev = 0;
			else 
				$markstart = "..."; 
			$groupnext = (($p-1) + $grouppager); 
			if ($groupnext>$this->page) 
				$groupnext = $this->page;
			else 
				$markend = "...";

			//prev buttons
			$prevpage = $p-1;
			//$data .= seturl("t=$view&a=&g=$gr&p=1&pl=$pl", $this->start_b) . "&nbsp;";
			$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=1&pl=$pl"),1=>'«'));
			if ($prevpage>0) 
				//$data .= seturl("t=$view&a=&g=$gr&p=$prevpage&pl=$pl", $this->prev_b);
			    $data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=$prevpage&pl=$pl"),1=>'&lt;'));
			else 
				$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=1"),1=>'&lt;'));
			
			//$data .= $markstart;
			//$data .= $this->combine_tokens($template, array(0=>'#',1=>$markstart));
			//$data .= " " . $this->outpoint . " ";

			for ($i=$groupprev; $i<=$groupnext; $i++) {
				$pp = $i+1;
				if ($pp==$p) 
					//$data .= seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl","<B>" . $pp . "</B>") . "&nbsp;" . $this->outpoint . "&nbsp;";
					$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl"),1=>$pp,2=>' class="current"'));
				else 
					//$data .= seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl",$pp) . "&nbsp;" . $this->outpoint . "&nbsp;";	
					$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=$pp&pl=$pl"),1=>$pp));

			}
			//$data .= $markend;
			//$data .= $this->combine_tokens($template, array(0=>'#',1=>$markend));
 
			//next buttons
			$nextpage = $p+1;
			if ($nextpage<=$this->page+1) 
				//$data .= seturl("t=$view&a=&g=$gr&p=$nextpage&pl=$pl" , $this->next_b);	
				$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=$nextpage&pl=$pl"),1=>'&gt;'));
			else 
				//$data .= $this->next_b; 
				$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=" . ($this->page+1)),1=>'&lt;'));
				
			//$data .= "&nbsp;" . seturl("t=$view&a=&g=$gr&p=" . ($this->page+1) . "&pl=$pl" , $this->end_b );
			$data .= $this->combine_tokens($template, array(0=>seturl("t=$view&a=&g=$gr&p=" . ($this->page+1) . "&pl=$pl"),1=>'»'));

			//buttons browser
			$mydata[] = $data;

			//page number
			$mydata[] = $ptext; 
			$mydata[] = $p;
			$mydata[] = $this->page+1;
			//$mydata[] = $this->pagelength();		  
		  
			$template = _m('cmsrt.select_template use pagination');
			$out = $this->combine_tokens($template, $mydata);
        }

		return ($out);
    }
	
	public function browse_all_files($view,$class) {
	
	    if (method_exists($class,'headtitle')) 
			 $winout .= $class->headtitle($view);	
		 
	    reset($this->datalist);
		 
		if (method_exists($class,'browse')) {						 
			foreach ($this->datalist as $rec_num => $rec) {
			    $packdata = str_replace(";","||",$rec);
		        $winout .= $class->browse($packdata,$view);
		    }
		}  
	
		return ($winout);	
	}

    public function viewStyles() {	

	    $g = GetReq('g');		
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a');		
		
        if (seclevel('VIEWSTLS_',$this->userLevelID)) {

          $vprint = localize('_VIEWSTYLES',getlocal()) . " :";

          foreach ($this->stylearray as $stylenum => $style) {		  
            if ($t==$style) $vprint .= "(".$style.")"; 
	                   else $vprint .= seturl("t=$t&a=$a&g=$g&p=$p&s=$style", $style); 
		  }
		}
  			
        return ($vprint);
    }
	
	//select page length (num of lines)
	protected function pagelength() {		
	    $g = GetReq('g');		
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a'); //not need??
	    $s = GetReq('s');
		$pl = GetReq('pl');		
		
          $vprint = localize('_GROUPOF',getlocal()) . " :";

          for ($i=1;$i<6;$i++) {		  
            if ($pl==($i*10)) 
			  $vprint .= "(".$pl.")"; 
	        else 
			  $vprint .= seturl("t=$t&a=$a&g=$g&p=1&s=$s&pl=".($i*10), "[".($i*10))."]"; 
		  }
  			
        return ($vprint);	
	}	

	protected function sortStyles() {		
		$gr = urlencode(GetReq('g'));
	    $p = GetReq('p');
	    $t = GetReq('t'); 				
	    $a = GetReq('a');
		$s = GetReq('s');		

        $vprint .= localize('_SORT',getlocal()) . " :";

        if ($this->sortmethod==1) $vprint .= seturl("t=$t&a=1&g=$gr&p=$p&s=$s", "<b>A</b>"); 
                             else $vprint .= seturl("t=$t&a=1&g=$gr&p=$p&s=$s","A"); 
        if ($this->sortmethod==-1) $vprint .= seturl("t=$t&a=-1&g=$gr&p=$p&s=$s", "<b>Z</b>"); 
    	                      else $vprint .= seturl("t=$t&a=-1&g=$gr&p=$p&s=$s","Z"); 			  
        return ($vprint);
	}

	protected function sort_files() {

        //sorting (article=selected sort method, saved as session param)
        //first sort by saved method (if saved)
        switch ($this->sortmethod) {
	       case "1"  : ksort ($this->datalist,SORT_REGULAR); break; //asc
	       case "-1" : krsort ($this->datalist,SORT_REGULAR); break; //desc
           default : ksort ($this->datalist); //asc
        }					
        //secont sort by selected method (if selected) and save sort
        switch (GetReq('a')) {
	       case 1  : ksort ($this->datalist,SORT_STRING); SetSessionParam("sort", "1"); break; //asc
	       case -1 : krsort ($this->datalist,SORT_STRING); SetSessionParam("sort", "-1"); break; //desc
           default : ksort ($this->datalist); //asc		   
        }  
   		$this->sortmethod = GetSessionParam('sort');

		//print_r($this->dfiles);
	}


    protected function admin_start() {
	   if (GetReq('editmode'))
	      $edmode = '&editmode=1';
	   else
	      $edmode = null; 		   
	   $gr = urlencode(GetReq('g'));
	   $ar = urlencode(GetReq('a'));
	   $p = GetReq('p');
	   $t = GetReq('t');   
       $filename = seturl("t=$t&a=$ar&g=$gr&p=$p".$edmode);		   
 
       $out = "<form action=". "$filename" . " method=post class=\"thin\">"; 
  
       return ($out);
    }

    protected function admin_end() {	   
	   $sFormErr = GetGlobal('sFormErr');
	   
       //error message
       $toprint .= setError($sFormErr);
	   $toprint .= $this->admin_commands();
	   $toprint .= "</form>"; 
	   $toprint .= $this->admin_actions();		   
  
       return ($toprint);
     }
 
    function searchTopic()  {		    
	  $t = GetReq('t');	
      $pl = GetReq('pl');	
	  $gr = urlencode(getReq('g')); 

      $filename = seturl("t=$t&a=&g=$gr&pl=$pl");      

      $toprint  = "<FORM action=". $filename . " method=post class=\"thin\">";
      $toprint .= "<P><FONT face=\"Arial, Helvetica, sans-serif\" size=1><STRONG>";
      $toprint .= localize('_SEARCH',getlocal()) . ":";
	  $toprint .= "</STRONG> <INPUT name=searcht size=15></FONT>";
      $toprint .= "<FONT face=\"Arial, Helvetica, sans-serif\" size=1>";

      $toprint .= "<input type=\"submit\" name=\"Submit\" value=\"Ok\">"; 
      $toprint .= "<input type=\"hidden\" name=\"FormAction\" value=\"searchtopic\">";
      $toprint .= "</FONT></FORM>";

      return ($toprint);	   
    }	
	
	
	protected function viewall($viewtype,$class) {

      if (seclevel('ALLBROWSE_',$this->userLevelID)) {	
	  	
	    $t = GetReq('t');
		$a = GetReq('a');
		$g = GetReq('g');
		$p = GetReq('p');
	  
	    if (!GetReq('v')) {	//just generate link  
	      $out = seturl("t=$t&a=$a&g=$g&p=$p&v=all",$this->alltitle) . "&nbsp;";
		}
		else { //generate all list
          $out = $this->browse_all_files($viewtype,$class);
		  DelReq('v'); //reset value for other browsing objects 
		}	
	  }
	  
	  return ($out);	  
	}
	
	public function browse_advance($topic=0,$excel=0,$pdf=0,$mail=0,$all=0) {
	
		//search topic				
 	    if (($topic) && (seclevel('SEARCHTOPIC_',$this->userLevelID))) 
		  $out = $this->searchTopic();

					
 	    if (($all) && (seclevel('ALLBROWSE_',$this->userLevelID)))  
		  $out .= $this->viewAll(null,null);
	  
	    return ($out);
	}
	
	function getpage($id){

      //print_r($array);
	  if ($id) {
	     $i=1;
		 $page=1;
         //ksort ($this->datalist,SORT_REGULAR);			 
		 reset($this->datalist);
         //while(list ($num, $data) = each ($this->datalist)) {
         foreach ($this->datalist as $num => $data) {	
		    $msplit = explode(";",$data); 
			
			if ( (stristr($msplit[0],$id)) || //code
			     (stristr($msplit[1],$id)) || //title
				 (stristr($msplit[6],$id)) || //descr
				 (stristr($msplit[8],$id))) { //price
				 
			     $a = $msplit[1];
				 SetReq('a',$msplit[1]);//NOT WORK
				 //$ret = floor(($i) / $this->pagenum);//+1;
				 //echo '++++',$i,'>',$ret,'>',$this->pagenum,'++++';
                 //echo $page;
			     return $page;//ret;
			}	 
			$i+=1; 
		    if ($i>($this->pagenum*$page)) $page+=1;//echo $page;			
		 }	  
	   }	 
	   return 1;
	}	
	
	//in form actions
    function admin_commands() {

	  $__BROWSECOM = GetGlobal('__BROWSECOM');
	  $__DPC = GetGlobal('__DPC');	  
	  
	  if (is_array($__BROWSECOM)) {
	  
	    reset($__BROWSECOM);
	    foreach ($__BROWSECOM as $dpc_name => $func) {//print $func;
           if (defined($dpc_name)) {
			  $theclass = new $__DPC[$dpc_name];
              $out .= $theclass->$func();
			  unset ($theclass);
			}  
	    }
	    return $out;	 
	  }
    }		
	
	//after </form> actions
    protected function admin_actions() {

	  $__BROWSEACT = GetGlobal('__BROWSEACT');
	  $__DPC = GetGlobal('__DPC');		  
	  
	  if (is_array($__BROWSEACT)) {
	  
	    reset($__BROWSEACT);
	    foreach ($__BROWSEACT as $dpc_name => $func) {//print $func;
           if (defined($dpc_name)) {
			  $theclass = new $__DPC[$dpc_name];
              $out .= $theclass->$func();
			  unset ($theclass);
		   }  
	    }
	    return $out;	 
	  }
    }

	protected function combine_tokens(&$template_contents, $tokens, $execafter=null) {
	    if (!is_array($tokens)) return;
		
		if ((!$execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$ret = $fp->process_commands($template_contents);
			unset ($fp);		  		
		}		  		
		else
			$ret = $template_contents;
		  
	    foreach ($tokens as $i=>$tok) {
		    $ret = str_replace("$".$i."$",$tok,$ret);
	    }

		for ($x=$i;$x<40;$x++)
			$ret = str_replace("$".$x."$",'',$ret);
		
		if (($execafter) && (defined('FRONTHTMLPAGE_DPC'))) {
			$fp = new fronthtmlpage(null);
			$retout = $fp->process_commands($ret);
			unset ($fp);
          
			return ($retout);
		}		
		
		return ($ret);
	}		
   
};
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php /* $Id: CronParser.php,v 1.7 2005/09/12 01:04:05 ns Exp $ */

/**####################################################################################################**\
   Version: V1.01
   Release Date: 12 Sep 2005
   Licence: GPL
   By: Nikol S
   Please send bug reports to ns@eyo.com.au
\**####################################################################################################**/

/* This class is based on the concept in the CronParser class written by Mick Sear http://www.ecreate.co.uk
 * The following functions are direct copies from or based on the original class:
 * getLastRan(), getDebug(), debug(), expand_ranges()
 *
 * Who can use this class?
 * This class is idea for people who can not use the traditional Unix cron through shell.
 * One way of using is embedding the calling script in a web page which is often visited.
 * The script will work out the last due time, by comparing with run log timestamp. The scrip
 * will envoke any scripts needed to run, be it deleting older table records, or updating prices.
 * It can parse the same cron string used by Unix.
 */

/* Usage example:

$cron_str0 = "0,12,30-51 3,21-23,10 1-25 9-12,1 0,3-7";
require_once("CronParser.php");
$cron = new CronParser();
$cron->calcLastRan($cron_str0);
// $cron->getLastRanUnix() returns an Unix timestamp
echo "Cron '$cron_str0' last due at: " . date('r', $cron->getLastRanUnix()) . "<p>";
// $cron->getLastRan() returns last due time in an array
print_r($cron->getLastRan());
echo "Debug:<br>" . nl2br($cron->getDebug());

$cron_str1 = "3 12 * * *";
if ($cron->calcLastRan($cron_str1))
{
   echo "<p>Cron '$cron_str1' last due at: " . date('r', $cron->getLastRanUnix()) . "<p>";
   print_r($cron->getLastRan());
}
else
{
   echo "Error parsing";
}
echo "Debug:<br>" . nl2br($cron->getDebug());

 *#######################################################################################################
 */

class CronParser {
 	var $bits = Array(); //exploded String like 0 1 * * *
 	var $now = Array();	//Array of cron-style entries for time()
 	var $lastRan; 		//Timestamp of last ran time.
 	var $taken;
 	var $debug;
	var $year;
	var $month;
	var $day;
	var $hour;
	var $minute;
	var $minutes_arr = array();	//minutes array based on cron string
	var $hours_arr = array();	//hours array based on cron string
	var $months_arr = array();	//months array based on cron string

	function CronParser($cronString = '') {
		if (!empty($cronString)) $this->calcLastRan($cronString);
	}	
	
	function getLastRan() {
		return explode(",", strftime("%M,%H,%d,%m,%w,%Y", $this->lastRan)); //Get the values for now in a format we can use
	}

	function getLastRanUnix() {
		return $this->lastRan;
	}

	function getDebug() {
 		return $this->debug;
	}

	function debug($str) {
		if (is_array($str)) {
			$this->debug .= "\nArray: ";
			foreach($str as $k=>$v) {
				$this->debug .= "$k=>$v, ";
			}

		} else {
			$this->debug .= "\n$str";
		}
	}

	/**
	 * Assumes that value is not *, and creates an array of valid numbers that
	 * the string represents.  Returns an array.
	 */
	function expand_ranges($str) {
		if (strstr($str,  ",")) {
			$arParts = explode(',', $str);
			foreach ($arParts AS $part) {
				if (strstr($part, '-')) {
					$arRange = explode('-', $part);
					for ($i = $arRange[0]; $i <= $arRange[1]; $i++) {
						$ret[] = $i;
					}
				} else {
					$ret[] = $part;
				}
			}
		} elseif (strstr($str,  '-')) {
			$arRange = explode('-', $str);
			for ($i = $arRange[0]; $i <= $arRange[1]; $i++) {
				$ret[] = $i;
			}
		} else {
			$ret[] = $str;
		}
		$ret = array_unique($ret);
		sort($ret);
		return $ret;
	}

	function daysinmonth($month, $year) {
		return date('t', mktime(0, 0, 0, $month, 1, $year));
	}

	/**
	 *  Calculate the last due time before this moment
	 */
	function calcLastRan($string) {

 		$tstart = microtime();
		$this->debug = "";
		$this->lastRan = 0;
		$this->year = NULL;
		$this->month = NULL;
		$this->day = NULL;
		$this->hour = NULL;
		$this->minute = NULL;
		$this->hours_arr = array();
		$this->minutes_arr = array();
		$this->months_arr = array();

		$string = preg_replace('/[\s]{2,}/', ' ', $string);

		if (preg_match('/[^-,* \\d]/', $string) !== 0) {
			$this->debug("Cron String contains invalid character");
			return false;
		}

		$this->debug("<b>Working on cron schedule: $string</b>");
 		$this->bits = @explode(" ", $string);

		if (count($this->bits) != 5) {
			$this->debug("Cron string is invalid. Too many or too little sections after explode");
			return false;
		}

		//put the current time into an array
		$t = strftime("%M,%H,%d,%m,%w,%Y", time());
		$this->now = explode(",", $t);

		$this->year = $this->now[5];

		$arMonths = $this->_getMonthsArray();

		do {
			$this->month = array_pop($arMonths);
		} while ($this->month > $this->now[3]);

		if ($this->month === NULL) {
			$this->year = $this->year - 1;
			$this->debug("Not due within this year. So checking the previous year " . $this->year);
			$arMonths = $this->_getMonthsArray();
			$this->_prevMonth($arMonths);
		} elseif ($this->month == $this->now[3]) { //now Sep, month = array(7,9,12)
			$this->debug("Cron is due this month, getting days array.");
			$arDays = $this->_getDaysArray($this->month, $this->year);

			do {
				$this->day = array_pop($arDays);
			} while ($this->day > $this->now[2]);

			if ($this->day === NULL) {
				$this->debug("Smallest day is even greater than today");
				$this->_prevMonth($arMonths);
			} elseif ($this->day == $this->now[2]) {
				$this->debug("Due to run today");
				$arHours = $this->_getHoursArray();

				do {
					$this->hour = array_pop($arHours);
				}
				while ($this->hour > $this->now[1]);

				if ($this->hour === NULL) { // now =2, arHours = array(3,5,7)
					$this->debug("Not due this hour and some earlier hours, so go for previous day");
					$this->_prevDay($arDays, $arMonths);
				} elseif ($this->hour < $this->now[1]) { //now =2, arHours = array(1,3,5)
					$this->minute = $this->_getLastMinute();
				}
				else { // now =2, arHours = array(1,2,5)
					$this->debug("Due this hour");
					$arMinutes = $this->_getMinutesArray();
					do {
						$this->minute = array_pop($arMinutes);
					} while ($this->minute > $this->now[0]);

					if ($this->minute === NULL) {
						$this->debug("Not due this minute, so go for previous hour.");
						$this->_prevHour($arHours, $arDays, $arMonths);
					} else {
						$this->debug("Due this very minute or some earlier minutes before this moment within this hour.");
					}
				}
			} else {
				$this->debug("Cron was due on " . $this->day . " of this month");
				$this->hour = $this->_getLastHour();
				$this->minute = $this->_getLastMinute();
			}
		} else { //now Sep, arrMonths=array(7, 10)
			$this->debug("Cron was due before this month. Previous month is: " . $this->year . '-' . $this->month);
			$this->day = $this->_getLastDay($this->month, $this->year);
			if ($this->day === NULL) {
				//No scheduled date within this month. So we will try the previous month in the month array
				$this->_prevMonth($arMonths);
			} else {
				$this->hour = $this->_getLastHour();
				$this->minute = $this->_getLastMinute();
			}
		}

		$tend = microtime();
		$this->taken = $tend - $tstart;
		$this->debug("Parsing $string taken " . $this->taken . " seconds");

		//if the last due is beyond 1970
		if ($this->minute === NULL) {
			$this->debug("Error calculating last due time");
			return false;
		} else {
			$this->debug("LAST DUE: " . $this->hour . ":" . $this->minute . " on " . $this->day . "/" . $this->month . "/" . $this->year);
			$this->lastRan = mktime($this->hour, $this->minute, 0, $this->month, $this->day, $this->year);
			return true;
		}
	}

	//get the due time before current month
	function _prevMonth($arMonths) {
		$this->month = array_pop($arMonths);
		if ($this->month === NULL) {
			$this->year = $this->year -1;
			if ($this->year <= 1970) {
				$this->debug("Can not calculate last due time. At least not before 1970..");
			} else {
				$this->debug("Have to go for previous year " . $this->year);
				$arMonths = $this->_getMonthsArray();
				$this->_prevMonth($arMonths);
			}
		} else {
			$this->debug("Getting the last day for previous month: " . $this->year . '-' . $this->month);
			$this->day = $this->_getLastDay($this->month, $this->year);

			if ($this->day === NULL) {
				//no available date schedule in this month
				$this->_prevMonth($arMonths);
			} else {
				$this->hour = $this->_getLastHour();
				$this->minute = $this->_getLastMinute();
			}
		}

	}

	//get the due time before current day
	function _prevDay($arDays, $arMonths) {
		$this->debug("Go for the previous day");
		$this->day = array_pop($arDays);
		if ($this->day === NULL) {
			$this->debug("Have to go for previous month");
			$this->_prevMonth($arMonths);
		} else {
			$this->hour = $this->_getLastHour();
			$this->minute = $this->_getLastMinute();
		}
	}

	//get the due time before current hour
	function _prevHour($arHours, $arDays, $arMonths) {
		$this->debug("Going for previous hour");
		$this->hour = array_pop($arHours);
		if ($this->hour === NULL) {
			$this->debug("Have to go for previous day");
			$this->_prevDay($arDays, $arMonths);
		} else {
			$this->minute = $this->_getLastMinute();
		}
	}

	//not used at the moment
	function _getLastMonth() {
		$months = $this->_getMonthsArray();
		$month = array_pop($months);

		return $month;
	}

	function _getLastDay($month, $year) {
		//put the available days for that month into an array
		$days = $this->_getDaysArray($month, $year);
		$day = array_pop($days);

		return $day;
	}

	function _getLastHour() {
		$hours = $this->_getHoursArray();
		$hour = array_pop($hours);

		return $hour;
	}

	function _getLastMinute() {
		$minutes = $this->_getMinutesArray();
		$minute = array_pop($minutes);

		return $minute;
	}

	//remove the out of range array elements. $arr should be sorted already and does not contain duplicates
	function _sanitize ($arr, $low, $high) {
		$count = count($arr);
		for ($i = 0; $i <= ($count - 1); $i++) {
			if ($arr[$i] < $low) {
				$this->debug("Remove out of range element. {$arr[$i]} is outside $low - $high");
				unset($arr[$i]);
			} else {
				break;
			}
		}

		for ($i = ($count - 1); $i >= 0; $i--) {
			if ($arr[$i] > $high) {
				$this->debug("Remove out of range element. {$arr[$i]} is outside $low - $high");
				unset ($arr[$i]);
			} else {
				break;
			}
		}

		//re-assign keys
		sort($arr);
		return $arr;
	}

	//given a month/year, list all the days within that month fell into the week days list.
	function _getDaysArray($month, $year = 0) {
		if ($year == 0) {
			$year = $this->year;
		}

		$days = array();

		//return everyday of the month if both bit[2] and bit[4] are '*'
		if ($this->bits[2] == '*' AND $this->bits[4] == '*') {
			$days = $this->getDays($month, $year);
		} else {
			//create an array for the weekdays
			if ($this->bits[4] == '*') {
				for ($i = 0; $i <= 6; $i++) {
					$arWeekdays[] = $i;
				}
			} else {
				$arWeekdays = $this->expand_ranges($this->bits[4]);
				$arWeekdays = $this->_sanitize($arWeekdays, 0, 7);

				//map 7 to 0, both represents Sunday. Array is sorted already!
				if (in_array(7, $arWeekdays)) {
					if (in_array(0, $arWeekdays)) {
						array_pop($arWeekdays);
					} else {
						$tmp[] = 0;
						array_pop($arWeekdays);
						$arWeekdays = array_merge($tmp, $arWeekdays);
					}
				}
			}
			$this->debug("Array for the weekdays");
			$this->debug($arWeekdays);

			if ($this->bits[2] == '*') {
				$daysmonth = $this->getDays($month, $year);
			} else {
				$daysmonth = $this->expand_ranges($this->bits[2]);
				// so that we do not end up with 31 of Feb
				$daysinmonth = $this->daysinmonth($month, $year);
				$daysmonth = $this->_sanitize($daysmonth, 1, $daysinmonth);
			}

			//Now match these days with weekdays
			foreach ($daysmonth AS $day) {
				$wkday = date('w', mktime(0, 0, 0, $month, $day, $year));
				if (in_array($wkday, $arWeekdays)) {
					$days[] = $day;
				}
			}
		}
		$this->debug("Days array matching weekdays for $year-$month");
		$this->debug($days);
		return $days;
	}

	//given a month/year, return an array containing all the days in that month
	function getDays($month, $year) {
		$daysinmonth = $this->daysinmonth($month, $year);
		$this->debug("Number of days in $year-$month : $daysinmonth");
		$days = array();
		for ($i = 1; $i <= $daysinmonth; $i++) {
			$days[] = $i;
		}
		return $days;
	}

	function _getHoursArray() {
		if (empty($this->hours_arr)) {
			$hours = array();

			if ($this->bits[1] == '*') {
				for ($i = 0; $i <= 23; $i++) {
					$hours[] = $i;
				}
			} else {
				$hours = $this->expand_ranges($this->bits[1]);
				$hours = $this->_sanitize($hours, 0, 23);
			}

			$this->debug("Hour array");
			$this->debug($hours);
			$this->hours_arr = $hours;
		}
		return $this->hours_arr;
	}

	function _getMinutesArray() {
		if (empty($this->minutes_arr)) {
			$minutes = array();

			if ($this->bits[0] == '*') {
				for ($i = 0; $i <= 60; $i++) {
					$minutes[] = $i;
				}
			} else {
				$minutes = $this->expand_ranges($this->bits[0]);
				$minutes = $this->_sanitize($minutes, 0, 59);
			}
			$this->debug("Minutes array");
			$this->debug($minutes);
			$this->minutes_arr = $minutes;
		}
		return $this->minutes_arr;
	}

	function _getMonthsArray() {
		if (empty($this->months_arr)) {
			$months = array();
			if ($this->bits[3] == '*') {
				for ($i = 1; $i <= 12; $i++) {
					$months[] = $i;
				}
			} else {
				$months = $this->expand_ranges($this->bits[3]);
				$months = $this->_sanitize($months, 1, 12);
			}
			$this->debug("Months array");
			$this->debug($months);
			$this->months_arr = $months;
		}
		return $this->months_arr;
	}

}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php

// Based on <https://github.com/mecha-cms/extend.minify>

/**

https://gist.github.com/tovic/d7b310dea3b33e4732c0

// HTML Minifier
function minify_html(input) {
    return input
    .replace(/<\!--(?!\[if)([\s\S]+?)-->/g, "") // Remove HTML comments except IE comments
    .replace(/>[^\S ]+/g, '>')
    .replace(/[^\S ]+</g, '<')
    .replace(/>\s{2,}</g, '><');
}
// Test
alert(minify_html('<div>      <span><a href="">test</a> <span></span>\t</span>  \t\r\n\n\n\n\t\t       </div>'));


$str = file_get_contents('p­ath/to/style.css');
// echo
echo minify_css($str);
//­ save as `style.min.css`
file_put_contents('path­/to/style.min.css', minify_css($str));


<style>
<?php echo minify_css(file_get_contents('p­ath/to/style.css')); ?>
</style>

<script>
<?php echo minify_js(file_get_contents('p­ath/to/engine.js')); ?>
</script>


Example with Output Buffer
include 'path/to/php-html-css-js-minifier.php';
ob_start('minify_html');
<!-- HTML code goes here ... -->
<?php echo ob_get_clean(); ?>



*/

define('MINIFY_STRING', '"(?:[^"\\\]|\\\.)*"|\'(?:[^\'\\\]|\\\.)*\'');
define('MINIFY_COMMENT_CSS', '/\*[\s\S]*?\*/');
define('MINIFY_COMMENT_HTML', '<!\-{2}[\s\S]*?\-{2}>');
define('MINIFY_COMMENT_JS', '//[^\n]*');
define('MINIFY_PATTERN_JS', '/[^\n]+?/[gimuy]*');
define('MINIFY_HTML', '<[!/]?[a-zA-Z\d:.-]+[\s\S]*?>');
define('MINIFY_HTML_ENT', '&(?:[a-zA-Z\d]+|\#\d+|\#x[a-fA-F\d]+);');
define('MINIFY_HTML_KEEP', '<pre(?:\s[^<>]*?)?>[\s\S]*?</pre>|<code(?:\s[^<>]*?)?>[\s\S]*?</code>|<script(?:\s[^<>]*?)?>[\s\S]*?</script>|<style(?:\s[^<>]*?)?>[\s\S]*?</style>|<textarea(?:\s[^<>]*?)?>[\s\S]*?</textarea>');

// get URL
$protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] === 443 ? 'https' : 'http') . '://';
$host = isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : (isset($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : "");
$url = $protocol . $host;

// escape character
define('X', "\x1A");

// normalize line–break(s)
function n($s) {
    return str_replace(["\r\n", "\r"], "\n", $s);
}

// trim once
function t($a, $b) {
    if ($a && strpos($a, $b) === 0 && substr($a, -strlen($b)) === $b) {
        return substr(substr($a, strlen($b)), 0, -strlen($b));
    }
    return $a;
}

function fn_minify($pattern, $input) {
    return preg_split('#(' . implode('|', $pattern) . ')#', $input, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE);
}

function fn_minify_css($input, $comment = 2, $quote = 2) {
    if (!is_string($input) || !$input = n(trim($input))) return $input;
    $output = $prev = "";
    foreach (fn_minify([MINIFY_COMMENT_CSS, MINIFY_STRING], $input) as $part) {
        if (trim($part) === "") continue;
        if ($comment !== 1 && strpos($part, '/*') === 0 && substr($part, -2) === '*/') {
            if (
                $comment === 2 && (
                    // Detect special comment(s) from the third character. It should be a `!` or `*` → `/*! keep */` or `/** keep */`
                    strpos('*!', $part[2]) !== false ||
                    // Detect license comment(s) from the content. It should contains character(s) like `@license`
                    stripos($part, '@licence') !== false || // noun
                    stripos($part, '@license') !== false || // verb
                    stripos($part, '@preserve') !== false
                )
            ) {
                $output .= $part;
            }
            continue;
        }
        if ($part[0] === '"' && substr($part, -1) === '"' || $part[0] === "'" && substr($part, -1) === "'") {
            // Remove quote(s) where possible …
            $q = $part[0];
            if (
                $quote !== 1 && (
                    // <https://www.w3.org/TR/CSS2/syndata.html#uri>
                    substr($prev, -4) === 'url(' && preg_match('#\burl\($#', $prev) ||
                    // <https://www.w3.org/TR/CSS2/syndata.html#characters>
                    substr($prev, -1) === '=' && preg_match('#^' . $q . '[a-zA-Z_][\w-]*?' . $q . '$#', $part)
                )
            ) {
                $part = t($part, $q); // trim quote(s)
            }
            $output .= $part;
        } else {
            $output .= fn_minify_css_union($part);
        }
        $prev = $part;
    }
    return trim($output);
}

function fn_minify_css_union($input) {
    if (stripos($input, 'calc(') !== false) {
        // Keep important white–space(s) in `calc()`
        $input = preg_replace_callback('#\b(calc\()\s*(.*?)\s*\)#i', function($m) {
            return $m[1] . preg_replace('#\s+#', X, $m[2]) . ')';
        }, $input);
    }
    $input = preg_replace([
        // Fix case for `#foo<space>[bar="baz"]`, `#foo<space>*` and `#foo<space>:first-child` [^1]
        '#(?<=[\w])\s+(\*|\[|:[\w-]+)#',
        // Fix case for `[bar="baz"]<space>.foo`, `*<space>.foo`, `:nth-child(2)<space>.foo` and `@media<space>(foo: bar)<space>and<space>(baz: qux)` [^2]
        '#([*\]\)])\s+(?=[\w\#.])#', '#\b\s+\(#', '#\)\s+\b#',
        // Minify HEX color code … [^3]
        '#\#([a-f\d])\1([a-f\d])\2([a-f\d])\3\b#i',
        // Remove white–space(s) around punctuation(s) [^4]
        '#\s*([~!@*\(\)+=\{\}\[\]:;,>\/])\s*#',
        // Replace zero unit(s) with `0` [^5]
        '#\b(?:0\.)?0([a-z]+\b)#i',
        // Replace `0.6` with `.6` [^6]
        '#\b0+\.(\d+)#',
        // Replace `:0 0`, `:0 0 0` and `:0 0 0 0` with `:0` [^7]
        '#:(0\s+){0,3}0(?=[!,;\)\}]|$)#',
        // Replace `background(?:-position)?:(0|none)` with `background$1:0 0` [^8]
        '#\b(background(?:-position)?):(?:0|none)([;,\}])#i',
        // Replace `(border(?:-radius)?|outline):none` with `$1:0` [^9]
        '#\b(border(?:-radius)?|outline):none\b#i',
        // Remove empty selector(s) [^10]
        '#(^|[\{\}])(?:[^\{\}]+)\{\}#',
        // Remove the last semi–colon and replace multiple semi–colon(s) with a semi–colon [^11]
        '#;+([;\}])#',
        // Replace multiple white–space(s) with a space [^12]
        '#\s+#'
    ], [
        // [^1]
        X . '$1',
        // [^2]
        '$1' . X, X . '(', ')' . X,
        // [^3]
        '#$1$2$3',
        // [^4]
        '$1',
        // [^5]
        '0',
        // [^6]
        '.$1',
        // [^7]
        ':0',
        // [^8]
        '$1:0 0$2',
        // [^9]
        '$1:0',
        // [^10]
        '$1',
        // [^11]
        '$1',
        // [^12]
        ' '
    ], $input);
    return trim(str_replace(X, ' ', $input));
}

function fn_minify_html($input, $comment = 2, $quote = 1) {
    if (!is_string($input) || !$input = n(trim($input))) return $input;
    $output = $prev = "";
    foreach (fn_minify([MINIFY_COMMENT_HTML, MINIFY_HTML_KEEP, MINIFY_HTML, MINIFY_HTML_ENT], $input) as $part) {
        if ($part === "\n") continue;
        if ($part !== ' ' && trim($part) === "" || $comment !== 1 && strpos($part, '<!--') === 0) {
            // Detect IE conditional comment(s) by its closing tag …
            if ($comment === 2 && substr($part, -12) === '<![endif]-->') {
                $output .= $part;
            }
            continue;
        }
        if ($part[0] === '<' && substr($part, -1) === '>') {
            $output .= fn_minify_html_union($part, $quote);
        } else if ($part[0] === '&' && substr($part, -1) === ';' && $part !== '&lt;' && $part !== '&gt;' && $part !== '&amp;') {
            $output .= html_entity_decode($part); // Evaluate HTML entit(y|ies)
        } else {
            $output .= preg_replace('#\s+#', ' ', $part);
        }
        $prev = $part;
    }
    $output = str_replace(' </', '</', $output);
    // Force space with `&#x0020;` and line–break with `&#x000A;`
    return str_ireplace(['&#x0020;', '&#x20;', '&#x000A;', '&#xA;'], [' ', ' ', "\n", "\n"], trim($output));
}

function fn_minify_html_union($input, $quote) {
    if (
        strpos($input, ' ') === false &&
        strpos($input, "\n") === false &&
        strpos($input, "\t") === false
    ) return $input;
    global $url;
    return preg_replace_callback('#<\s*([^\/\s]+)\s*(?:>|(\s[^<>]+?)\s*>)#', function($m) use($quote, $url) {
        if (isset($m[2])) {
            // Minify inline CSS(s)
            if (stripos($m[2], ' style=') !== false) {
                $m[2] = preg_replace_callback('#( style=)([\'"]?)(.*?)\2#i', function($m) {
                    return $m[1] . $m[2] . fn_minify_css($m[3]) . $m[2];
                }, $m[2]);
            }
            // Minify URL(s)
            if (strpos($m[2], '://') !== false) {
                $m[2] = str_replace([
                    $url . '/',
                    $url . '?',
                    $url . '&',
                    $url . '#',
                    $url . '"',
                    $url . "'"
                ], [
                    '/',
                    '?',
                    '&',
                    '#',
                    '/"',
                    "/'"
                ], $m[2]);
            }
            $a = 'a(sync|uto(focus|play))|c(hecked|ontrols)|d(efer|isabled)|hidden|ismap|loop|multiple|open|re(adonly|quired)|s((cop|elect)ed|pellcheck)';
            $a = '<' . $m[1] . preg_replace([
                // From `a="a"`, `a='a'`, `a="true"`, `a='true'`, `a=""` and `a=''` to `a` [^1]
                '#\s(' . $a . ')(?:=([\'"]?)(?:true|\1)?\2)#i',
                // Remove extra white–space(s) between HTML attribute(s) [^2]
                '#\s*([^\s=]+?)(=(?:\S+|([\'"]?).*?\3)|$)#',
                // From `<img />` to `<img/>` [^3]
                '#\s+\/$#'
            ], [
                // [^1]
                ' $1',
                // [^2]
                ' $1$2',
                // [^3]
                '/'
            ], str_replace("\n", ' ', $m[2])) . '>';
            return $quote !== 1 ? fn_minify_html_union_attr($a) : $a;
        }
        return '<' . $m[1] . '>';
    }, $input);
}

function fn_minify_html_union_attr($input) {
    if (strpos($input, '=') === false) return $input;
    return preg_replace_callback('#=(' . MINIFY_STRING . ')#', function($m) {
        $q = $m[1][0];
        if (strpos($m[1], ' ') === false && preg_match('#^' . $q . '[a-zA-Z_][\w-]*?' . $q . '$#', $m[1])) {
            return '=' . t($m[1], $q);
        }
        return $m[0];
    }, $input);
}

function fn_minify_js($input, $comment = 2, $quote = 2) {
    if (!is_string($input) || !$input = n(trim($input))) return $input;
    $output = $prev = "";
    foreach (fn_minify([MINIFY_COMMENT_CSS, MINIFY_STRING, MINIFY_COMMENT_JS, MINIFY_PATTERN_JS], $input) as $part) {
        if (trim($part) === "") continue;
        if ($comment !== 1 && (
            substr($part, 0, 2) === '//' || // Remove inline comment(s)
            strpos($part, '/*') === 0 && substr($part, -2) === '*/'
        )) {
            if (
                $comment === 2 && (
                    // Detect special comment(s) from the third character. It should be a `!` or `*` → `/*! keep */` or `/** keep */`
                    strpos('*!', $part[2]) !== false ||
                    // Detect license comment(s) from the content. It should contains character(s) like `@license`
                    stripos($part, '@licence') !== false || // noun
                    stripos($part, '@license') !== false || // verb
                    stripos($part, '@preserve') !== false
                )
            ) {
                $output .= $part;
            }
            continue;
        }
        if ($part[0] === '"' && substr($part, -1) === '"' || $part[0] === "'" && substr($part, -1) === "'") {
            // TODO: Remove quote(s) where possible …
            $output .= $part;
        } else {
            $output .= fn_minify_js_union($part);
        }
        $prev = $part;
    }
    return $output;
}

function fn_minify_js_union($input) {
    return preg_replace([
        // Remove white–space(s) around punctuation(s) [^1]
        '#\s*([!%&*\(\)\-=+\[\]\{\}|;:,.<>?\/])\s*#',
        // Remove the last semi–colon and comma [^2]
        '#[;,]([\]\}])#',
        // Replace `true` with `!0` and `false` with `!1` [^3]
        '#\btrue\b#', '#\bfalse\b#', '#\b(return\s?)\s*\b#',
        // Replace `new Array(x)` with `[x]` … [^4]
        '#\b(?:new\s+)?Array\((.*?)\)#', '#\b(?:new\s+)?Object\((.*?)\)#'
    ], [
        // [^1]
        '$1',
        // [^2]
        '$1',
        // [^3]
        '!0', '!1', '$1',
        // [^4]
        '[$1]', '{$1}'
    ], $input);
}


/**
 * Backward Compatibility
 * ----------------------
 */

function minify_css(...$lot) {
    return fn_minify_css(...$lot);
}

function minify_html(...$lot) {
    return fn_minify_html(...$lot);
}

function minify_js(...$lot) {
    return fn_minify_js(...$lot);
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
if (!defined("SCAPTCHA_DPC")) {
define("SCAPTCHA_DPC",true);

$__DPC['SCAPTCHA_DPC'] = 'scaptcha';

class scaptcha {
	
	var $bg_path, $font_path, $captcha_config;
	
	public function __construct() {
		
		$this->bg_path = getcwd() . '/images/captcha/backgrounds/';
		$this->font_path = getcwd() . '/images/captcha/fonts/';		
		
		// Default values
		$this->captcha_config = array(
        'code' => '',
        'min_length' => 5,
        'max_length' => 5,
        'backgrounds' => array(
            $this->bg_path . '45-degree-fabric.png',
            $this->bg_path . 'cloth-alike.png',
            $this->bg_path . 'grey-sandbag.png',
            $this->bg_path . 'kinda-jean.png',
            $this->bg_path . 'polyester-lite.png',
            $this->bg_path . 'stitched-wool.png',
            $this->bg_path . 'white-carbon.png',
            $this->bg_path . 'white-wave.png'
        ),
        'fonts' => array(
            $this->font_path . 'times_new_yorker.ttf'
        ),
        'characters' => 'ABCDEFGHJKLMNPRSTUVWXYZabcdefghjkmnprstuvwxyz23456789',
        'min_font_size' => 28,
        'max_font_size' => 28,
        'color' => '#666',
        'angle_min' => 0,
        'angle_max' => 10,
        'shadow' => true,
        'shadow_color' => '#fff',
        'shadow_offset_x' => -1,
        'shadow_offset_y' => 1
		);		
	}
	
	public function captchaInit($config = array()) {
		
		// Overwrite defaults with custom config values
		if( is_array($config) ) {
			foreach( $config as $key => $value ) $this->captcha_config[$key] = $value;
		}	

		// Restrict certain values
		if( $this->captcha_config['min_length'] < 1 ) $this->captcha_config['min_length'] = 1;
		if( $this->captcha_config['angle_min'] < 0 ) $this->captcha_config['angle_min'] = 0;
		if( $this->captcha_config['angle_max'] > 10 ) $this->captcha_config['angle_max'] = 10;
		if( $this->captcha_config['angle_max'] < $this->captcha_config['angle_min'] ) $this->captcha_config['angle_max'] = $this->captcha_config['angle_min'];
		if( $this->captcha_config['min_font_size'] < 10 ) $this->captcha_config['min_font_size'] = 10;
		if( $this->captcha_config['max_font_size'] < $this->captcha_config['min_font_size'] ) $this->captcha_config['max_font_size'] = $this->captcha_config['min_font_size'];

		// Generate CAPTCHA code if not set by user
		if( empty($this->captcha_config['code']) ) {
			$this->captcha_config['code'] = '';
			$length = mt_rand($this->captcha_config['min_length'], $this->captcha_config['max_length']);
			while( strlen($this->captcha_config['code']) < $length ) {
				$this->captcha_config['code'] .= substr($this->captcha_config['characters'], mt_rand() % (strlen($this->captcha_config['characters'])), 1);
			}
		}

		// Generate HTML for image src
		/*if ( strpos($_SERVER['SCRIPT_FILENAME'], $_SERVER['DOCUMENT_ROOT']) ) {
			$image_src = substr(__FILE__, strlen( realpath($_SERVER['DOCUMENT_ROOT']) )) . '?_CAPTCHA&amp;t=' . urlencode(microtime());
			$image_src = '/' . ltrim(preg_replace('/\\\\/', '/', $image_src), '/');
		} else {
			$_SERVER['WEB_ROOT'] = str_replace($_SERVER['SCRIPT_NAME'], '', $_SERVER['SCRIPT_FILENAME']);
			$image_src = substr(__FILE__, strlen( realpath($_SERVER['WEB_ROOT']) )) . '?_CAPTCHA&amp;t=' . urlencode(microtime());
			$image_src = '/' . ltrim(preg_replace('/\\\\/', '/', $image_src), '/');
		}

		$_SESSION['_CAPTCHA']['config'] = serialize($this->captcha_config);
		
		//print_r($this->captcha_config);
		//echo $image
		return array(
			'code' => $this->captcha_config['code'],
			'image_src' => $image_src
		);*/
		return 	$this->captcha_config['code'];
	}
	
	public function captchaImage() {
		// Draw the image
		//if( isset($_GET['_CAPTCHA']) ) {

			//session_start();

			$captcha_config = $this->captcha_config; //unserialize($_SESSION['_CAPTCHA']['config']);
			if( !$captcha_config ) exit();

			//unset($_SESSION['_CAPTCHA']);

			// Pick random background, get info, and start captcha
			$background = $captcha_config['backgrounds'][mt_rand(0, count($captcha_config['backgrounds']) -1)];
			list($bg_width, $bg_height, $bg_type, $bg_attr) = getimagesize($background);

			$captcha = imagecreatefrompng($background);

			$color = hex2rgb($captcha_config['color']);
			$color = imagecolorallocate($captcha, $color['r'], $color['g'], $color['b']);

			// Determine text angle
			$angle = mt_rand( $captcha_config['angle_min'], $captcha_config['angle_max'] ) * (mt_rand(0, 1) == 1 ? -1 : 1);

			// Select font randomly
			$font = $captcha_config['fonts'][mt_rand(0, count($captcha_config['fonts']) - 1)];

			// Verify font file exists
			if( !file_exists($font) ) throw new Exception('Font file not found: ' . $font);

			//Set the font size.
			$font_size = mt_rand($captcha_config['min_font_size'], $captcha_config['max_font_size']);
			$text_box_size = imagettfbbox($font_size, $angle, $font, $captcha_config['code']);

			// Determine text position
			$box_width = abs($text_box_size[6] - $text_box_size[2]);
			$box_height = abs($text_box_size[5] - $text_box_size[1]);
			$text_pos_x_min = 0;
			$text_pos_x_max = ($bg_width) - ($box_width);
			$text_pos_x = mt_rand($text_pos_x_min, $text_pos_x_max);
			$text_pos_y_min = $box_height;
			$text_pos_y_max = ($bg_height) - ($box_height / 2);
			if ($text_pos_y_min > $text_pos_y_max) {
				$temp_text_pos_y = $text_pos_y_min;
				$text_pos_y_min = $text_pos_y_max;
				$text_pos_y_max = $temp_text_pos_y;
			}
			$text_pos_y = mt_rand($text_pos_y_min, $text_pos_y_max);

			// Draw shadow
			if( $captcha_config['shadow'] ){
				$shadow_color = hex2rgb($captcha_config['shadow_color']);
				$shadow_color = imagecolorallocate($captcha, $shadow_color['r'], $shadow_color['g'], $shadow_color['b']);
				imagettftext($captcha, $font_size, $angle, $text_pos_x + $captcha_config['shadow_offset_x'], $text_pos_y + $captcha_config['shadow_offset_y'], $shadow_color, $font, $captcha_config['code']);
			}

			// Draw text
			imagettftext($captcha, $font_size, $angle, $text_pos_x, $text_pos_y, $color, $font, $captcha_config['code']);

			// Output image
			header("Content-type: image/png");
			imagepng($captcha);
			
			die();
		//}		
	}
}

if( !function_exists('hex2rgb') ) {
    function hex2rgb($hex_str, $return_string = false, $separator = ',') {
        $hex_str = preg_replace("/[^0-9A-Fa-f]/", '', $hex_str); // Gets a proper hex string
        $rgb_array = array();
        if( strlen($hex_str) == 6 ) {
            $color_val = hexdec($hex_str);
            $rgb_array['r'] = 0xFF & ($color_val >> 0x10);
            $rgb_array['g'] = 0xFF & ($color_val >> 0x8);
            $rgb_array['b'] = 0xFF & $color_val;
        } elseif( strlen($hex_str) == 3 ) {
            $rgb_array['r'] = hexdec(str_repeat(substr($hex_str, 0, 1), 2));
            $rgb_array['g'] = hexdec(str_repeat(substr($hex_str, 1, 1), 2));
            $rgb_array['b'] = hexdec(str_repeat(substr($hex_str, 2, 1), 2));
        } else {
            return false;
        }
        return $return_string ? implode($separator, $rgb_array) : $rgb_array;
    }
}

}
?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php

class c_agnstream {

   var $position;
   var $data;
   
   var $AGNEOF;
   var $size;

   function stream_open($_url,$mode,$options,&$opened_path) {
   
		$url = parse_url($_url);   
		$timeout = 5;//30;
   
        $server = $url['host'];
		$port = $url['port'];
		$path = $url['path'];
		//print_r($url);
		
        //$socket = fsockopen($server, $port, $errno, $errstr, $timeout); 
		//PERSISTENT CONNECTION
		$socket = pfsockopen($server, $port, $errno, $errstr, $timeout); 
		
		if (!$socket) {
		  echo $errstr,"(",$errno,")\n";
		  return false;
		}
        $agnmem = substr($path,1);//exclude '/' from the begining of str
		$request = "callagentc " . $agnmem . "\r\n\r\n";//client version of getdpcmem
        fputs($socket, $request); 
        $ret = ''; 
        while (!feof($socket)) { 
          $ret .= fgets($socket, 4096);
        }  
        fclose($socket);  
				
		$this->AGNEOF = strlen($ret);;
		$this->size = strlen($ret);
	    $this->data = $ret;
		    
		$this->position = 0;
		
		return true;   
   }
   
   function stream_read($count) {
   
        $ret = substr($this->data,$this->position,$count);
		$this->position += strlen($ret);
		
        return ($ret);//serialized object //(unserialize($ret));
   }
   
   function stream_write($data) {
   
       /* $left = substr($this->data, 0, $this->position);
		$right = substr($this->data, $this->position + strlen($data));
		
		$this->data = $left . $data . $right;
		
		$this->position += strlen($data); */
		
		return (strlen($data));
   }
   
   function stream_tell() {
   
     return ($this->position);
   }
   
   function stream_eof() {
   
     //return ($this->AGNEOF);
	 return $this->position >= strlen($this->data);
   }
   
   function stream_seek($offset,$whence) {
   
     switch($whence){
     	case SEEK_SET: 
     		if (($offset < strlen($this->data)) && ($offset >=0)) {
     		    $this->position = $offset;
				return true;
     		}
			else
			    return false;
     		break;
     	case SEEK_CUR: 
     		if ($offset >=0) {
     		    $this->position += $offset;
				return true;
     		}
			else
			    return false;
     		break;
		case SEEK_END: 
     		if (strlen($this->data) + $offset >= 0) {
     		    $this->position = strlen($this->data) + $offset;
				return true;
     		}
			else
			    return false;
     		break;	
     	default:
     		return false;
     } // switch
   }
   
   function stream_stat() {
   
     return (array('size'=>strlen($this->data)));
   }
}

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php

class c_resstream {

   var $position;
   var $data;
   
   //var $AGNEOF;
   //var $size;

   function stream_open($_url,$mode,$options,&$opened_path) {
   
		$url = parse_url($_url);   
		$timeout = 5;//30;
   
        $server = $url['host'];
		$port = $url['port'];
		$path = $url['path'];
		//print_r($url);
		
        //$socket = fsockopen($server, $port, $errno, $errstr, $timeout); 
		//PERSISTENT CONNECTION
		$socket = pfsockopen($server, $port, $errno, $errstr, $timeout); 

		if (!$socket) {
		  echo $errstr,"(",$errno,")\n";
		  return false;
		}
		//stream_set_blocking($socket,1);
        $resmem = substr($path,1);//exclude '/' from the begining of str
		$request = "getresource " . $resmem . "\r\n\r\n";		
        fputs($socket, $request); 

        $ret = ''; 
        while (!feof($socket)) { 
          $ret .= fgets($socket, 4096);
        }  
        fclose($socket);  
				
		//$this->AGNEOF = strlen($ret);;
		//$this->size = strlen($ret);
	    $this->data = $ret;
		    
		$this->position = 0;
		
		return true;   
   }
   
   function stream_read($count) {
   
        $ret = substr($this->data,$this->position,$count);
		$this->position += strlen($ret);
		
        return ($ret);//serialized object //(unserialize($ret));
   }
   
   function stream_write($data) {
   
       /* $left = substr($this->data, 0, $this->position);
		$right = substr($this->data, $this->position + strlen($data));
		
		$this->data = $left . $data . $right;
		
		$this->position += strlen($data); */
		
		return (strlen($data));
   }
   
   function stream_tell() {
   
     return ($this->position);
   }
   
   function stream_eof() {
   
     //return ($this->AGNEOF);
	 return $this->position >= strlen($this->data);
   }
   
   function stream_seek($offset,$whence) {
   
     switch($whence){
     	case SEEK_SET: 
     		if (($offset < strlen($this->data)) && ($offset >=0)) {
     		    $this->position = $offset;
				return true;
     		}
			else
			    return false;
     		break;
     	case SEEK_CUR: 
     		if ($offset >=0) {
     		    $this->position += $offset;
				return true;
     		}
			else
			    return false;
     		break;
		case SEEK_END: 
     		if (strlen($this->data) + $offset >= 0) {
     		    $this->position = strlen($this->data) + $offset;
				return true;
     		}
			else
			    return false;
     		break;	
     	default:
     		return false;
     } // switch
   }
   
   function stream_stat() {
   
     return (array('size'=>strlen($this->data)));
   }
}

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/*
 * sasl.php > saslclient for phpdac5 agent
 *
 * @(#) $Id: sasl.php,v 1.11 2005/10/31 18:43:27 mlemos Exp $
 *
 */

define("SASL_INTERACT", 2);
define("SASL_CONTINUE", 1);
define("SASL_OK",       0);
define("SASL_FAIL",    -1);
define("SASL_NOMECH",  -4);

class sasl_interact_class
{
	var $id;
	var $challenge;
	var $prompt;
	var $default_result;
	var $result;
};

/*
{metadocument}<?xml version="1.0" encoding="ISO-8859-1" ?>
<class>

	<package>net.manuellemos.sasl</package>

	<version>@(#) $Id: sasl.php,v 1.11 2005/10/31 18:43:27 mlemos Exp $</version>
	<copyright>Copyright  (C) Manuel Lemos 2004</copyright>
	<title>Simple Authentication and Security Layer client</title>
	<author>Manuel Lemos</author>
	<authoraddress>mlemos-at-acm.org</authoraddress>

	<documentation>
		<idiom>en</idiom>
		<purpose>Provide a common interface to plug-in driver classes that
			implement different mechanisms for authentication used by clients of
			standard protocols like SMTP, POP3, IMAP, HTTP, etc.. Currently the
			supported authentication mechanisms are: <tt>PLAIN</tt>,
			<tt>LOGIN</tt>, <tt>CRAM-MD5</tt>, <tt>Digest</tt> and <tt>NTML</tt>
			(Windows or Samba).</purpose>
		<usage>.</usage>
	</documentation>

{/metadocument}
*/

class sasl_client_class
{
	/* Public variables */

/*
{metadocument}
	<variable>
		<name>error</name>
		<type>STRING</type>
		<value></value>
		<documentation>
			<purpose>Store the message that is returned when an error
				occurs.</purpose>
			<usage>Check this variable to understand what happened when a call to
				any of the class functions has failed.<paragraphbreak />
				This class uses cumulative error handling. This means that if one
				class functions that may fail is called and this variable was
				already set to an error message due to a failure in a previous call
				to the same or other function, the function will also fail and does
				not do anything.<paragraphbreak />
				This allows programs using this class to safely call several
				functions that may fail and only check the failure condition after
				the last function call.<paragraphbreak />
				Just set this variable to an empty string to clear the error
				condition.</usage>
		</documentation>
	</variable>
{/metadocument}
*/
	var $error='';

/*
{metadocument}
	<variable>
		<name>mechanism</name>
		<type>STRING</type>
		<value></value>
		<documentation>
			<purpose>Store the name of the mechanism that was selected during the
				call to the <functionlink>Start</functionlink> function.</purpose>
			<usage>You can access this variable but do not change it.</usage>
		</documentation>
	</variable>
{/metadocument}
*/
	var $mechanism='';

/*
{metadocument}
	<variable>
		<name>encode_response</name>
		<type>BOOLEAN</type>
		<value>1</value>
		<documentation>
			<purpose>Let the drivers inform the applications whether responses
				need to be encoded.</purpose>
			<usage>Applications should check this variable before sending
				authentication responses to the server to determine if the
				responses need to be encoded, eventually with base64 algorithm.</usage>
		</documentation>
	</variable>
{/metadocument}
*/
	var $encode_response=1;

	/* Private variables */

	var $driver;
	var $drivers=array(
		"Digest"   => array("digest_sasl_client_class",   "digest_sasl_client.lib.php"   ),
		"CRAM-MD5" => array("cram_md5_sasl_client_class", "cram_md5_sasl_client.lib.php" ),
		"LOGIN"    => array("login_sasl_client_class",    "login_sasl_client.lib.php"    ),
		"NTLM"     => array("ntlm_sasl_client_class",     "ntlm_sasl_client.lib.php"     ),
		"PLAIN"    => array("plain_sasl_client_class",    "plain_sasl_client.lib.php"    ),
		"Basic"    => array("basic_sasl_client_class",    "basic_sasl_client.lib.php"    )
	);
	var $credentials=array();
	
    function __construct($env=null) { //<<<<<<<<<<<<<
		
		$this->env = $env;
	}
	

	/* Public functions */

/*
{metadocument}
	<function>
		<name>SetCredential</name>
		<type>VOID</type>
		<documentation>
			<purpose>Store the value of a credential that may be used by any of
			 the supported mechanisms to process the authentication messages and
			 responses.</purpose>
			<usage>Call this function before starting the authentication dialog
				to pass all the credential values that be needed to use the type
				of authentication that the applications may need.</usage>
			<returnvalue>.</returnvalue>
		</documentation>
		<argument>
			<name>key</name>
			<type>STRING</type>
			<documentation>
				<purpose>Specify the name of the credential key.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>value</name>
			<type>STRING</type>
			<documentation>
				<purpose>Specify the value for the credential.</purpose>
			</documentation>
		</argument>
		<do>
{/metadocument}
*/


	Function SetCredential($key,$value)
	{
		$this->credentials[$key]=$value;
	}
/*
{metadocument}
		</do>
	</function>
{/metadocument}
*/

/*
{metadocument}
	<function>
		<name>GetCredentials</name>
		<type>INTEGER</type>
		<documentation>
			<purpose>Retrieve the values of one or more credentials to be used by
				the authentication mechanism classes.</purpose>
			<usage>This is meant to be used by authentication mechanism driver
				classes to retrieve the credentials that may be neede.</usage>
			<returnvalue>The function may return <tt>SASL_CONTINUE</tt> if it
				succeeded, or <tt>SASL_NOMECH</tt> if it was not possible to
				retrieve one of the requested credentials.</returnvalue>
		</documentation>
		<argument>
			<name>credentials</name>
			<type>HASH</type>
			<documentation>
				<purpose>Reference to an associative array variable with all the
					credentials that are being requested. The function initializes
					this associative array values.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>defaults</name>
			<type>HASH</type>
			<documentation>
				<purpose>Associative arrays with default values for credentials
					that may have not been defined.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>interactions</name>
			<type>ARRAY</type>
			<documentation>
				<purpose>Not yet in use. It is meant to provide context
					information to retrieve credentials that may be obtained
					interacting with the user.</purpose>
			</documentation>
		</argument>
		<do>
{/metadocument}
*/
	Function GetCredentials(&$credentials,$defaults,&$interactions)
	{
		Reset($credentials);
		$end=(GetType($key=Key($credentials))!="string");
		for(;!$end;)
		{
			if(!IsSet($this->credentials[$key]))
			{
				if(IsSet($defaults[$key]))
					$credentials[$key]=$defaults[$key];
				else
				{
					$this->error="the requested credential ".$key." is not defined";
					return(SASL_NOMECH);
				}
			}
			else
				$credentials[$key]=$this->credentials[$key];
			Next($credentials);
			$end=(GetType($key=Key($credentials))!="string");
		}
		return(SASL_CONTINUE);
	}
/*
{metadocument}
		</do>
	</function>
{/metadocument}
*/

/*
{metadocument}
	<function>
		<name>Start</name>
		<type>INTEGER</type>
		<documentation>
			<purpose>Process the initial authentication step initializing the
				driver class that implements the first of the list of requested
				mechanisms that is supported by this SASL client library
				implementation.</purpose>
			<usage>Call this function specifying a list of mechanisms that the
				server supports. If the <argumentlink>
					<argument>message</argument>
					<function>Start</function>
				</argumentlink> argument returns a string, it should be sent to
				the server as initial message. Check the
				<variablelink>encode_response</variablelink> variable to determine
				whether the initial message needs to be encoded, eventually with
				base64 algorithm, before it is sent to the server.</usage>
			<returnvalue>The function may return <tt>SASL_CONTINUE</tt> if it
				could start one of the requested authentication mechanisms. It
				may return <tt>SASL_NOMECH</tt> if it was not possible to start
				any of the requested mechanisms. It returns <tt>SASL_FAIL</tt> or
				other value in case of error.</returnvalue>
		</documentation>
		<argument>
			<name>mechanisms</name>
			<type>ARRAY</type>
			<inout />
			<documentation>
				<purpose>Define the list of names of authentication mechanisms
					supported by the that should be tried.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>message</name>
			<type>STRING</type>
			<out />
			<documentation>
				<purpose>Return the initial message that should be sent to the
					server to start the authentication dialog. If this value is
					undefined, no message should be sent to the server.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>interactions</name>
			<type>ARRAY</type>
			<documentation>
				<purpose>Not yet in use. It is meant to provide context
					information to interact with the end user.</purpose>
			</documentation>
		</argument>
		<do>
{/metadocument}
*/
	Function Start($mechanisms, &$message, &$interactions)
	{
		if(strlen($this->error))
			return(SASL_FAIL);
		if(IsSet($this->driver))
			return($this->driver->Start($this,$message,$interactions));
		$no_mechanism_error="";
		for($m=0;$m<count($mechanisms);$m++)
		{
			$mechanism=$mechanisms[$m];
			if(IsSet($this->drivers[$mechanism]))
			{  //<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
		        //echo '>>>>>' . $this->env->ldscheme;
				if(!class_exists($this->drivers[$mechanism][0]))
					require_once($this->env->ldscheme . "/tcp/".$this->drivers[$mechanism][1]);
				$this->driver=new $this->drivers[$mechanism][0];
				if($this->driver->Initialize($this))
				{
					$this->encode_response=1;
					$status=$this->driver->Start($this,$message,$interactions);
					switch($status)
					{
						case SASL_NOMECH:
							Unset($this->driver);
							if(strlen($no_mechanism_error)==0)
								$no_mechanism_error=$this->error;
							$this->error="";
							break;
						case SASL_CONTINUE:
							$this->mechanism=$mechanism;
							return($status);
						default:
							Unset($this->driver);
							$this->error="";
							return($status);
					}
				}
				else
				{
					Unset($this->driver);
					if(strlen($no_mechanism_error)==0)
						$no_mechanism_error=$this->error;
					$this->error="";
				}
			}
		}
		$this->error=(strlen($no_mechanism_error) ? $no_mechanism_error : "it was not requested any of the authentication mechanisms that are supported");
		return(SASL_NOMECH);
	}
/*
{metadocument}
		</do>
	</function>
{/metadocument}
*/

/*
{metadocument}
	<function>
		<name>Step</name>
		<type>INTEGER</type>
		<documentation>
			<purpose>Process the authentication steps after the initial step,
				until the authetication iteration dialog is complete.</purpose>
			<usage>Call this function iteratively after a successful initial
				step calling the <functionlink>Start</functionlink> function.</usage>
			<returnvalue>The function returns <tt>SASL_CONTINUE</tt> if step was
				processed successfully, or returns <tt>SASL_FAIL</tt> in case of
				error.</returnvalue>
		</documentation>
		<argument>
			<name>response</name>
			<type>STRING</type>
			<in />
			<documentation>
				<purpose>Pass the response returned by the server to the previous
					step.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>message</name>
			<type>STRING</type>
			<out />
			<documentation>
				<purpose>Return the message that should be sent to the server to
					continue the authentication dialog. If this value is undefined,
					no message should be sent to the server.</purpose>
			</documentation>
		</argument>
		<argument>
			<name>interactions</name>
			<type>ARRAY</type>
			<documentation>
				<purpose>Not yet in use. It is meant to provide context
					information to interact with the end user.</purpose>
			</documentation>
		</argument>
		<do>
{/metadocument}
*/
	Function Step($response, &$message, &$interactions)
	{
		if(strlen($this->error))
			return(SASL_FAIL);
		return($this->driver->Step($this,$response,$message,$interactions));
	}
/*
{metadocument}
		</do>
	</function>
{/metadocument}
*/

};

/*

{metadocument}
</class>
{/metadocument}

*/

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/*
 * http.php >httpclient for phpdac5 agent
 *
 * @(#) $Header: /opt2/ena/metal/http/http.php,v 1.94 2016/05/03 02:07:04 mlemos Exp $
 *
 */

define('HTTP_CLIENT_ERROR_UNSPECIFIED_ERROR',       -1);
define('HTTP_CLIENT_ERROR_NO_ERROR',                 0);
define('HTTP_CLIENT_ERROR_INVALID_SERVER_ADDRESS',   1);
define('HTTP_CLIENT_ERROR_CANNOT_CONNECT',           2);
define('HTTP_CLIENT_ERROR_COMMUNICATION_FAILURE',    3);
define('HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE', 4);
define('HTTP_CLIENT_ERROR_PROTOCOL_FAILURE',         5);
define('HTTP_CLIENT_ERROR_INVALID_PARAMETERS',       6);

class httpclient
{
	var $host_name="";
	var $host_port=0;
	var $proxy_host_name="";
	var $proxy_host_port=80;
	var $socks_host_name = '';
	var $socks_host_port = 1080;
	var $socks_version = '5';

	var $protocol="http";
	var $request_method="GET";
	var $user_agent='httpclient (http://www.phpclasses.org/httpclient $Revision: 1.94 $)';
	var $accept='';
	var $authentication_mechanism="";
	var $user;
	var $password;
	var $realm;
	var $workstation;
	var $proxy_authentication_mechanism="";
	var $proxy_user;
	var $proxy_password;
	var $proxy_realm;
	var $proxy_workstation;
	var $request_uri="";
	var $request="";
	var $request_headers=array();
	var $request_user;
	var $request_password;
	var $request_realm;
	var $request_workstation;
	var $proxy_request_user;
	var $proxy_request_password;
	var $proxy_request_realm;
	var $proxy_request_workstation;
	var $request_body="";
	var $request_arguments=array();
	var $protocol_version="1.1";
	var $timeout=0;
	var $data_timeout=0;
	var $debug=0;
	var $log_debug=0;
	var $debug_response_body=1;
	var $html_debug=0;
	var $support_cookies=1;
	var $cookies=array();
	var $error="";
	var $error_code = HTTP_CLIENT_ERROR_NO_ERROR;
	var $exclude_address="";
	var $follow_redirect=0;
	var $redirection_limit=5;
	var $response_status="";
	var $response_message="";
	var $file_buffer_length=8000;
	var $force_multipart_form_post=0;
	var $prefer_curl = 0;
	var $keep_alive = 1;
	var $sasl_authenticate = 1;

	/* private variables - DO NOT ACCESS */

	var $state="Disconnected";
	var $use_curl=0;
	var $connection=0;
	var $content_length=0;
	var $response="";
	var $read_response=0;
	var $read_length=0;
	var $request_host="";
	var $next_token="";
	var $redirection_level=0;
	var $chunked=0;
	var $remaining_chunk=0;
	var $last_chunk_read=0;
	var $months=array(
		"Jan"=>"01",
		"Feb"=>"02",
		"Mar"=>"03",
		"Apr"=>"04",
		"May"=>"05",
		"Jun"=>"06",
		"Jul"=>"07",
		"Aug"=>"08",
		"Sep"=>"09",
		"Oct"=>"10",
		"Nov"=>"11",
		"Dec"=>"12");
	var $session='';
	var $connection_close=0;
	var $force_close = 0;
	var $connected_host = '';
	var $connected_port = -1;
	var $connected_ssl = 0;
	
    function __construct($env=null) { //<<<<<<<<<<<<<
		
		$this->env = $env;
	}

	/* Private methods - DO NOT CALL */

	Function Tokenize($string,$separator="")
	{
		if(!strcmp($separator,""))
		{
			$separator=$string;
			$string=$this->next_token;
		}
		for($character=0;$character<strlen($separator);$character++)
		{
			if(GetType($position=strpos($string,$separator[$character]))=="integer")
				$found=(IsSet($found) ? min($found,$position) : $position);
		}
		if(IsSet($found))
		{
			$this->next_token=substr($string,$found+1);
			return(substr($string,0,$found));
		}
		else
		{
			$this->next_token="";
			return($string);
		}
	}

	Function CookieEncode($value, $name)
	{
		return($name ? str_replace("=", "%25", $value) : str_replace(";", "%3B", $value));
	}

	Function SetError($error, $error_code = HTTP_CLIENT_ERROR_UNSPECIFIED_ERROR)
	{
		$this->error_code = $error_code;
		return($this->error=$error);
	}

	Function SetPHPError($error, &$php_error_message, $error_code = HTTP_CLIENT_ERROR_UNSPECIFIED_ERROR)
	{
		if(IsSet($php_error_message)
		&& strlen($php_error_message))
			$error.=": ".$php_error_message;
		return($this->SetError($error, $error_code));
	}

	Function SetDataAccessError($error,$check_connection=0)
	{
		$this->error=$error;
		$this->error_code = HTTP_CLIENT_ERROR_COMMUNICATION_FAILURE;
		if(!$this->use_curl
		&& function_exists("socket_get_status"))
		{
			$status=socket_get_status($this->connection);
			if($status["timed_out"])
				$this->error.=": data access time out";
			elseif($status["eof"])
			{
				if($check_connection)
					$this->error="";
				else
					$this->error.=": the server disconnected";
			}
		}
	}

	Function OutputDebug($message)
	{
		if($this->log_debug)
		{
			if(strlen($this->log_file_name))
				error_log($message."\n", 3, $this->log_file_name);
			else
				error_log($message);
		}
		else
		{
			$message.="\n";
			if($this->html_debug)
				$message=str_replace("\n","<br />\n",HtmlEntities($message));
			echo $message;
			flush();
		}
	}

	Function GetLine()
	{
		for($line="";;)
		{
			if($this->use_curl)
			{
				$eol=strpos($this->response,"\n",$this->read_response);
				$data=($eol ? substr($this->response,$this->read_response,$eol+1-$this->read_response) : "");
				$this->read_response+=strlen($data);
			}
			else
			{
				if(feof($this->connection))
				{
					$this->SetDataAccessError("reached the end of data while reading from the HTTP server connection");
					return(0);
				}
				$data=fgets($this->connection,100);
			}
			if(GetType($data)!="string"
			|| strlen($data)==0)
			{
				$this->SetDataAccessError("it was not possible to read line from the HTTP server");
				return(0);
			}
			$line.=$data;
			$length=strlen($line);
			if($length
			&& !strcmp(substr($line,$length-1,1),"\n"))
			{
				$length-=(($length>=2 && !strcmp(substr($line,$length-2,1),"\r")) ? 2 : 1);
				$line=substr($line,0,$length);
				if($this->debug)
					$this->OutputDebug("S $line");
				return($line);
			}
		}
	}

	Function PutLine($line)
	{
		if($this->debug)
			$this->OutputDebug("C $line");
		if(!fputs($this->connection,$line."\r\n"))
		{
			$this->SetDataAccessError("it was not possible to send a line to the HTTP server");
			return(0);
		}
		return(1);
	}

	Function PutData($data)
	{
		if(strlen($data))
		{
			if($this->debug)
				$this->OutputDebug('C '.$data);
			if(!fputs($this->connection,$data))
			{
				$this->SetDataAccessError("it was not possible to send data to the HTTP server");
				return(0);
			}
		}
		return(1);
	}

	Function FlushData()
	{
		if(!fflush($this->connection))
		{
			$this->SetDataAccessError("it was not possible to send data to the HTTP server");
			return(0);
		}
		return(1);
	}

	Function ReadChunkSize()
	{
		if($this->remaining_chunk==0)
		{
			$debug=$this->debug;
			if(!$this->debug_response_body)
				$this->debug=0;
			$line=$this->GetLine();
			$this->debug=$debug;
			if(GetType($line)!="string")
				return($this->SetError("could not read chunk start: ".$this->error, $this->error_code));
			$this->remaining_chunk=hexdec($line);
			if($this->remaining_chunk == 0)
			{
				if(!$this->debug_response_body)
					$this->debug=0;
				$line=$this->GetLine();
				$this->debug=$debug;
				if(GetType($line)!="string")
					return($this->SetError("could not read chunk end: ".$this->error, $this->error_code));
			}
		}
		return("");
	}

	Function ReadBytes($length)
	{
		if($this->use_curl)
		{
			$bytes=substr($this->response,$this->read_response,min($length,strlen($this->response)-$this->read_response));
			$this->read_response+=strlen($bytes);
			if($this->debug
			&& $this->debug_response_body
			&& strlen($bytes))
				$this->OutputDebug("S ".$bytes);
		}
		else
		{
			if($this->chunked)
			{
				for($bytes="",$remaining=$length;$remaining;)
				{
					if(strlen($this->ReadChunkSize()))
						return("");
					if($this->remaining_chunk==0)
					{
						$this->last_chunk_read=1;
						break;
					}
					$ask=min($this->remaining_chunk,$remaining);
					$chunk=@fread($this->connection,$ask);
					$read=strlen($chunk);
					if($read==0)
					{
						$this->SetDataAccessError("it was not possible to read data chunk from the HTTP server");
						return("");
					}
					if($this->debug
					&& $this->debug_response_body)
						$this->OutputDebug("S ".$chunk);
					$bytes.=$chunk;
					$this->remaining_chunk-=$read;
					$remaining-=$read;
					if($this->remaining_chunk==0)
					{
						if(feof($this->connection))
							return($this->SetError("reached the end of data while reading the end of data chunk mark from the HTTP server", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
						$data=@fread($this->connection,2);
						if(strcmp($data,"\r\n"))
						{
							$this->SetDataAccessError("it was not possible to read end of data chunk from the HTTP server");
							return("");
						}
					}
				}
			}
			else
			{
				$bytes=@fread($this->connection,$length);
				if(strlen($bytes))
				{
					if($this->debug
					&& $this->debug_response_body)
						$this->OutputDebug("S ".$bytes);
				}
				else
					$this->SetDataAccessError("it was not possible to read data from the HTTP server", $this->connection_close);
			}
		}
		return($bytes);
	}

	Function EndOfInput()
	{
		if($this->use_curl)
			return($this->read_response>=strlen($this->response));
		if($this->chunked)
			return($this->last_chunk_read);
		if($this->content_length_set)
			return($this->content_length <= $this->read_length);
		return(feof($this->connection));
	}

	Function Resolve($domain, &$ip, $server_type)
	{
		if(preg_match('/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/',$domain))
			$ip=$domain;
		else
		{
			if($this->debug)
				$this->OutputDebug('Resolving '.$server_type.' server domain "'.$domain.'"...');
			if(!strcmp($ip=@gethostbyname($domain),$domain))
				$ip="";
		}
		if(strlen($ip)==0
		|| (strlen($this->exclude_address)
		&& !strcmp(@gethostbyname($this->exclude_address),$ip)))
			return($this->SetError("could not resolve the host domain \"".$domain."\"", HTTP_CLIENT_ERROR_INVALID_SERVER_ADDRESS));
		return('');
	}

	Function Connect($host_name, $host_port, $ssl, $server_type = 'HTTP')
	{
		$domain=$host_name;
		$port = $host_port;
		if(strlen($error = $this->Resolve($domain, $ip, $server_type)))
			return($error);
		if(strlen($this->socks_host_name))
		{
			switch($this->socks_version)
			{
				case '4':
					$version = 4;
					break;
				case '5':
					$version = 5;
					break;
				default:
					return('it was not specified a supported SOCKS protocol version');
					break;
			}
			$host_ip = $ip;
			$port = $this->socks_host_port;
			$host_server_type = $server_type;
			$server_type = 'SOCKS';
			if(strlen($error = $this->Resolve($this->socks_host_name, $ip, $server_type)))
				return($error);
		}
		if($this->debug)
			$this->OutputDebug('Connecting to '.$server_type.' server IP '.$ip.' port '.$port.'...');
		if($ssl)
			$ip="ssl://".$host_name;
		if(($this->connection=($this->timeout ? @fsockopen($ip, $port, $errno, $error, $this->timeout) : @fsockopen($ip, $port, $errno)))==0)
		{
			$error_code = HTTP_CLIENT_ERROR_CANNOT_CONNECT;
			switch($errno)
			{
				case -3:
					return($this->SetError("socket could not be created", $error_code));
				case -4:
					return($this->SetError("dns lookup on hostname \"".$host_name."\" failed", $error_code));
				case -5:
					return($this->SetError("connection refused or timed out", $error_code));
				case -6:
					return($this->SetError("fdopen() call failed", $error_code));
				case -7:
					return($this->SetError("setvbuf() call failed", $error_code));
				default:
					return($this->SetPHPError($errno." could not connect to the host \"".$host_name."\"",$php_errormsg, $error_code));
			}
		}
		else
		{
			if($this->data_timeout
			&& function_exists("socket_set_timeout"))
				socket_set_timeout($this->connection,$this->data_timeout,0);
			if(strlen($this->socks_host_name))
			{
				if($this->debug)
					$this->OutputDebug('Connected to the SOCKS server '.$this->socks_host_name);
				$send_error = 'it was not possible to send data to the SOCKS server';
				$receive_error = 'it was not possible to receive data from the SOCKS server';
				switch($version)
				{
					case 4:
						$command = 1;
						$user = '';
						if(!fputs($this->connection, chr($version).chr($command).pack('nN', $host_port, ip2long($host_ip)).$user.Chr(0)))
							$error = $this->SetDataAccessError($send_error);
						else
						{
							$response = fgets($this->connection, 9);
							if(strlen($response) != 8)
								$error = $this->SetDataAccessError($receive_error);
							else
							{
								$socks_errors = array(
									"\x5a"=>'',
									"\x5b"=>'request rejected',
									"\x5c"=>'request failed because client is not running identd (or not reachable from the server)',
									"\x5d"=>'request failed because client\'s identd could not confirm the user ID string in the request',
								);
								$error_code = $response[1];
								$error = (IsSet($socks_errors[$error_code]) ? $socks_errors[$error_code] : 'unknown');
								if(strlen($error))
									$error = 'SOCKS error: '.$error;
							}
						}
						break;
					case 5:
						if($this->debug)
							$this->OutputDebug('Negotiating the authentication method ...');
						$methods = 1;
						$method = 0;
						if(!fputs($this->connection, chr($version).chr($methods).chr($method)))
							$error = $this->SetDataAccessError($send_error);
						else
						{
							$response = fgets($this->connection, 3);
							if(strlen($response) != 2)
								$error = $this->SetDataAccessError($receive_error);
							elseif(Ord($response[1]) != $method)
								$error = 'the SOCKS server requires an authentication method that is not yet supported';
							else
							{
								if($this->debug)
									$this->OutputDebug('Connecting to '.$host_server_type.' server IP '.$host_ip.' port '.$host_port.'...');
								$command = 1;
								$address_type = 1;
								if(!fputs($this->connection, chr($version).chr($command)."\x00".chr($address_type).pack('Nn', ip2long($host_ip), $host_port)))
									$error = $this->SetDataAccessError($send_error);
								else
								{
									$response = fgets($this->connection, 11);
									if(strlen($response) != 10)
										$error = $this->SetDataAccessError($receive_error);
									else
									{
										$socks_errors = array(
											"\x00"=>'',
											"\x01"=>'general SOCKS server failure',
											"\x02"=>'connection not allowed by ruleset',
											"\x03"=>'Network unreachable',
											"\x04"=>'Host unreachable',
											"\x05"=>'Connection refused',
											"\x06"=>'TTL expired',
											"\x07"=>'Command not supported',
											"\x08"=>'Address type not supported'
										);
										$error_code = $response[1];
										$error = (IsSet($socks_errors[$error_code]) ? $socks_errors[$error_code] : 'unknown');
										if(strlen($error))
											$error = 'SOCKS error: '.$error;
									}
								}
							}
						}
						break;
					default:
						$error = 'support for SOCKS protocol version '.$this->socks_version.' is not yet implemented';
						break;
				}
				if(strlen($error))
				{
					fclose($this->connection);
					return($error);
				}
			}
			if($this->debug)
				$this->OutputDebug("Connected to $host_name");
			if(strlen($this->proxy_host_name)
			&& !strcmp(strtolower($this->protocol), 'https'))
			{
				if(function_exists('stream_socket_enable_crypto')
				&& in_array('ssl', stream_get_transports()))
					$this->state = "ConnectedToProxy";
				else
				{
					$this->OutputDebug("It is not possible to start SSL after connecting to the proxy server. If the proxy refuses to forward the SSL request, you may need to upgrade to PHP 5.1 or later with OpenSSL support enabled.");
					$this->state="Connected";
				}
			}
			else
				$this->state="Connected";
			return("");
		}
	}

	Function Disconnect()
	{
		if($this->debug)
			$this->OutputDebug("Disconnected from ".$this->connected_host);
		if($this->use_curl)
		{
			curl_close($this->connection);
			$this->response="";
		}
		else
			fclose($this->connection);
		$this->state="Disconnected";
		return("");
	}

	/* Public methods */

	Function GetRequestArguments($url, &$arguments)
	{
		$this->error = '';
		$this->error_code = HTTP_CLIENT_ERROR_NO_ERROR;
		$arguments=array();
		$url = str_replace(' ', '%20', $url);
		$parameters=@parse_url($url);
		if(!$parameters)
			return($this->SetError("it was not specified a valid URL", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		if(!IsSet($parameters["scheme"]))
			return($this->SetError("it was not specified the protocol type argument", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		switch(strtolower($parameters["scheme"]))
		{
			case "http":
			case "https":
				$arguments["Protocol"]=$parameters["scheme"];
				break;
			default:
				return($parameters["scheme"]." connection scheme is not yet supported");
		}
		if(!IsSet($parameters["host"]))
			return($this->SetError("it was not specified the connection host argument", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		$arguments["HostName"]=$parameters["host"];
		$arguments["Headers"]=array("Host"=>$parameters["host"].(IsSet($parameters["port"]) ? ":".$parameters["port"] : ""));
		if(IsSet($parameters["user"]))
		{
			$arguments["AuthUser"]=UrlDecode($parameters["user"]);
			if(!IsSet($parameters["pass"]))
				$arguments["AuthPassword"]="";
		}
		if(IsSet($parameters["pass"]))
		{
			if(!IsSet($parameters["user"]))
				$arguments["AuthUser"]="";
			$arguments["AuthPassword"]=UrlDecode($parameters["pass"]);
		}
		if(IsSet($parameters["port"]))
		{
			if(strcmp($parameters["port"],strval(intval($parameters["port"]))))
				return($this->SetError("it was not specified a valid connection host argument", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			$arguments["HostPort"]=intval($parameters["port"]);
		}
		else
			$arguments["HostPort"]=0;
		$arguments["RequestURI"]=(IsSet($parameters["path"]) ? $parameters["path"] : "/").(IsSet($parameters["query"]) ? "?".$parameters["query"] : "");
		if(strlen($this->user_agent))
			$arguments["Headers"]["User-Agent"]=$this->user_agent;
		if(strlen($this->accept))
			$arguments["Headers"]["Accept"]=$this->accept;
		return("");
	}

	Function Open($arguments)
	{
		if(strlen($this->error))
			return($this->error);
		$error_code = HTTP_CLIENT_ERROR_UNSPECIFIED_ERROR;
		if(IsSet($arguments["HostName"]))
			$this->host_name=$arguments["HostName"];
		if(IsSet($arguments["HostPort"]))
			$this->host_port=$arguments["HostPort"];
		if(IsSet($arguments["ProxyHostName"]))
			$this->proxy_host_name=$arguments["ProxyHostName"];
		if(IsSet($arguments["ProxyHostPort"]))
			$this->proxy_host_port=$arguments["ProxyHostPort"];
		if(IsSet($arguments["SOCKSHostName"]))
			$this->socks_host_name=$arguments["SOCKSHostName"];
		if(IsSet($arguments["SOCKSHostPort"]))
			$this->socks_host_port=$arguments["SOCKSHostPort"];
		if(IsSet($arguments["SOCKSVersion"]))
			$this->socks_version=$arguments["SOCKSVersion"];
		if(IsSet($arguments["PreferCurl"]))
			$this->prefer_curl=$arguments["PreferCurl"];
		if(IsSet($arguments["Protocol"]))
			$this->protocol=$arguments["Protocol"];
		switch(strtolower($this->protocol))
		{
			case "http":
				$default_port=80;
				break;
			case "https":
				$default_port=443;
				break;
			default:
				return($this->SetError("it was not specified a valid connection protocol", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		}
		if(strlen($this->proxy_host_name)==0)
		{
			if(strlen($this->host_name)==0)
				return($this->SetError("it was not specified a valid hostname", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			$host_name=$this->host_name;
			$host_port=($this->host_port ? $this->host_port : $default_port);
			$server_type = 'HTTP';
		}
		else
		{
			$host_name=$this->proxy_host_name;
			$host_port=$this->proxy_host_port;
			$server_type = 'HTTP proxy';
		}
		$ssl=(strtolower($this->protocol)=="https" && strlen($this->proxy_host_name)==0);
		if($ssl
		&& strlen($this->socks_host_name))
			return($this->SetError('establishing SSL connections via a SOCKS server is not yet supported', HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		$this->use_curl=($ssl && $this->prefer_curl && function_exists("curl_init"));
		switch($this->state)
		{
			case 'Connected':
				if(!strcmp($host_name, $this->connected_host)
				&& intval($host_port) == $this->connected_port
				&& intval($ssl) == $this->connected_ssl)
				{
					if($this->debug)
						$this->OutputDebug("Reusing connection to ".$this->connected_host);
					return('');
				}
				if(strlen($error = $this->Disconnect()))
					return($error);
			case "Disconnected":
				break;
			default:
				return("1 already connected");
		}
		if($this->debug)
			$this->OutputDebug("Connecting to ".$this->host_name);
		if($this->use_curl)
		{
			$error=(($this->connection=curl_init($this->protocol."://".$this->host_name.($host_port==$default_port ? "" : ":".strval($host_port))."/")) ? "" : "Could not initialize a CURL session");
			if(strlen($error)==0)
			{
				if(IsSet($arguments["SSLCertificateFile"]))
					curl_setopt($this->connection,CURLOPT_SSLCERT,$arguments["SSLCertificateFile"]);
				if(IsSet($arguments["SSLCertificatePassword"]))
					curl_setopt($this->connection,CURLOPT_SSLCERTPASSWD,$arguments["SSLCertificatePassword"]);
				if(IsSet($arguments["SSLKeyFile"]))
					curl_setopt($this->connection,CURLOPT_SSLKEY,$arguments["SSLKeyFile"]);
				if(IsSet($arguments["SSLKeyPassword"]))
					curl_setopt($this->connection,CURLOPT_SSLKEYPASSWD,$arguments["SSLKeyPassword"]);
			}
			$this->state="Connected";
		}
		else
		{
			$error="";
			if(strlen($this->proxy_host_name)
			&& (IsSet($arguments["SSLCertificateFile"])
			|| IsSet($arguments["SSLCertificateFile"])))
				$error="establishing SSL connections using certificates or private keys via non-SSL proxies is not supported";
			else
			{
				if($ssl)
				{
					if(IsSet($arguments["SSLCertificateFile"]))
						$error="establishing SSL connections using certificates is only supported when the cURL extension is enabled";
					elseif(IsSet($arguments["SSLKeyFile"]))
						$error="establishing SSL connections using a private key is only supported when the cURL extension is enabled";
					else
					{
						$version=explode(".",function_exists("phpversion") ? phpversion() : "3.0.7");
						$php_version=intval($version[0])*1000000+intval($version[1])*1000+intval($version[2]);
						if($php_version<4003000)
							$error="establishing SSL connections requires at least PHP version 4.3.0 or having the cURL extension enabled";
						elseif(!function_exists("extension_loaded")
						|| !extension_loaded("openssl"))
							$error="establishing SSL connections requires the OpenSSL extension enabled";
					}
				}
				if(strlen($error)==0)
				{
					$error=$this->Connect($host_name, $host_port, $ssl, $server_type);
					$error_code = $this->error_code;
				}
			}
		}
		if(strlen($error))
			return($this->SetError($error, $error_code));
		$this->session=md5(uniqid(""));
		$this->connected_host = $host_name;
		$this->connected_port = intval($host_port);
		$this->connected_ssl = intval($ssl);
		return("");
	}

	Function Close($force = 0)
	{
		if($this->state=="Disconnected")
			return("1 already disconnected");
		if(!$this->force_close
		&& $this->keep_alive
		&& !$force
		&& $this->state == 'ResponseReceived')
		{
			if($this->debug)
				$this->OutputDebug('Keeping the connection alive to '.$this->connected_host);
			$this->state = 'Connected';
			return('');
		}
		return($this->Disconnect());
	}

	Function PickCookies(&$cookies,$secure)
	{
		if(IsSet($this->cookies[$secure]))
		{
			$now=gmdate("Y-m-d H-i-s");
			for($domain=0,Reset($this->cookies[$secure]);$domain<count($this->cookies[$secure]);Next($this->cookies[$secure]),$domain++)
			{
				$domain_pattern=Key($this->cookies[$secure]);
				$match=strlen($this->request_host)-strlen($domain_pattern);
				if($match>=0
				&& !strcmp($domain_pattern,substr($this->request_host,$match))
				&& ($match==0
				|| $domain_pattern[0]=="."
				|| $this->request_host[$match-1]=="."))
				{
					for(Reset($this->cookies[$secure][$domain_pattern]),$path_part=0;$path_part<count($this->cookies[$secure][$domain_pattern]);Next($this->cookies[$secure][$domain_pattern]),$path_part++)
					{
						$path=Key($this->cookies[$secure][$domain_pattern]);
						if(strlen($this->request_uri)>=strlen($path)
						&& substr($this->request_uri,0,strlen($path))==$path)
						{
							for(Reset($this->cookies[$secure][$domain_pattern][$path]),$cookie=0;$cookie<count($this->cookies[$secure][$domain_pattern][$path]);Next($this->cookies[$secure][$domain_pattern][$path]),$cookie++)
							{
								$cookie_name=Key($this->cookies[$secure][$domain_pattern][$path]);
								$expires=$this->cookies[$secure][$domain_pattern][$path][$cookie_name]["expires"];
								if($expires==""
								|| strcmp($now,$expires)<0)
									$cookies[$cookie_name]=$this->cookies[$secure][$domain_pattern][$path][$cookie_name];
							}
						}
					}
				}
			}
		}
	}

	Function GetFileDefinition($file, &$definition)
	{
		$name="";
		if(IsSet($file["FileName"]))
			$name=basename($file["FileName"]);
		if(IsSet($file["Name"]))
			$name=$file["Name"];
		if(strlen($name)==0)
			return("it was not specified the file part name");
		if(IsSet($file["Content-Type"]))
		{
			$content_type=$file["Content-Type"];
			$type=$this->Tokenize(strtolower($content_type),"/");
			$sub_type=$this->Tokenize("");
			switch($type)
			{
				case "text":
				case "image":
				case "audio":
				case "video":
				case "application":
				case "message":
					break;
				case "automatic":
					switch($sub_type)
					{
						case "name":
							switch(GetType($dot=strrpos($name,"."))=="integer" ? strtolower(substr($name,$dot)) : "")
							{
								case ".xls":
									$content_type="application/excel";
									break;
								case ".hqx":
									$content_type="application/macbinhex40";
									break;
								case ".doc":
								case ".dot":
								case ".wrd":
									$content_type="application/msword";
									break;
								case ".pdf":
									$content_type="application/pdf";
									break;
								case ".pgp":
									$content_type="application/pgp";
									break;
								case ".ps":
								case ".eps":
								case ".ai":
									$content_type="application/postscript";
									break;
								case ".ppt":
									$content_type="application/powerpoint";
									break;
								case ".rtf":
									$content_type="application/rtf";
									break;
								case ".tgz":
								case ".gtar":
									$content_type="application/x-gtar";
									break;
								case ".gz":
									$content_type="application/x-gzip";
									break;
								case ".php":
								case ".php3":
									$content_type="application/x-httpd-php";
									break;
								case ".js":
									$content_type="application/x-javascript";
									break;
								case ".ppd":
								case ".psd":
									$content_type="application/x-photoshop";
									break;
								case ".swf":
								case ".swc":
								case ".rf":
									$content_type="application/x-shockwave-flash";
									break;
								case ".tar":
									$content_type="application/x-tar";
									break;
								case ".zip":
									$content_type="application/zip";
									break;
								case ".mid":
								case ".midi":
								case ".kar":
									$content_type="audio/midi";
									break;
								case ".mp2":
								case ".mp3":
								case ".mpga":
									$content_type="audio/mpeg";
									break;
								case ".ra":
									$content_type="audio/x-realaudio";
									break;
								case ".wav":
									$content_type="audio/wav";
									break;
								case ".bmp":
									$content_type="image/bitmap";
									break;
								case ".gif":
									$content_type="image/gif";
									break;
								case ".iff":
									$content_type="image/iff";
									break;
								case ".jb2":
									$content_type="image/jb2";
									break;
								case ".jpg":
								case ".jpe":
								case ".jpeg":
									$content_type="image/jpeg";
									break;
								case ".jpx":
									$content_type="image/jpx";
									break;
								case ".png":
									$content_type="image/png";
									break;
								case ".tif":
								case ".tiff":
									$content_type="image/tiff";
									break;
								case ".wbmp":
									$content_type="image/vnd.wap.wbmp";
									break;
								case ".xbm":
									$content_type="image/xbm";
									break;
								case ".css":
									$content_type="text/css";
									break;
								case ".txt":
									$content_type="text/plain";
									break;
								case ".htm":
								case ".html":
									$content_type="text/html";
									break;
								case ".xml":
									$content_type="text/xml";
									break;
								case ".mpg":
								case ".mpe":
								case ".mpeg":
									$content_type="video/mpeg";
									break;
								case ".qt":
								case ".mov":
									$content_type="video/quicktime";
									break;
								case ".avi":
									$content_type="video/x-ms-video";
									break;
								case ".eml":
									$content_type="message/rfc822";
									break;
								default:
									$content_type="application/octet-stream";
									break;
							}
							break;
						default:
							return($content_type." is not a supported automatic content type detection method");
					}
					break;
				default:
					return($content_type." is not a supported file content type");
			}
		}
		else
			$content_type="application/octet-stream";
		$definition=array(
			"Content-Type"=>$content_type,
			"NAME"=>$name
		);
		if(IsSet($file["FileName"]))
		{
			if(GetType($length=@filesize($file["FileName"]))!="integer")
			{
				$error="it was not possible to determine the length of the file ".$file["FileName"];
				if(IsSet($php_errormsg)
				&& strlen($php_errormsg))
					$error.=": ".$php_errormsg;
				if(!file_exists($file["FileName"]))
					$error="it was not possible to access the file ".$file["FileName"];
				return($error);
			}
			$definition["FILENAME"]=$file["FileName"];
			$definition["Content-Length"]=$length;
		}
		elseif(IsSet($file["Data"]))
			$definition["Content-Length"]=strlen($definition["DATA"]=$file["Data"]);
		else
			return("it was not specified a valid file name");
		return("");
	}

	Function ConnectFromProxy($arguments, &$headers)
	{
		$host = $this->host_name.':'.($this->host_port ? $this->host_port : 443);
		$this->OutputDebug('Connecting from proxy to host '.$host);
		if(!$this->PutLine('CONNECT '.$host.' HTTP/1.0')
		|| (strlen($this->user_agent)
		&& !$this->PutLine('User-Agent: '.$this->user_agent))
		|| (strlen($this->accept)
		&& !$this->PutLine('Accept: '.$this->accept))
		|| (IsSet($arguments['Headers']['Proxy-Authorization'])
		&& !$this->PutLine('Proxy-Authorization: '.$arguments['Headers']['Proxy-Authorization']))
		|| !$this->PutLine(''))
		{
			$this->Disconnect();
			return($this->error);
		}
		$this->state = "ConnectSent";
		if(strlen($error=$this->ReadReplyHeadersResponse($headers)))
			return($error);
		$proxy_authorization="";
		while(!strcmp($this->response_status, "100"))
		{
			$this->state="ConnectSent";
			if(strlen($error=$this->ReadReplyHeadersResponse($headers)))
				return($error);
		}
		switch($this->response_status)
		{
			case "200":
				$this->OutputDebug('Establishing the cryptography layer with host '.$host);
				if(!stream_socket_enable_crypto($this->connection, 1, STREAM_CRYPTO_METHOD_SSLv23_CLIENT))
				{
					$this->OutputDebug('Failed establishing the cryptography layer with host '.$host);
					$this->SetPHPError('it was not possible to start a SSL encrypted connection via this proxy', $php_errormsg, HTTP_CLIENT_ERROR_COMMUNICATION_FAILURE);
					$this->Disconnect();
					return($this->error);
				}
				$this->OutputDebug('Succeeded establishing the cryptography layer with host '.$host);
				$this->state = "Connected";
				break;
			case "407":
				if(strlen($error=$this->Authenticate($headers, -1, $proxy_authorization, $this->proxy_request_user, $this->proxy_request_password, $this->proxy_request_realm, $this->proxy_request_workstation)))
					return($error);
				break;
			default:
				return($this->SetError("unable to send request via proxy", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
		}
		return("");
	}

	Function SendRequest($arguments)
	{
		if(strlen($this->error))
			return($this->error);
		if(IsSet($arguments["ProxyUser"]))
			$this->proxy_request_user=$arguments["ProxyUser"];
		elseif(IsSet($this->proxy_user))
			$this->proxy_request_user=$this->proxy_user;
		if(IsSet($arguments["ProxyPassword"]))
			$this->proxy_request_password=$arguments["ProxyPassword"];
		elseif(IsSet($this->proxy_password))
			$this->proxy_request_password=$this->proxy_password;
		if(IsSet($arguments["ProxyRealm"]))
			$this->proxy_request_realm=$arguments["ProxyRealm"];
		elseif(IsSet($this->proxy_realm))
			$this->proxy_request_realm=$this->proxy_realm;
		if(IsSet($arguments["ProxyWorkstation"]))
			$this->proxy_request_workstation=$arguments["ProxyWorkstation"];
		elseif(IsSet($this->proxy_workstation))
			$this->proxy_request_workstation=$this->proxy_workstation;
		switch($this->state)
		{
			case "Disconnected":
				return($this->SetError("connection was not yet established", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "Connected":
				$connect = 0;
				break;
			case "ConnectedToProxy":
				if(strlen($error = $this->ConnectFromProxy($arguments, $headers)))
					return($error);
				$connect = 1;
				break;
			default:
				return($this->SetError("can not send request in the current connection state", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		}
		if(IsSet($arguments["RequestMethod"]))
			$this->request_method=$arguments["RequestMethod"];
		if(IsSet($arguments["User-Agent"]))
			$this->user_agent=$arguments["User-Agent"];
		if(!IsSet($arguments["Headers"]["User-Agent"])
		&& strlen($this->user_agent))
			$arguments["Headers"]["User-Agent"]=$this->user_agent;
		if(IsSet($arguments["KeepAlive"]))
			$this->keep_alive=intval($arguments["KeepAlive"]);
		if(!IsSet($arguments["Headers"]["Connection"])
		&& $this->keep_alive)
			$arguments["Headers"]["Connection"]='Keep-Alive';
		if(IsSet($arguments["Accept"]))
			$this->user_agent=$arguments["Accept"];
		if(!IsSet($arguments["Headers"]["Accept"])
		&& strlen($this->accept))
			$arguments["Headers"]["Accept"]=$this->accept;
		if(strlen($this->request_method)==0)
			return($this->SetError("it was not specified a valid request method", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		if(IsSet($arguments["RequestURI"]))
			$this->request_uri=$arguments["RequestURI"];
		if(strlen($this->request_uri)==0
		|| substr($this->request_uri,0,1)!="/")
			return($this->SetError("it was not specified a valid request URI", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		$this->request_arguments=$arguments;
		$this->request_headers=(IsSet($arguments["Headers"]) ? $arguments["Headers"] : array());
		$body_length=0;
		$this->request_body="";
		$get_body=1;
		if($this->request_method=="POST"
		|| $this->request_method=="PUT")
		{
			if(IsSet($arguments['StreamRequest']))
			{
				$get_body = 0;
				$this->request_headers["Transfer-Encoding"]="chunked";
			}
			elseif(IsSet($arguments["PostFiles"])
			|| ($this->force_multipart_form_post
			&& IsSet($arguments["PostValues"])))
			{
				$boundary="--".md5(uniqid(time()));
				$this->request_headers["Content-Type"]="multipart/form-data; boundary=".$boundary.(IsSet($arguments["CharSet"]) ? "; charset=".$arguments["CharSet"] : "");
				$post_parts=array();
				if(IsSet($arguments["PostValues"]))
				{
					$values=$arguments["PostValues"];
					if(GetType($values)!="array")
						return($this->SetError("it was not specified a valid POST method values array", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
					for(Reset($values),$value=0;$value<count($values);Next($values),$value++)
					{
						$input=Key($values);
						$headers="--".$boundary."\r\nContent-Disposition: form-data; name=\"".$input."\"\r\n\r\n";
						$data=$values[$input];
						$post_parts[]=array("HEADERS"=>$headers,"DATA"=>$data);
						$body_length+=strlen($headers)+strlen($data)+strlen("\r\n");
					}
				}
				$body_length+=strlen("--".$boundary."--\r\n");
				$files=(IsSet($arguments["PostFiles"]) ? $arguments["PostFiles"] : array());
				Reset($files);
				$end=(GetType($input=Key($files))!="string");
				for(;!$end;)
				{
					if(strlen($error=$this->GetFileDefinition($files[$input],$definition)))
						return("3 ".$error);
					$headers="--".$boundary."\r\nContent-Disposition: form-data; name=\"".$input."\"; filename=\"".$definition["NAME"]."\"\r\nContent-Type: ".$definition["Content-Type"]."\r\n\r\n";
					$part=count($post_parts);
					$post_parts[$part]=array("HEADERS"=>$headers);
					if(IsSet($definition["FILENAME"]))
					{
						$post_parts[$part]["FILENAME"]=$definition["FILENAME"];
						$data="";
					}
					else
						$data=$definition["DATA"];
					$post_parts[$part]["DATA"]=$data;
					$body_length+=strlen($headers)+$definition["Content-Length"]+strlen("\r\n");
					Next($files);
					$end=(GetType($input=Key($files))!="string");
				}
				$get_body=0;
			}
			elseif(IsSet($arguments["PostValues"]))
			{
				$values=$arguments["PostValues"];
				if(GetType($values)!="array")
					return($this->SetError("it was not specified a valid POST method values array", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
				for(Reset($values),$value=0;$value<count($values);Next($values),$value++)
				{
					$k=Key($values);
					if(GetType($values[$k])=="array")
					{
						for($v = 0; $v < count($values[$k]); $v++)
						{
							if($value+$v>0)
								$this->request_body.="&";
							$this->request_body.=UrlEncode($k)."=".UrlEncode($values[$k][$v]);
						}
					}
					else
					{
						if($value>0)
							$this->request_body.="&";
						$this->request_body.=UrlEncode($k)."=".UrlEncode($values[$k]);
					}
				}
				$this->request_headers["Content-Type"]="application/x-www-form-urlencoded".(IsSet($arguments["CharSet"]) ? "; charset=".$arguments["CharSet"] : "");
				$get_body=0;
			}
		}
		if($get_body
		&& (IsSet($arguments["Body"])
		|| IsSet($arguments["BodyStream"])))
		{
			if(IsSet($arguments["Body"]))
				$this->request_body=$arguments["Body"];
			else
			{
				$stream=$arguments["BodyStream"];
				$this->request_body="";
				for($part=0; $part<count($stream); $part++)
				{
					if(IsSet($stream[$part]["Data"]))
						$this->request_body.=$stream[$part]["Data"];
					elseif(IsSet($stream[$part]["File"]))
					{
						if(!($file=@fopen($stream[$part]["File"],"rb")))
							return($this->SetPHPError("could not open upload file ".$stream[$part]["File"], $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE));
						while(!feof($file))
						{
							if(GetType($block=@fread($file,$this->file_buffer_length))!="string")
							{
								$error=$this->SetPHPError("could not read body stream file ".$stream[$part]["File"], $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
								fclose($file);
								return($error);
							}
							$this->request_body.=$block;
						}
						fclose($file);
					}
					else
						return("5 it was not specified a valid file or data body stream element at position ".$part);
				}
			}
			if(!IsSet($this->request_headers["Content-Type"]))
				$this->request_headers["Content-Type"]="application/octet-stream".(IsSet($arguments["CharSet"]) ? "; charset=".$arguments["CharSet"] : "");
		}
		if(IsSet($arguments["AuthUser"]))
			$this->request_user=$arguments["AuthUser"];
		elseif(IsSet($this->user))
			$this->request_user=$this->user;
		if(IsSet($arguments["AuthPassword"]))
			$this->request_password=$arguments["AuthPassword"];
		elseif(IsSet($this->password))
			$this->request_password=$this->password;
		if(IsSet($arguments["AuthRealm"]))
			$this->request_realm=$arguments["AuthRealm"];
		elseif(IsSet($this->realm))
			$this->request_realm=$this->realm;
		if(IsSet($arguments["AuthWorkstation"]))
			$this->request_workstation=$arguments["AuthWorkstation"];
		elseif(IsSet($this->workstation))
			$this->request_workstation=$this->workstation;
		if(strlen($this->proxy_host_name)==0
		|| $connect)
			$request_uri=$this->request_uri;
		else
		{
			switch(strtolower($this->protocol))
			{
				case "http":
					$default_port=80;
					break;
				case "https":
					$default_port=443;
					break;
			}
			$request_uri=strtolower($this->protocol)."://".$this->host_name.(($this->host_port==0 || $this->host_port==$default_port) ? "" : ":".$this->host_port).$this->request_uri;
		}
		if($this->use_curl)
		{
			$version=(GetType($v=curl_version())=="array" ? (IsSet($v["version"]) ? $v["version"] : "0.0.0") : (preg_match("/^libcurl\\/([0-9]+\\.[0-9]+\\.[0-9]+)/",$v,$m) ? $m[1] : "0.0.0"));
			$curl_version=100000*intval($this->Tokenize($version,"."))+1000*intval($this->Tokenize("."))+intval($this->Tokenize(""));
			$protocol_version=($curl_version<713002 ? "1.0" : $this->protocol_version);
		}
		else
			$protocol_version=$this->protocol_version;
		$this->request=$this->request_method." ".$request_uri." HTTP/".$protocol_version;
		if($body_length
		|| ($body_length=strlen($this->request_body))
		|| !strcmp($this->request_method, 'POST'))
			$this->request_headers["Content-Length"]=$body_length;
		for($headers=array(),$host_set=0,Reset($this->request_headers),$header=0;$header<count($this->request_headers);Next($this->request_headers),$header++)
		{
			$header_name=Key($this->request_headers);
			$header_value=$this->request_headers[$header_name];
			if(GetType($header_value)=="array")
			{
				for(Reset($header_value),$value=0;$value<count($header_value);Next($header_value),$value++)
					$headers[]=$header_name.": ".$header_value[Key($header_value)];
			}
			else
				$headers[]=$header_name.": ".$header_value;
			if(strtolower(Key($this->request_headers))=="host")
			{
				$this->request_host=strtolower($header_value);
				$host_set=1;
			}
		}
		if(!$host_set)
		{
			$headers[]="Host: ".$this->host_name;
			$this->request_host=strtolower($this->host_name);
		}
		if(count($this->cookies))
		{
			$cookies=array();
			$this->PickCookies($cookies,0);
			if(strtolower($this->protocol)=="https")
				$this->PickCookies($cookies,1);
			if(count($cookies))
			{
				$h=count($headers);
				$headers[$h]="Cookie:";
				for(Reset($cookies),$cookie=0;$cookie<count($cookies);Next($cookies),$cookie++)
				{
					$cookie_name=Key($cookies);
					$headers[$h].=" ".$cookie_name."=".$cookies[$cookie_name]["value"].";";
				}
			}
		}
		$next_state = "RequestSent";
		if($this->use_curl)
		{
			if(IsSet($arguments['StreamRequest']))
				return($this->SetError("Streaming request data is not supported when using Curl", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			if($body_length
			&& strlen($this->request_body)==0)
			{
				for($request_body="",$success=1,$part=0;$part<count($post_parts);$part++)
				{
					$request_body.=$post_parts[$part]["HEADERS"].$post_parts[$part]["DATA"];
					if(IsSet($post_parts[$part]["FILENAME"]))
					{
						if(!($file=@fopen($post_parts[$part]["FILENAME"],"rb")))
						{
							$this->SetPHPError("could not open upload file ".$post_parts[$part]["FILENAME"], $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
							$success=0;
							break;
						}
						while(!feof($file))
						{
							if(GetType($block=@fread($file,$this->file_buffer_length))!="string")
							{
								$this->SetPHPError("could not read upload file", $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
								$success=0;
								break;
							}
							$request_body.=$block;
						}
						fclose($file);
						if(!$success)
							break;
					}
					$request_body.="\r\n";
				}
				$request_body.="--".$boundary."--\r\n";
			}
			else
				$request_body=$this->request_body;
			curl_setopt($this->connection,CURLOPT_HEADER,1);
			curl_setopt($this->connection,CURLOPT_RETURNTRANSFER,1);
			if($this->timeout)
				curl_setopt($this->connection,CURLOPT_TIMEOUT,$this->timeout);
			curl_setopt($this->connection,CURLOPT_SSL_VERIFYPEER,0);
			curl_setopt($this->connection,CURLOPT_SSL_VERIFYHOST,0);
			$request=$this->request."\r\n".implode("\r\n",$headers)."\r\n\r\n".$request_body;
			curl_setopt($this->connection,CURLOPT_CUSTOMREQUEST,$request);
			if($this->debug)
				$this->OutputDebug("C ".$request);
			if(!($success=(strlen($this->response=curl_exec($this->connection))!=0)))
			{
				$error=curl_error($this->connection);
				$this->SetError("Could not execute the request".(strlen($error) ? ": ".$error : ""), HTTP_CLIENT_ERROR_PROTOCOL_FAILURE);
			}
		}
		else
		{
			if(($success=$this->PutLine($this->request)))
			{
				for($header=0;$header<count($headers);$header++)
				{
					if(!$success=$this->PutLine($headers[$header]))
						break;
				}
				if($success
				&& ($success=$this->PutLine("")))
				{
					if(IsSet($arguments['StreamRequest']))
						$next_state = "SendingRequestBody";
					elseif($body_length)
					{
						if(strlen($this->request_body))
							$success=$this->PutData($this->request_body);
						else
						{
							for($part=0;$part<count($post_parts);$part++)
							{
								if(!($success=$this->PutData($post_parts[$part]["HEADERS"]))
								|| !($success=$this->PutData($post_parts[$part]["DATA"])))
									break;
								if(IsSet($post_parts[$part]["FILENAME"]))
								{
									if(!($file=@fopen($post_parts[$part]["FILENAME"],"rb")))
									{
										$this->SetPHPError("could not open upload file ".$post_parts[$part]["FILENAME"], $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
										$success=0;
										break;
									}
									while(!feof($file))
									{
										if(GetType($block=@fread($file,$this->file_buffer_length))!="string")
										{
											$this->SetPHPError("could not read upload file", $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
											$success=0;
											break;
										}
										if(!($success=$this->PutData($block)))
											break;
									}
									fclose($file);
									if(!$success)
										break;
								}
								if(!($success=$this->PutLine("")))
									break;
							}
							if($success)
								$success=$this->PutLine("--".$boundary."--");
						}
						if($success)
							$sucess=$this->FlushData();
					}
				}
			}
		}
		if(!$success)
			return($this->SetError("could not send the HTTP request: ".$this->error, $this->error_code));
		$this->state=$next_state;
		return("");
	}

	Function SetCookie($name, $value, $expires="" , $path="/" , $domain="" , $secure=0, $verbatim=0)
	{
		if(strlen($this->error))
			return($this->error);
		if(strlen($name)==0)
			return($this->SetError("it was not specified a valid cookie name", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		if(strlen($path)==0
		|| strcmp($path[0],"/"))
			return($this->SetError($path." is not a valid path for setting cookie ".$name, HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		if($domain==""
		|| !strpos($domain,".",$domain[0]=="." ? 1 : 0))
			return($this->SetError($domain." is not a valid domain for setting cookie ".$name, HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		$domain=strtolower($domain);
		if(!strcmp($domain[0],"."))
			$domain=substr($domain,1);
		if(!$verbatim)
		{
			$name=$this->CookieEncode($name,1);
			$value=$this->CookieEncode($value,0);
		}
		$secure=intval($secure);
		$this->cookies[$secure][$domain][$path][$name]=array(
			"name"=>$name,
			"value"=>$value,
			"domain"=>$domain,
			"path"=>$path,
			"expires"=>$expires,
			"secure"=>$secure
		);
		return("");
	}

	Function SendRequestBody($data, $end_of_data)
	{
		if(strlen($this->error))
			return($this->error);
		switch($this->state)
		{
			case "Disconnected":
				return($this->SetError("connection was not yet established", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "Connected":
			case "ConnectedToProxy":
				return($this->SetError("request was not sent", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "SendingRequestBody":
				break;
			case "RequestSent":
				return($this->SetError("request body was already sent", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			default:
				return($this->SetError("can not send the request body in the current connection state", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		}
		$length = strlen($data);
		if($length)
		{
			$size = dechex($length)."\r\n";
			if(!$this->PutData($size)
			|| !$this->PutData($data))
				return($this->error);
		}
		if($end_of_data)
		{
			$size = "0\r\n";
			if(!$this->PutData($size))
				return($this->error);
			$this->state = "RequestSent";
		}
		return("");
	}

	Function ReadReplyHeadersResponse(&$headers)
	{
		$headers=array();
		if(strlen($this->error))
			return($this->error);
		switch($this->state)
		{
			case "Disconnected":
				return($this->SetError("connection was not yet established", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "Connected":
				return($this->SetError("request was not sent", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "ConnectedToProxy":
				return($this->SetError("connection from the remote server from the proxy was not yet established", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "SendingRequestBody":
				return($this->SetError("request body data was not completely sent", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "ConnectSent":
				$connect = 1;
				break;
			case "RequestSent":
				$connect = 0;
				break;
			default:
				return($this->SetError("can not get request headers in the current connection state", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		}
		$this->content_length=$this->read_length=$this->read_response=$this->remaining_chunk=0;
		$this->content_length_set=$this->chunked=$this->last_chunk_read=$chunked=0;
		$this->force_close = $this->connection_close=0;
		for($this->response_status="";;)
		{
			$line=$this->GetLine();
			if(GetType($line)!="string")
				return($this->SetError("could not read request reply: ".$this->error, $this->error_code));
			if(strlen($this->response_status)==0)
			{
				if(!preg_match($match="/^http\\/[0-9]+\\.[0-9]+[ \t]+([0-9]+)[ \t]*(.*)\$/i",$line,$matches))
					return($this->SetError("it was received an unexpected HTTP response status", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
				$this->response_status=$matches[1];
				$this->response_message=$matches[2];
				if($this->response_status == 204)
				{
					$this->content_length = 0;
					$this->content_length_set = 1;
				}
			}
			if($line=="")
			{
				if(strlen($this->response_status)==0)
					return($this->SetError("it was not received HTTP response status", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
				$this->state=($connect ? "GotConnectHeaders" : "GotReplyHeaders");
				break;
			}
			$header_name=strtolower($this->Tokenize($line,":"));
			$header_value=Trim(Chop($this->Tokenize("\r\n")));
			if(IsSet($headers[$header_name]))
			{
				if(GetType($headers[$header_name])=="string")
					$headers[$header_name]=array($headers[$header_name]);
				$headers[$header_name][]=$header_value;
			}
			else
				$headers[$header_name]=$header_value;
			if(!$connect)
			{
				switch($header_name)
				{
					case "content-length":
						$this->content_length=intval($headers[$header_name]);
						$this->content_length_set=1;
						break;
					case "transfer-encoding":
						$encoding=$this->Tokenize($header_value,"; \t");
						if(!$this->use_curl
						&& !strcmp($encoding,"chunked"))
							$chunked=1;
						break;
					case "set-cookie":
						if($this->support_cookies)
						{
							if(GetType($headers[$header_name])=="array")
								$cookie_headers=$headers[$header_name];
							else
								$cookie_headers=array($headers[$header_name]);
							for($cookie=0;$cookie<count($cookie_headers);$cookie++)
							{
								$cookie_name=trim($this->Tokenize($cookie_headers[$cookie],"="));
								$cookie_value=$this->Tokenize(";");
								$domain=$this->request_host;
								$path="/";
								$expires="";
								$secure=0;
								while(($name = strtolower(trim(UrlDecode($this->Tokenize("=")))))!="")
								{
									$value=UrlDecode($this->Tokenize(";"));
									switch($name)
									{
										case "domain":
											$domain=$value;
											break;
										case "path":
											$path=$value;
											break;
										case "expires":
											if(preg_match("/^((Mon|Monday|Tue|Tuesday|Wed|Wednesday|Thu|Thursday|Fri|Friday|Sat|Saturday|Sun|Sunday), )?([0-9]{2})\\-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\-([0-9]{2,4}) ([0-9]{2})\\:([0-9]{2})\\:([0-9]{2}) GMT\$/",$value,$matches))
											{
												$year=intval($matches[5]);
												if($year<1900)
													$year+=($year<70 ? 2000 : 1900);
												$expires="$year-".$this->months[$matches[4]]."-".$matches[3]." ".$matches[6].":".$matches[7].":".$matches[8];
											}
											break;
										case "secure":
											$secure=1;
											break;
									}
								}
								if(strlen($this->SetCookie($cookie_name, $cookie_value, $expires, $path , $domain, $secure, 1)))
									$this->error="";
							}
						}
						break;
					case "connection":
						$this->force_close = $this->connection_close=!strcmp(strtolower($header_value),"close");
						break;
				}
			}
		}
		$this->chunked=$chunked;
		if($this->content_length_set)
			$this->connection_close=0;
		return("");
	}

	Function Redirect(&$headers)
	{
		if($this->follow_redirect)
		{
			if(!IsSet($headers["location"])
			|| (GetType($headers["location"])!="array"
			&& strlen($location=$headers["location"])==0)
			|| (GetType($headers["location"])=="array"
			&& strlen($location=$headers["location"][0])==0))
				return($this->SetError("it was received a redirect without location URL", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
			if(strcmp($location[0],"/"))
			{
				if(!($location_arguments=@parse_url($location)))
					return($this->SetError("the server did not return a valid redirection location URL", HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
				if(!IsSet($location_arguments["scheme"]))
					$location=((GetType($end=strrpos($this->request_uri,"/"))=="integer" && $end>1) ? substr($this->request_uri,0,$end) : "")."/".$location;
			}
			if(!strcmp($location[0],"/"))
				$location=$this->protocol."://".$this->host_name.($this->host_port ? ":".$this->host_port : "").$location;
			$error=$this->GetRequestArguments($location,$arguments);
			if(strlen($error))
				return($this->SetError("could not process redirect url: ".$error, HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
			$arguments["RequestMethod"]="GET";
			if(strlen($error=$this->Close())==0
			&& strlen($error=$this->Open($arguments))==0
			&& strlen($error=$this->SendRequest($arguments))==0)
			{
				$this->redirection_level++;
				if($this->redirection_level>$this->redirection_limit)
				{
					$error="it was exceeded the limit of request redirections";
					$this->error_code = HTTP_CLIENT_ERROR_PROTOCOL_FAILURE;
				}
				else
					$error=$this->ReadReplyHeaders($headers);
				$this->redirection_level--;
			}
			if(strlen($error))
				return($this->SetError($error, $this->error_code));
		}
		return("");
	}

	Function Authenticate(&$headers, $proxy, &$proxy_authorization, &$user, &$password, &$realm, &$workstation)
	{
		if($proxy)
		{
			$authenticate_header="proxy-authenticate";
			$authorization_header="Proxy-Authorization";
			$authenticate_status="407";
			$authentication_mechanism=$this->proxy_authentication_mechanism;
		}
		else
		{
			$authenticate_header="www-authenticate";
			$authorization_header="Authorization";
			$authenticate_status="401";
			$authentication_mechanism=$this->authentication_mechanism;
		}
		if(IsSet($headers[$authenticate_header])
		&& $this->sasl_authenticate)
		{
			if(function_exists("class_exists")
			&& !class_exists("sasl_client_class"))
				return($this->SetError("the SASL client class needs to be loaded to be able to authenticate".($proxy ? " with the proxy server" : "")." and access this site", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			if(GetType($headers[$authenticate_header])=="array")
				$authenticate=$headers[$authenticate_header];
			else
				$authenticate=array($headers[$authenticate_header]);
			for($response="", $mechanisms=array(),$m=0;$m<count($authenticate);$m++)
			{
				$mechanism=$this->Tokenize($authenticate[$m]," ");
				$response=$this->Tokenize("");
				if(strlen($authentication_mechanism))
				{
					if(!strcmp($authentication_mechanism,$mechanism))
					{
						$mechanisms[]=$mechanism;
						break;
					}
				}
				else
					$mechanisms[]=$mechanism;
			}
			$sasl=new sasl_client_class($this->env); //<<<<
			if(IsSet($user))
				$sasl->SetCredential("user",$user);
			if(IsSet($password))
				$sasl->SetCredential("password",$password);
			if(IsSet($realm))
				$sasl->SetCredential("realm",$realm);
			if(IsSet($workstation))
				$sasl->SetCredential("workstation",$workstation);
			$sasl->SetCredential("uri",$this->request_uri);
			$sasl->SetCredential("method",$this->request_method);
			$sasl->SetCredential("session",$this->session);
			do
			{
				$status=$sasl->Start($mechanisms,$message,$interactions);
			}
			while($status==SASL_INTERACT);
			switch($status)
			{
				case SASL_CONTINUE:
					break;
				case SASL_NOMECH:
					return($this->SetError(($proxy ? "proxy " : "")."authentication error: ".(strlen($authentication_mechanism) ? "authentication mechanism ".$authentication_mechanism." may not be used: " : "").$sasl->error, HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
				default:
					return($this->SetError("Could not start the SASL ".($proxy ? "proxy " : "")."authentication client: ".$sasl->error, HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			}
			if($proxy >= 0)
			{
				for(;;)
				{
					if(strlen($error=$this->ReadReplyBody($body,$this->file_buffer_length)))
						return($error);
					if(strlen($body)==0)
						break;
				}
			}
			$authorization_value=$sasl->mechanism.(IsSet($message) ? " ".($sasl->encode_response ? base64_encode($message) : $message) : "");
			$request_arguments=$this->request_arguments;
			$arguments=$request_arguments;
			$arguments["Headers"][$authorization_header]=$authorization_value;
			if(!$proxy
			&& strlen($proxy_authorization))
				$arguments["Headers"]["Proxy-Authorization"]=$proxy_authorization;
			if(strlen($error=$this->Close())
			|| strlen($error=$this->Open($arguments)))
				return($this->SetError($error, $this->error_code));
			$authenticated=0;
			if(IsSet($message))
			{
				if($proxy < 0)
				{
					if(strlen($error=$this->ConnectFromProxy($arguments, $headers)))
						return($this->SetError($error, $this->error_code));
				}
				else
				{
					if(strlen($error=$this->SendRequest($arguments))
					|| strlen($error=$this->ReadReplyHeadersResponse($headers)))
						return($this->SetError($error, $this->error_code));
				}
				if(!IsSet($headers[$authenticate_header]))
					$authenticate=array();
				elseif(GetType($headers[$authenticate_header])=="array")
					$authenticate=$headers[$authenticate_header];
				else
					$authenticate=array($headers[$authenticate_header]);
				for($mechanism=0;$mechanism<count($authenticate);$mechanism++)
				{
					if(!strcmp($this->Tokenize($authenticate[$mechanism]," "),$sasl->mechanism))
					{
						$response=$this->Tokenize("");
						break;
					}
				}
				switch($this->response_status)
				{
					case $authenticate_status:
						break;
					case "301":
					case "302":
					case "303":
					case "307":
						if($proxy >= 0)
							return($this->Redirect($headers));
					default:
						if(intval($this->response_status/100)==2)
						{
							if($proxy)
								$proxy_authorization=$authorization_value;
							$authenticated=1;
							break;
						}
						if($proxy
						&& !strcmp($this->response_status,"401"))
						{
							$proxy_authorization=$authorization_value;
							$authenticated=1;
							break;
						}
						return($this->SetError(($proxy ? "proxy " : "")."authentication error: ".$this->response_status." ".$this->response_message, HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
				}
			}
			for(;!$authenticated;)
			{
				do
				{
					$status=$sasl->Step($response,$message,$interactions);
				}
				while($status==SASL_INTERACT);
				switch($status)
				{
					case SASL_CONTINUE:
						$authorization_value=$sasl->mechanism.(IsSet($message) ? " ".($sasl->encode_response ? base64_encode($message) : $message) : "");
						$arguments=$request_arguments;
						$arguments["Headers"][$authorization_header]=$authorization_value;
						if(!$proxy
						&& strlen($proxy_authorization))
							$arguments["Headers"]["Proxy-Authorization"]=$proxy_authorization;
						if($proxy < 0)
						{
							if(strlen($error=$this->ConnectFromProxy($arguments, $headers)))
								return($this->SetError($error, $this->error_code));
						}
						else
						{
							if(strlen($error=$this->SendRequest($arguments))
							|| strlen($error=$this->ReadReplyHeadersResponse($headers)))
								return($this->SetError($error, $this->error_code));
						}
						switch($this->response_status)
						{
							case $authenticate_status:
								if(GetType($headers[$authenticate_header])=="array")
									$authenticate=$headers[$authenticate_header];
								else
									$authenticate=array($headers[$authenticate_header]);
								for($response="",$mechanism=0;$mechanism<count($authenticate);$mechanism++)
								{
									if(!strcmp($this->Tokenize($authenticate[$mechanism]," "),$sasl->mechanism))
									{
										$response=$this->Tokenize("");
										break;
									}
								}
								if($proxy >= 0)
								{
									for(;;)
									{
										if(strlen($error=$this->ReadReplyBody($body,$this->file_buffer_length)))
											return($error);
										if(strlen($body)==0)
											break;
									}
								}
								$this->state="Connected";
								break;
							case "301":
							case "302":
							case "303":
							case "307":
								if($proxy >= 0)
									return($this->Redirect($headers));
							default:
								if(intval($this->response_status/100)==2)
								{
									if($proxy)
										$proxy_authorization=$authorization_value;
									$authenticated=1;
									break;
								}
								if($proxy
								&& !strcmp($this->response_status,"401"))
								{
									$proxy_authorization=$authorization_value;
									$authenticated=1;
									break;
								}
								return($this->SetError(($proxy ? "proxy " : "")."authentication error: ".$this->response_status." ".$this->response_message));
						}
						break;
					default:
						return($this->SetError("Could not process the SASL ".($proxy ? "proxy " : "")."authentication step: ".$sasl->error, HTTP_CLIENT_ERROR_PROTOCOL_FAILURE));
				}
			}
		}
		return("");
	}
	
	Function ReadReplyHeaders(&$headers)
	{
		if(strlen($error=$this->ReadReplyHeadersResponse($headers)))
			return($error);
		$proxy_authorization="";
		while(!strcmp($this->response_status, "100"))
		{
			$this->state="RequestSent";
			if(strlen($error=$this->ReadReplyHeadersResponse($headers)))
				return($error);
		}
		switch($this->response_status)
		{
			case "301":
			case "302":
			case "303":
			case "307":
				if(strlen($error=$this->Redirect($headers)))
					return($error);
				break;
			case "407":
				if(strlen($error=$this->Authenticate($headers, 1, $proxy_authorization, $this->proxy_request_user, $this->proxy_request_password, $this->proxy_request_realm, $this->proxy_request_workstation)))
					return($error);
				if(strcmp($this->response_status,"401"))
					return("");
			case "401":
				return($this->Authenticate($headers, 0, $proxy_authorization, $this->request_user, $this->request_password, $this->request_realm, $this->request_workstation));
		}
		return("");
	}

	Function ReadReplyBody(&$body,$length)
	{
		$body="";
		if(strlen($this->error))
			return($this->error);
		switch($this->state)
		{
			case "Disconnected":
				return($this->SetError("connection was not yet established", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "Connected":
			case "ConnectedToProxy":
				return($this->SetError("request was not sent", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			case "RequestSent":
				if(($error=$this->ReadReplyHeaders($headers))!="")
					return($error);
				break;
			case "GotReplyHeaders":
				break;
			case 'ResponseReceived':
				$body = '';
				return('');
			default:
				return($this->SetError("can not get request headers in the current connection state", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
		}
		if($this->content_length_set)
			$length=min($this->content_length-$this->read_length,$length);
		$body = '';
		if($length>0)
		{
			if(!$this->EndOfInput()
			&& ($body=$this->ReadBytes($length))=="")
			{
				if(strlen($this->error))
					return($this->SetError("could not get the request reply body: ".$this->error, $this->error_code));
			}
			$this->read_length+=strlen($body);
			if($this->EndOfInput())
				$this->state = 'ResponseReceived';
		}
		return("");
	}

	Function ReadWholeReplyBody(&$body)
	{
		$body = '';
		for(;;)
		{
			if(strlen($error = $this->ReadReplyBody($block, $this->file_buffer_length)))
				return($error);
			if(strlen($block) == 0)
				return('');
			$body .= $block;
		}
	}

	Function ReadWholeReplyIntoTemporaryFile(&$file)
	{
		if(!($file = tmpfile()))
			return $this->SetPHPError('could not create the temporary file to save the response', $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
		for(;;)
		{
			if(strlen($error = $this->ReadReplyBody($block, $this->file_buffer_length)))
			{
				fclose($file);
				return($error);
			}
			if(strlen($block) == 0)
			{
				if(@fseek($file, 0) != 0)
				{
					$error = $this->SetPHPError('could not seek to the beginning of temporary file with the response', $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
					fclose($file);
					return $error;
				}
				return('');
			}
			if(!@fwrite($file, $block))
			{
				$error = $this->SetPHPError('could not write to the temporary file to save the response', $php_errormsg, HTTP_CLIENT_ERROR_CANNOT_ACCESS_LOCAL_FILE);
				fclose($file);
				return $error;
			}
		}
	}

	Function SaveCookies(&$cookies, $domain='', $secure_only=0, $persistent_only=0)
	{
		$now=gmdate("Y-m-d H-i-s");
		$cookies=array();
		for($secure_cookies=0,Reset($this->cookies);$secure_cookies<count($this->cookies);Next($this->cookies),$secure_cookies++)
		{
			$secure=Key($this->cookies);
			if(!$secure_only
			|| $secure)
			{
				for($cookie_domain=0,Reset($this->cookies[$secure]);$cookie_domain<count($this->cookies[$secure]);Next($this->cookies[$secure]),$cookie_domain++)
				{
					$domain_pattern=Key($this->cookies[$secure]);
					$match=strlen($domain)-strlen($domain_pattern);
					if(strlen($domain)==0
					|| ($match>=0
					&& !strcmp($domain_pattern,substr($domain,$match))
					&& ($match==0
					|| $domain_pattern[0]=="."
					|| $domain[$match-1]==".")))
					{
						for(Reset($this->cookies[$secure][$domain_pattern]),$path_part=0;$path_part<count($this->cookies[$secure][$domain_pattern]);Next($this->cookies[$secure][$domain_pattern]),$path_part++)
						{
							$path=Key($this->cookies[$secure][$domain_pattern]);
							for(Reset($this->cookies[$secure][$domain_pattern][$path]),$cookie=0;$cookie<count($this->cookies[$secure][$domain_pattern][$path]);Next($this->cookies[$secure][$domain_pattern][$path]),$cookie++)
							{
								$cookie_name=Key($this->cookies[$secure][$domain_pattern][$path]);
								$expires=$this->cookies[$secure][$domain_pattern][$path][$cookie_name]["expires"];
								if((!$persistent_only
								&& strlen($expires)==0)
								|| (strlen($expires)
								&& strcmp($now,$expires)<0))
									$cookies[$secure][$domain_pattern][$path][$cookie_name]=$this->cookies[$secure][$domain_pattern][$path][$cookie_name];
							}
						}
					}
				}
			}
		}
	}

	Function SavePersistentCookies(&$cookies, $domain='', $secure_only=0)
	{
		$this->SaveCookies($cookies, $domain, $secure_only, 1);
	}

	Function GetPersistentCookies(&$cookies, $domain='', $secure_only=0)
	{
		$this->SavePersistentCookies($cookies, $domain, $secure_only);
	}

	Function RestoreCookies($cookies, $clear=1)
	{
		$new_cookies=($clear ? array() : $this->cookies);
		for($secure_cookies=0, Reset($cookies); $secure_cookies<count($cookies); Next($cookies), $secure_cookies++)
		{
			$secure=Key($cookies);
			if(GetType($secure)!="integer")
				return($this->SetError("invalid cookie secure value type (".serialize($secure).")", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
			for($cookie_domain=0,Reset($cookies[$secure]);$cookie_domain<count($cookies[$secure]);Next($cookies[$secure]),$cookie_domain++)
			{
				$domain_pattern=Key($cookies[$secure]);
				if(GetType($domain_pattern)!="string")
					return($this->SetError("invalid cookie domain value type (".serialize($domain_pattern).")", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
				for(Reset($cookies[$secure][$domain_pattern]),$path_part=0;$path_part<count($cookies[$secure][$domain_pattern]);Next($cookies[$secure][$domain_pattern]),$path_part++)
				{
					$path=Key($cookies[$secure][$domain_pattern]);
					if(GetType($path)!="string"
					|| strcmp(substr($path, 0, 1), "/"))
						return($this->SetError("invalid cookie path value type (".serialize($path).")", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
					for(Reset($cookies[$secure][$domain_pattern][$path]),$cookie=0;$cookie<count($cookies[$secure][$domain_pattern][$path]);Next($cookies[$secure][$domain_pattern][$path]),$cookie++)
					{
						$cookie_name=Key($cookies[$secure][$domain_pattern][$path]);
						$expires=$cookies[$secure][$domain_pattern][$path][$cookie_name]["expires"];
						$value=$cookies[$secure][$domain_pattern][$path][$cookie_name]["value"];
						if(GetType($expires)!="string"
						|| (strlen($expires)
						&& !preg_match("/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}\$/", $expires)))
							return($this->SetError("invalid cookie expiry value type (".serialize($expires).")", HTTP_CLIENT_ERROR_INVALID_PARAMETERS));
						$new_cookies[$secure][$domain_pattern][$path][$cookie_name]=array(
							"name"=>$cookie_name,
							"value"=>$value,
							"domain"=>$domain_pattern,
							"path"=>$path,
							"expires"=>$expires,
							"secure"=>$secure
						);
					}
				}
			}
		}
		$this->cookies=$new_cookies;
		return("");
	}
};

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
$__DPCSEC['RESOURCES_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("RESOURCES_DPC")) {
define("RESOURCES_DPC",true);

$__DPC['RESOURCES_DPC'] = 'resources';

class resources {

   var $_resources, $_resptr;
   var $ip2get, $port2get;
   var $env;
   var $daemon_port;

   function resources($env=null) {
   
      $this->env = $env;
   
      $this->_resources = array();   
      $this->_resptr = array();	
	  
	  $this->ip2get = $env->phpdac_ip; 
	  //echo 'zzzz',$this->ip2get,'ccccc',$this->port2get; 
	  $this->port2get = $env->phpdac_port; //dac server port 
	  $this->daemon_port = $env->daemon_port;//clients port
   }
  
   function set_resource($rname,$resource) {
   
      //in case of resource name with spaces
      $rname = str_replace(' ','_',$rname);

	  /*if (empty($resource)) {// network error
	      echo 'zzz';
	  	  print_r($this->_resources);
	  }   
	  else*/if (is_object($resource)) {
		//echo 'RESOURCE object:'.$rname. '(' . memory_get_usage() .")\n";
	    $this->_resources[$rname] = serialize($resource);//serialized object???
		$this->_resptr[$rname] = & $resource;//object instance		
		//print_r($this->_resources);	
	    $this->env->update_agent($this,'resources');			
		
		return true;
	  }
	  elseif (is_resource($resource)) {
        //echo 'RESOURCE resource:'.$rname. '(' . memory_get_usage() .")\n";
	    $type = get_resource_type($resource);
		$this->_resources[$type] = $rname;
		$this->_resptr[$type] = & $resource;
	    //print_r($this->_resptr);
		//print_r($this->_resources);
	    $this->env->update_agent($this,'resources');
   
		return true;
	  }
	  elseif (is_scalar($resource)) {//integer,float,string,boolean
	    //echo 'RESOURCE scalar:'.$rname. '(' . memory_get_usage() .")\n";
	    $this->_resources[$rname] = $resource;
	    $this->_resptr[$rname] = & $resource;	
		//print_r($this->_resources);		
	    $this->env->update_agent($this,'resources');			
	    //echo '>>>',$resource;
	    return true;
	  }
      echo "WARNING:resource [$rname] failed to register!\r\n";
	  return false;
   }
   
   //delete local resource
   function del_resource($resource) {
   
     if (array_key_exists($resource,$this->_resources)) {
	 
	    unset($this->_resources[$resource]);
	    unset($this->_resptr[$resource]);
	 }
   }
   
   //local version
   //name called by stream of server
   function &get_resource($resource,$name=null) {
   
	   //print_r($this->_resources); 
	   //print_r($this->_resptr);	    
	    
       //auto get from net 
	   //if no resource or invalid resource...
       if (!array_key_exists($resource,$this->_resources)) {
		   
	     $r = $this->get_resourcec($resource,$this->ip2get,$this->port2get);
		 
		 if ($r) {
		   if ($rp = $this->create_resource($resource,$r))//if create physical resource
             $this->set_resource($r,$rp);//save it to local resource table		 
		   else //else scalar 
		     $this->set_resource($resource,$r);//save it to local resource table	
		    	 
		   echo 'remote:[',$this->ip2get,']:',$resource,"\n";
		 }
	   }
	   /*elseif ($res = file_get_contents("phpres5://192.168.1.35:19125/" . $resource)) {
	     echo 'ooouuura!!!!!';
		 echo 'remote:[','192.168.1.35',']:',$resource,"\n";
		 return ($res);
	   }*/
	   else {
	     if (!$this->_resptr[$resource])
	       $rp = $this->create_resource($resource,$this->_resources[$resource]); 
		 else  
		   $rp = $this->_resptr[$resource];
	     echo 'local:',$resource,"\n";
	   }	 
		 
	   //print_r($this->_resources);
	   //print_r($this->_resptr);	    		 	 
	    
	   if ($name!=null)
	     return ($this->_resources[$resource]); //get parameter to re-assign resource in client
	   else
		 return ($rp);
	 
	    	 
	   //else search the net for the specified resource.....	 
	   //or..autometed
	   //get it from server (default)
		 
	   return false;	 
   }
   
   //remote version
   function get_resourcec($resource,$from=null,$port=null) {
   
      $ip = ($from?$from:$this->ip2get);
	  $po = ($port?$port:$this->port2get);
	   
      //if (!$port)
	    //$port = '19123';//server port = default connection
		
	  //echo $from,':',$port;
      //get resource
      $f_res = @file_get_contents("phpres5://$ip:$po/" . $resource);
	  
	  $tokens = explode($resource,$f_res);//explode based on word of resource
	  $s_res = $tokens[1];
      //echo '>',$s_res,'<';   
	  
	  //copy it in local resources array
	  if ($r=trim($s_res)) {

	    //$this->create_resource($resource,$r); //PRINTER DLL?????
	    return ($r);
	  }
	  
	  return false;	
   }
   
   function unset_resource($resource_name) {
   
       //if (in_array($resource_name,$this->_resources))
	     //remove resource by value!!!!!
		 
	   return false;	 
   }
   
   function &create_resource($resource_name,$resource_string) {
   
      switch ($resource_name) {
	  
	    case 'printer' : $resource = printer_open($resource_string);//true;
	                     if (is_resource($resource) &&
		                   get_resource_type($resource)=='printer') {
	                       printer_set_option($resource, PRINTER_MODE, 'RAW'); 
		                   //echo ">>>>>>>>>>>>",$resource_string,">>>>\n";
		                  // $this->set_resource($resource_string,$resource);
	                     }	
		                 break; 
		
		case 'odbc link':				 
		case 'odbc link persistent' : echo 'zzz';break;
		
		case 'sqlite'  : $db_name = $this->get_resource('sqlite_name');
		                 $resource = new SQLiteDatabase($db_name, 0666, $sqliteerror);				  
						 if ($sqliteerror) echo 'ERROR:',$sqliteerror,'\n';
						 
		default        : //scalar
		                 //if (is_scalar($resource_string))
		                   //$this->set_resource($resource_name,$resource_string);	
						   
						 //DO NOTHING....  
						   			 
	  }
	  
	  return ($resource);
   } 
   
  //show the resources running ........ 
  function showresources() {
     //print_r($this->_resources);
	 //echo 'z';
     foreach ($this->_resources as $t=>$d) {
	   //$ret .= "[" . $t . "]\r\n";
	   $ret .= $t . "=" . $d;
	   if (is_object($this->_resptr[$t]))
	     $ret .= " (object) " . get_class($this->_resptr[$t]) . "\r\n";
	   else
	     $ret .= " (scalar) " . $this->_resptr[$t] . "\r\n";
	 }  
  
     return ($ret);  
  } 
  
  function has_resource($resource) {
  
     if (!array_key_exists($resource,$this->_resources)) 
	   return false;
	 else
	   return true;  
  } 
  
  function findresource($resource,$showname=null) {
  
  
    /* if (!$res=$this->get_resource($resource,$showname)) {//local
  
       $connections = $this->env->show_connections(null,1);
	   //print_r($connections);
	   //echo "---------------\n";
	 
	   if (is_array($connections)) {//remote
	     foreach ($connections as $s=>$sd) {
	       $hosts[] = $sd['host'];
		 
		   if (($sd['host']!='127.0.0.1') && //localhost
		       ($sd['host']!=$this->ip2get) && //bypass remote master
			   ($sd['host']!='192.168.1.35')) {//real self address
	         if ($res = $this->get_resourcec($resource,$sd['host'],$this->daemon_port)) {
		     
		       echo $sd['host'],":",$res,"\r\n"; 		 
			   break;
		     }
		   }  
	     }
	   
	     echo implode("\r\n",array_unique($hosts));	
	   }
	 }//local*/
	 echo 'zzzzzzzzzz';
	 //$res = $this->get_resourcec($resource,'192.168.1.247','19125');
	 $res = file_get_contents("phpres5://192.168.1.247:19125/" . $resource);
	 
	 
		/*$socket = pfsockopen('192.168.1.247', '19125', $errno, $errstr, 5); 

		if (!$socket) {
		  echo $errstr,"(",$errno,")\n";
		  return false;
		}
		//stream_set_blocking($socket,1);
		$request = "getresource xx" . "\r\n\r\n";		
        fputs($socket, $request); 

        $res = ''; 
        while (!feof($socket)) { 
          $res .= fgets($socket, 1096);
        }  
        fclose($socket);*/  	 
	 
	 echo 'end';
	 
	 return ($res);
  
  }  
  
};
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
$__DPCSEC['SCHEDULER_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("SCHEDULER_DPC")) {
define("SCHEDULER_DPC",true);

$__DPC['SCHEDULER_DPC'] = 'scheduler';

class scheduler {

   var $timeline, $env;
 
   function scheduler($env=null) {
   
	 //var_dump($env->agn_addr);   
   
     $this->timeline = array();
	 $this->env = $env;
	 
	 //no need (see schedule method)
     //register_tick_function(array(&$this,"checkschedules"),true);		 
   }
   
	function agents() {
	
	  print_r($this->env->agn_addr);
	}   
   
   public function schedule($agent,$frequency,$time) {
   
     $schedules = array();
     $schedules['agent'] = $agent;
	 
	 switch ($frequency) {
		case 'at'    : $schedules['freq'] = 0; break; //once
		case 'every' : $schedules['freq'] = 1; break; //cycle
		default      : $schedules['freq'] =-1; break; //now
 	 }
	 
	 $schedules['time'] = $time;
	 
	 $timein = time();
	 //due to speed up it is possible to have
	 //multiple schedules entry in the same time, so add 1 sec
	 if (array_key_exists($timein,$this->timeline))
	   $this->timeline[$timein+1] = $schedules;  
	 else
	   $this->timeline[$timein] = $schedules; 
	 
	 //$this->env->update_agent($this,'scheduler'); must called by caller to update env
	 //print_r($this->timeline); //test scheduler
	 //var_dump($this);
	 
	 $this->env->update_agent($this,'scheduler');
	 
	 //re-register
	 unregister_tick_function(array(&$this,"checkschedules"));
     register_tick_function(array(&$this,"checkschedules"),true);	 	 
   }
   
   public function checkschedules() {
   
     //echo "check schedules....";
	 //print_r($this->timeline);	 
	 //echo time(),"\n"; 	 
	 
	 $new_timeline = array();
	 $error = null;
	 
	 foreach ($this->timeline as $inittime=>$entry) {
	   
	   $new_element = $this->check_schedule_entry($entry,$inittime);
	   //print_r($new_element);echo 'cccc';
	   
	   if (is_array($new_element)) 
		 $new_timeline[$inittime] = $new_element;
	   else
	     $error = $new_element;	 
	 }
	 
	 //print_r($new_timeline);
	 //reconf timeline
	 //$this->timeline = null;
	 if (!empty($new_timeline))
	   $this->timeline = (array)$new_timeline;
	   
	 $ret = $error. '> check schedules... '. time();  
	 return ($ret);  
   }
   
   function check_schedule_entry(&$entry,$inittime) {  
   
     //echo $this->env->get_agent('scheduledtask')->value;
	 //echo ".\n";   
   
     if (array_key_exists('lasttime',$entry))
	   $last_time = $entry['lasttime'];
	 else
	   $last_time = $inittime;
	 
	 $agn = explode('.',$entry['agent']);
	 $agent = $agn[0];
	 $cmd = $agn[1]; 
	  
	 $now = time();  
	 if ($now-$last_time>=$entry['time']) {
	 
	   //echo $agent,"...\n";
	   $o_agent = $this->env->get_agent($agent);	 
       //print_r($o_agent);
	   if (is_object($o_agent)) {   

		  if (method_exists($o_agent,$cmd)) 
		    $ret = $o_agent->$cmd();
		  else
		    $ret = "Invalid command.\n" . var_dump(get_class_methods($o_agent));  
		  
		  $this->env->dmn->Println ($ret);  
	   	   
	      $entry['lasttime'] = $now;
		  $entry['counter'] = $entry['counter']+1;
		  
	      //$this->env->update_agent($this,'scheduler');		  
	   
	      return ($entry['freq']==0) ? 0 : $entry;//once or new array element 	   
	   }
	   else {
	     //in case of 'env' execute from env'
		 if (($agent=='env') && (method_exists($this->env,$cmd))) {

			$ret = $this->env->$cmd(); 
			$this->env->dmn->Println ($ret);

			$entry['lasttime'] = $now;
			$entry['counter'] = $entry['counter']+1;
		  
			//$this->env->update_agent($this,'scheduler');		  
	   
			return ($entry['freq']==0) ? 0 : $entry;//once or new array element 			   
		 }
		 else {
			 //dmn dispatch, batch files, commands, etc
			 $this->env->dmn->dispatch(str_replace('/',' ',$entry['agent']),null); 

			 $entry['lasttime'] = $now;
			 $entry['counter'] = $entry['counter']+1;
		  
			 //$this->env->update_agent($this,'scheduler');		  
	   
			 return ($entry['freq']==0) ? 0 : $entry;//once or new array element			 
		 }
		 /*else
	       //echo "ERROR";
	       return -1;//not an objet error...*/
	   }	           
     }
	 else
	   //return not scheduled yet entries (as is)	   
	   return ($entry);//not executed yet 
  }
  
  //show the schedules running ........
  function showschedules() {
  
     foreach ($this->timeline as $t=>$d) {
	   $ret .= "[" . $t . "]\r\n";
	   foreach ($d as $t=>$data)
	     $ret .= $t . "=" . $data . "\r\n";
	 }  
  
     return ($ret);  
  }
  
  function __destruct() {
  
	  //unregister_tick_function(array(&$this,'checkschedules'));  
	  //zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
  }
  	 
};
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
//if (defined("DATABASE_DPC")) {

$__DPCSEC['TEST_DPC']='2;1;1;1;1;1;1;1;2';

if (!defined("TEST_DPC")) {//&& (seclevel('TEST_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("TEST_DPC",true);

$__DPC['TEST_DPC'] = 'test';

$__EVENTS['TEST_DPC'][0]='test';
$__EVENTS['TEST_DPC'][1]='reset_smdr';
$__EVENTS['TEST_DPC'][2]='read_smdr';
$__EVENTS['TEST_DPC'][3]='sync_smdr';

$__ACTIONS['TEST_DPC'][0]='test';
$__ACTIONS['TEST_DPC'][1]='reset_smdr';
$__ACTIONS['TEST_DPC'][2]='read_smdr';
$__ACTIONS['TEST_DPC'][3]='sync_smdr';
$__ACTIONS['TEST_DPC'][4]='smdr_datespace';

$__LOCALE['TEST_DPC'][0] = 'TEST_DPC;SMDR;SMDR';
$__LOCALE['TEST_DPC'][1] = '_SMDRLIST;SMDR List;SMDR List';
$__LOCALE['TEST_DPC'][2] = '_f0;A/A;A/A';
$__LOCALE['TEST_DPC'][3] = '_f1;Line;.';
$__LOCALE['TEST_DPC'][4] = '_f2;L2;L2';
$__LOCALE['TEST_DPC'][5] = '_f3;Date;/';
$__LOCALE['TEST_DPC'][6] = '_f4;Time;';
$__LOCALE['TEST_DPC'][7] = '_f5;Number;';
$__LOCALE['TEST_DPC'][8] = '_f6;Type;';
$__LOCALE['TEST_DPC'][9] = '_f7;Type;';
$__LOCALE['TEST_DPC'][10] = '_f8;Type;';

class test {

    var $smdrfilename;
    var $smdrfile;
	var $ps;
	var $pl;
	var $message;
	var $year;

	function test() {
	
/*	  if (!paramload('SMDR','sourcetype')) {
	    $this->smdrfilename = paramload('SHELL','prpath') . paramload('SMDR','sourcefile');
        //$this->smdrfile = file (paramload('SHELL','prpath') . paramload('SMDR','sourcefile'));	
	  }
	  else {
	    $this->smdrfilename = paramload('SMDR','sourcefile');
        //$this->smdrfile = file (paramload('SMDR','sourcefile'));	  
	  }
	  $this->ps = arrayload('SMDR','paternstart');
	  $this->pl = arrayload('SMDR','paternlength');
	  
	  $this->t_smdrlist = localize('_SMDRLIST',getlocal());	  	  */
	  $this->message = null;	  
	  
	  $this->year = "2003";
	
	}

    function event($evn) {
	
       switch ($evn) {		
          case "reset_smdr"   : $this->reset_smdr(); break;	   
          case "read_smdr"    : $this->read_source_smdr(); break;					 	  
          case "sync_smdr"    : $this->sync_smdr(); break;		  
       }	
	}	

	function action($act) {
      $__USERAGENT = GetGlobal('__USERAGENT');	
	  $apo = GetParam('apo');
	  $eos = GetParam('eos');
	  
	  //print $apo.$eos;
	
      switch ($act) {	
          case "smdr_datespace":	  	
          case "smdr"         : $out = $this->show_smdr($apo,$eos); break;	   					 	  
          case "sync_smdr"    : switch ($__USERAGENT) {
	                              case 'HTML' : $out = "SMDR Synchronization\n" . $this->message; break;
	                              case 'GTK'  : $out = "SMDR Synchronization\n" . $this->message; break;
								  case 'CLI'  :
	                              case 'TEXT' : $out = "SMDR Synchronization\n" . $this->message; break;											   
	                            }	
								break;
								//$out = $this->show_smdr(); break;		  
          case "read_smdr"    : //$out = $this->show_smdr(); break;  								
      }		
	    
	    
	  return ($out);
	}
	
	
	function show_smdr($fromdt='',$todt='') {
	   $db = GetGlobal('db');
	   $a = GetReq('a');
	   $g = GetReq('g');
	   $p = GetReq('p');	 
  	
       //title
       $out = setNavigator($this->t_smdrlist);   	
	
	   //$sSQL = "select recid,smdr0,smdr1,smdr2,smdr3,smdr4,smdr5,smdr6,smdr7,entrydate from smdr";
	   $sSQL = "select recid,smdr0,smdr5,smdr6,entrydate from smdr";
	   	   
	   if (($a) && ($a!="all")) {
	     $sSQL .= " where (smdr0=" . $db->qstr($a) . ")";
	     if ($g) $sSQL .= " AND (smdr6=" . $db->qstr($g) . ")";	   
		 
 	     if ($fromdt) $sSQL .= " AND (entrydate>=" . $db->qstr(trim(reverse_datetime($fromdt))) .")";
 	     if ($todt) $sSQL .= " AND (entrydate<=" . $db->qstr(trim(reverse_datetime($todt))) .")";		 
	   }
	   else {
 	     if ($fromdt) $sSQL .= " where (entrydate>=" . $db->qstr(trim(reverse_datetime($fromdt))) .")";
 	     if ($todt) $sSQL .= " AND (entrydate<=" . $db->qstr(trim(reverse_datetime($todt))) .")";		   
	   }	
  
	   
       $browser = new browseSQL($this->t_smdrlist. " > " . $a,null,null,localize('_f0',getlocal()).",".
	                                                                    localize('_f1',getlocal()).",".
																		localize('_f3',getlocal()).",".
																		localize('_f6',getlocal()).",".
																		localize('_f7',getlocal()));
	   $out .= $browser->render($db,$sSQL,"smdr","smdr",30,$this,1,1,1,0);
	   unset ($browser);
	   
	   $out .= $this->getdatespace();	      
	     	 
	   return ($out);
	}
	
	
	function read_source_smdr($startfrom=0) {
	   $db = GetGlobal('db');
	   
	   $bytesreaded = ($startfrom*4096);
	   $maxps = count($this->ps);
	   
	   if ($fp = @fopen ($this->smdrfilename , "r")) {
	      
	     //dummy read to start from correct point
		 for ($i=0;$i<$startfrom;$i++) {
  	       $readed = fgets($fp,4096);		//echo ">>>>>",$readed; 
	     }		   
         //foreach ($this->smdrfile as $dline_num => $dline) {				  
	     while (!feof($fp)) {
		              
		   $dline = fgets($fp,4096);
		   if ($dline) {
		     $bytesreaded+=4096;		   
		   
		     for ($i=0;$i<$maxps;$i++) {
		       $record[$i] = substr($dline,$this->ps[$i],$this->pl[$i]);
		     }
			 
			 $rdate = explode(":",$record[2]);
			 $r2date = $this->year."-".$rdate[0]."-".$rdate[1]." ".$record[3];
		   
             $sSQL = "insert into smdr (smdr0,smdr1,smdr2,smdr3,smdr4,smdr5,smdr6,smdr7,smdr8,entrydate) values (" . 
		           $db->qstr($record[0]) . "," .
                   $db->qstr($record[1]) . "," .				   
                   $db->qstr($record[2]) . "," .
                   $db->qstr($record[3]) . "," .
                   $db->qstr($record[4]) . "," .
                   $db->qstr($record[5]) . "," .
                   $db->qstr($record[6]) . "," .
                   $db->qstr($record[7]) . "," .	
                   $db->qstr($record[8]) . "," .				  
                   $db->qstr($r2date) . ")";		
				   
		     $res = $db->Execute($sSQL); 
		   }	 		   
         }
		 fclose($fp); 
	   
 	     setInfo(" SMDR Source readed!"); 
		 $this->message .= ($bytesreaded/4096)." SMDR lines added successfully !\n"; 
	   }
	   else {
	     setInfo(" SMDR Source NOT readed!");  
 		 $this->message .= "SMDR file NOT readed successfully !\n";
	   }	 
		
	   return ($bytesreaded/4096);	
	}
	
	
   function reset_smdr() {
	    $db = GetGlobal('db'); 

        //delete table if exist
  	    $sSQL = "drop table if exists smdr";
        $db->Execute($sSQL);
		$sSQL = "create table smdr " .
                    "(" .
	                "recid integer auto_increment primary key," .
	                "smdr0 varchar(64)," .
	                "smdr1 varchar(64)," .
	                "smdr2 varchar(64)," .
	                "smdr3 varchar(64)," .
	                "smdr4 varchar(64)," .
	                "smdr5 varchar(64)," .	
	                "smdr6 varchar(64)," .
	                "smdr7 varchar(64)," .
	                "smdr8 varchar(64)," .															
	                "entrydate datetime" .					
                    ")";
        $db->Execute($sSQL); 
		
		//delete log file
	    $logfile = paramload('SHELL','prpath') . "smdr.log";		
		$delete = unlink($logfile);  
			
		setInfo(" SMDR Reset successfully!");
    }	
	
	
	
    function savelog($bytes) {
       
	  $logfile = paramload('SHELL','prpath') . "smdr.log";
	  
	  $sdate = date('d/m/Y');
	  $stime = date('h:i:s A');
	  $logline = "$sdate;$stime;$bytes;\n"; //save bytes readed so to open next time from this point of file
	  	   
	  if ($fp = fopen ($logfile , "a+")) {
               fwrite ($fp, $logline);
               fclose ($fp);
			   $this->message .= "Log file updated successfully !\n";							  
      }
      else {
               $this->message .= "Log file failed to update !\n";	
      }	   
    }
   
    function loadlog() {
	  $logfile = paramload('SHELL','prpath') . "smdr.log";
	  
	  if ($fp = fopen ($logfile , "r")) {
               $recs = fread ($fp, filesize($logfile));
               fclose ($fp);	
			   
	           $logline = explode(";",$recs);
	           $clog = count($logline);
	  
	           $out = ($logline[$clog-2]); //echo ">>>",$out,"<<<<<";
   			   $this->message .= "Log file opened at $out lines!\n";
	  
	           return $out;			   						  
      }

	  return 0; //start of database      
    }	
   

    function sync_smdr() {
	   
	   $this->message = null;
	
	   $startfrom = $this->loadlog();
	   $bytesreaded = $this->read_source_smdr($startfrom);
	   if ($bytesreaded) $this->savelog($bytesreaded);   
	}   
	
	
	function getdatespace() {
	      $a = GetReq('a');
		  $g = getReq('g');
	
		  $dater = new datepicker();	
		  
		  $toprint = $dater->renderspace(seturl("t=smdr&a=$a&g=$g"),"smdr_datespace");
		  return ($toprint);
	}
	
	function handle_date($dtime,$ds=":") {
	   $parts = explode(" ",$dtime);
	   
	   $date = $parts[0];
	   
	   $dparts = explode("-",$date);
	   //echo $dparts[1].$ds.$dparts[0];
	   
	   return ($dparts[1].$ds.$dparts[0]);	      
	}	

	
	
    function browse($packdata,$view) {
	
	   $data = explode("||",$packdata);
	
       $out = $this->viewsmdr($data[0],$data[1],$data[2],$data[3],$data[4]);//,$data[5],$data[6],$data[7],$data[8],$data[9]);

	   return ($out);
	}		
	
    function viewsmdr($id,$f1,/*$f2,$f3,$f4,$f5,*/$f6,$f7,/*$f8,*/$edate) {
	   $a = GetReq('a');
	   
	   $link = seturl("t=smdr&a=$f1&g=&p=$p" , $f1);
	   $link_disa = seturl("t=smdr&a=$f1&g=$f7&p=$p" , $f7);	   
							  
	   $data[] = $id;
	   $attr[] = "left;10%";
	   $data[] = $link;   
	   $attr[] = "left;12%";
	   $data[] = reverse_datetime($edate);//$f2;   
	   $attr[] = "left;36%";
	   //$data[] = str_replace(":","/",$f3);    
	   //$attr[] = "left;12%";
	   //$data[] = $f4;   
	   //$attr[] = "left;12%";
	   //$data[] = $f5;   
	   //$attr[] = "left;12%";	   
	   $data[] = $f6 . "&nbsp";   
	   $attr[] = "left;12%";	
	   
	   if (strstr($f7,"DISA")) $data[] = $link_disa;
	                      else $data[] = $f7 . "&nbsp";   
	   $attr[] = "left;12%";
	   
	   $myarticle = new window('',$data,$attr);
	   
	   $out = $myarticle->render("center::100%::0::group_article_selected::left::0::0::");
	   unset ($data);
	   unset ($attr);

	   return ($out);
	}	
	
	function headtitle() {
	   $a = GetReq('a');
	   $g = GetReq('g');
	   $p = GetReq('p');
	   $t = GetReq('t');
	   $sort = GetReq('sort');
	
		             $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=0",  localize('_f0',getlocal()) );
					 $attr[] = "left;10%";							  
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=1" , localize('_f1',getlocal()) );
					 $attr[] = "left;12%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=2" , localize('_f3',getlocal()) );
					 //$attr[] = "left;12%";
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=2" , localize('_f3',getlocal()) . "-" . localize('_f4',getlocal()) );
					 $attr[] = "left;36%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=4" , localize('_f4',getlocal()) );
					 //$attr[] = "left;12%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=5" , localize('_f5',getlocal()) );
					 //$attr[] = "left;12%";
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=3" , localize('_f6',getlocal()) );
					 $attr[] = "left;12%";					 
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=4" , localize('_f7',getlocal()) );
					 $attr[] = "left;12%";					 

					 $mytitle = new window('',$data,$attr);
					 $out = $mytitle->render(" ::100%::0::group_form_headtitle::center;100%;::");
					 unset ($data);
					 unset ($attr);	
	   
	   return ($out);
	}	
	
	function iam() {
	
	  return 'my name is test';
	}	
	
};
}
//}
//else die("DATABASE DPC REQUIRED! (" .__FILE__ . ")");
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php

$__DPCSEC['PROTO_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("PROTO_DPC")) {//&& (seclevel('SMDR_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("PROTO_DPC",true);

$__DPC['PROTO_DPC'] = 'proto';

$__EVENTS['PROTO_DPC'][0]='proto';

$__ACTIONS['PROTO_DPC'][0]='proro';

class proto {


	function proto($coordinator=null) {
	
	
	  echo $coordinator->env['ip'];
	}
	//problem!!!!! when activated
	/*function __sleep() {
	
	  echo "serialize\n";
	}
	
	function __wakeup() {
	
	  echo "unserialize\n";
	}*/

    function event($evn) {
	
       switch ($evn) {		
          case "proto"   : break;	   	  
       }	
	}	

	function action($act) {
	
      switch ($act) {	
	    
          case "proto"    : $out = '!!!proto!!!'; break;  								
      }		
	    
	  return ($out);
	}
	
	function iam() {
	
	  return 'my name is proto';
	}	
	
};
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
//if (defined("DATABASE_DPC")) {

$__DPCSEC['SMDR_DPC']='2;1;1;1;1;1;1;1;2';

if (!defined("SMDR_DPC")) {//&& (seclevel('SMDR_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("SMDR_DPC",true);

$__DPC['SMDR_DPC'] = 'smdr';

$__EVENTS['SMDR_DPC'][0]='smdr';
$__EVENTS['SMDR_DPC'][1]='reset_smdr';
$__EVENTS['SMDR_DPC'][2]='read_smdr';
$__EVENTS['SMDR_DPC'][3]='sync_smdr';

$__ACTIONS['SMDR_DPC'][0]='smdr';
$__ACTIONS['SMDR_DPC'][1]='reset_smdr';
$__ACTIONS['SMDR_DPC'][2]='read_smdr';
$__ACTIONS['SMDR_DPC'][3]='sync_smdr';
$__ACTIONS['SMDR_DPC'][4]='smdr_datespace';

$__LOCALE['SMDR_DPC'][0] = 'SMDR_DPC;SMDR;SMDR';
$__LOCALE['SMDR_DPC'][1] = '_SMDRLIST;SMDR List;SMDR List';
$__LOCALE['SMDR_DPC'][2] = '_f0;A/A;A/A';
$__LOCALE['SMDR_DPC'][3] = '_f1;Line;.';
$__LOCALE['SMDR_DPC'][4] = '_f2;L2;L2';
$__LOCALE['SMDR_DPC'][5] = '_f3;Date;/';
$__LOCALE['SMDR_DPC'][6] = '_f4;Time;';
$__LOCALE['SMDR_DPC'][7] = '_f5;Number;';
$__LOCALE['SMDR_DPC'][8] = '_f6;Type;';
$__LOCALE['SMDR_DPC'][9] = '_f7;Type;';
$__LOCALE['SMDR_DPC'][10] = '_f8;Type;';

class smdr {

    var $smdrfilename;
    var $smdrfile;
	var $ps;
	var $pl;
	var $message;
	var $year;

	function smdr() {
	
/*	  if (!paramload('SMDR','sourcetype')) {
	    $this->smdrfilename = paramload('SHELL','prpath') . paramload('SMDR','sourcefile');
        //$this->smdrfile = file (paramload('SHELL','prpath') . paramload('SMDR','sourcefile'));	
	  }
	  else {
	    $this->smdrfilename = paramload('SMDR','sourcefile');
        //$this->smdrfile = file (paramload('SMDR','sourcefile'));	  
	  }
	  $this->ps = arrayload('SMDR','paternstart');
	  $this->pl = arrayload('SMDR','paternlength');
	  
	  $this->t_smdrlist = localize('_SMDRLIST',getlocal());	  	  */
	  $this->message = null;	  
	  
	  $this->year = "2003";
	
	}

    function event($evn) {
	
       switch ($evn) {		
          case "reset_smdr"   : $this->reset_smdr(); break;	   
          case "read_smdr"    : $this->read_source_smdr(); break;					 	  
          case "sync_smdr"    : $this->sync_smdr(); break;		  
       }	
	}	

	function action($act) {
      $__USERAGENT = GetGlobal('__USERAGENT');	
	  $apo = GetParam('apo');
	  $eos = GetParam('eos');
	  
	  //print $apo.$eos;
	
      switch ($act) {	
          case "smdr_datespace":	  	
          case "smdr"         : $out = $this->show_smdr($apo,$eos); break;	   					 	  
          case "sync_smdr"    : switch ($__USERAGENT) {
	                              case 'HTML' : $out = "SMDR Synchronization\n" . $this->message; break;
	                              case 'GTK'  : $out = "SMDR Synchronization\n" . $this->message; break;
								  case 'CLI'  :
	                              case 'TEXT' : $out = "SMDR Synchronization\n" . $this->message; break;											   
	                            }	
								break;
								//$out = $this->show_smdr(); break;		  
          case "read_smdr"    : //$out = $this->show_smdr(); break;  								
      }		
	    
	    
	  return ($out);
	}
	
	
	function show_smdr($fromdt='',$todt='') {
	   $db = GetGlobal('db');
	   $a = GetReq('a');
	   $g = GetReq('g');
	   $p = GetReq('p');	 
  	
       //title
       $out = setNavigator($this->t_smdrlist);   	
	
	   //$sSQL = "select recid,smdr0,smdr1,smdr2,smdr3,smdr4,smdr5,smdr6,smdr7,entrydate from smdr";
	   $sSQL = "select recid,smdr0,smdr5,smdr6,entrydate from smdr";
	   	   
	   if (($a) && ($a!="all")) {
	     $sSQL .= " where (smdr0=" . $db->qstr($a) . ")";
	     if ($g) $sSQL .= " AND (smdr6=" . $db->qstr($g) . ")";	   
		 
 	     if ($fromdt) $sSQL .= " AND (entrydate>=" . $db->qstr(trim(reverse_datetime($fromdt))) .")";
 	     if ($todt) $sSQL .= " AND (entrydate<=" . $db->qstr(trim(reverse_datetime($todt))) .")";		 
	   }
	   else {
 	     if ($fromdt) $sSQL .= " where (entrydate>=" . $db->qstr(trim(reverse_datetime($fromdt))) .")";
 	     if ($todt) $sSQL .= " AND (entrydate<=" . $db->qstr(trim(reverse_datetime($todt))) .")";		   
	   }	
  
	   
       $browser = new browseSQL($this->t_smdrlist. " > " . $a,null,null,localize('_f0',getlocal()).",".
	                                                                    localize('_f1',getlocal()).",".
																		localize('_f3',getlocal()).",".
																		localize('_f6',getlocal()).",".
																		localize('_f7',getlocal()));
	   $out .= $browser->render($db,$sSQL,"smdr","smdr",30,$this,1,1,1,0);
	   unset ($browser);
	   
	   $out .= $this->getdatespace();	      
	     	 
	   return ($out);
	}
	
	
	function read_source_smdr($startfrom=0) {
	   $db = GetGlobal('db');
	   
	   $bytesreaded = ($startfrom*4096);
	   $maxps = count($this->ps);
	   
	   if ($fp = @fopen ($this->smdrfilename , "r")) {
	      
	     //dummy read to start from correct point
		 for ($i=0;$i<$startfrom;$i++) {
  	       $readed = fgets($fp,4096);		//echo ">>>>>",$readed; 
	     }		   
         //foreach ($this->smdrfile as $dline_num => $dline) {				  
	     while (!feof($fp)) {
		              
		   $dline = fgets($fp,4096);
		   if ($dline) {
		     $bytesreaded+=4096;		   
		   
		     for ($i=0;$i<$maxps;$i++) {
		       $record[$i] = substr($dline,$this->ps[$i],$this->pl[$i]);
		     }
			 
			 $rdate = explode(":",$record[2]);
			 $r2date = $this->year."-".$rdate[0]."-".$rdate[1]." ".$record[3];
		   
             $sSQL = "insert into smdr (smdr0,smdr1,smdr2,smdr3,smdr4,smdr5,smdr6,smdr7,smdr8,entrydate) values (" . 
		           $db->qstr($record[0]) . "," .
                   $db->qstr($record[1]) . "," .				   
                   $db->qstr($record[2]) . "," .
                   $db->qstr($record[3]) . "," .
                   $db->qstr($record[4]) . "," .
                   $db->qstr($record[5]) . "," .
                   $db->qstr($record[6]) . "," .
                   $db->qstr($record[7]) . "," .	
                   $db->qstr($record[8]) . "," .				  
                   $db->qstr($r2date) . ")";		
				   
		     $res = $db->Execute($sSQL); 
		   }	 		   
         }
		 fclose($fp); 
	   
 	     setInfo(" SMDR Source readed!"); 
		 $this->message .= ($bytesreaded/4096)." SMDR lines added successfully !\n"; 
	   }
	   else {
	     setInfo(" SMDR Source NOT readed!");  
 		 $this->message .= "SMDR file NOT readed successfully !\n";
	   }	 
		
	   return ($bytesreaded/4096);	
	}
	
	
   function reset_smdr() {
	    $db = GetGlobal('db'); 

        //delete table if exist
  	    $sSQL = "drop table if exists smdr";
        $db->Execute($sSQL);
		$sSQL = "create table smdr " .
                    "(" .
	                "recid integer auto_increment primary key," .
	                "smdr0 varchar(64)," .
	                "smdr1 varchar(64)," .
	                "smdr2 varchar(64)," .
	                "smdr3 varchar(64)," .
	                "smdr4 varchar(64)," .
	                "smdr5 varchar(64)," .	
	                "smdr6 varchar(64)," .
	                "smdr7 varchar(64)," .
	                "smdr8 varchar(64)," .															
	                "entrydate datetime" .					
                    ")";
        $db->Execute($sSQL); 
		
		//delete log file
	    $logfile = paramload('SHELL','prpath') . "smdr.log";		
		$delete = unlink($logfile);  
			
		setInfo(" SMDR Reset successfully!");
    }	
	
	
	
    function savelog($bytes) {
       
	  $logfile = paramload('SHELL','prpath') . "smdr.log";
	  
	  $sdate = date('d/m/Y');
	  $stime = date('h:i:s A');
	  $logline = "$sdate;$stime;$bytes;\n"; //save bytes readed so to open next time from this point of file
	  	   
	  if ($fp = fopen ($logfile , "a+")) {
               fwrite ($fp, $logline);
               fclose ($fp);
			   $this->message .= "Log file updated successfully !\n";							  
      }
      else {
               $this->message .= "Log file failed to update !\n";	
      }	   
    }
   
    function loadlog() {
	  $logfile = paramload('SHELL','prpath') . "smdr.log";
	  
	  if ($fp = fopen ($logfile , "r")) {
               $recs = fread ($fp, filesize($logfile));
               fclose ($fp);	
			   
	           $logline = explode(";",$recs);
	           $clog = count($logline);
	  
	           $out = ($logline[$clog-2]); //echo ">>>",$out,"<<<<<";
   			   $this->message .= "Log file opened at $out lines!\n";
	  
	           return $out;			   						  
      }

	  return 0; //start of database      
    }	
   

    function sync_smdr() {
	   
	   $this->message = null;
	
	   $startfrom = $this->loadlog();
	   $bytesreaded = $this->read_source_smdr($startfrom);
	   if ($bytesreaded) $this->savelog($bytesreaded);   
	}   
	
	
	function getdatespace() {
	      $a = GetReq('a');
		  $g = getReq('g');
	
		  $dater = new datepicker();	
		  
		  $toprint = $dater->renderspace(seturl("t=smdr&a=$a&g=$g"),"smdr_datespace");
		  return ($toprint);
	}
	
	function handle_date($dtime,$ds=":") {
	   $parts = explode(" ",$dtime);
	   
	   $date = $parts[0];
	   
	   $dparts = explode("-",$date);
	   //echo $dparts[1].$ds.$dparts[0];
	   
	   return ($dparts[1].$ds.$dparts[0]);	      
	}	

	
	
    function browse($packdata,$view) {
	
	   $data = explode("||",$packdata);
	
       $out = $this->viewsmdr($data[0],$data[1],$data[2],$data[3],$data[4]);//,$data[5],$data[6],$data[7],$data[8],$data[9]);

	   return ($out);
	}		
	
    function viewsmdr($id,$f1,/*$f2,$f3,$f4,$f5,*/$f6,$f7,/*$f8,*/$edate) {
	   $a = GetReq('a');
	   
	   $link = seturl("t=smdr&a=$f1&g=&p=$p" , $f1);
	   $link_disa = seturl("t=smdr&a=$f1&g=$f7&p=$p" , $f7);	   
							  
	   $data[] = $id;
	   $attr[] = "left;10%";
	   $data[] = $link;   
	   $attr[] = "left;12%";
	   $data[] = reverse_datetime($edate);//$f2;   
	   $attr[] = "left;36%";
	   //$data[] = str_replace(":","/",$f3);    
	   //$attr[] = "left;12%";
	   //$data[] = $f4;   
	   //$attr[] = "left;12%";
	   //$data[] = $f5;   
	   //$attr[] = "left;12%";	   
	   $data[] = $f6 . "&nbsp";   
	   $attr[] = "left;12%";	
	   
	   if (strstr($f7,"DISA")) $data[] = $link_disa;
	                      else $data[] = $f7 . "&nbsp";   
	   $attr[] = "left;12%";
	   
	   $myarticle = new window('',$data,$attr);
	   
	   $out = $myarticle->render("center::100%::0::group_article_selected::left::0::0::");
	   unset ($data);
	   unset ($attr);

	   return ($out);
	}	
	
	function headtitle() {
	   $a = GetReq('a');
	   $g = GetReq('g');
	   $p = GetReq('p');
	   $t = GetReq('t');
	   $sort = GetReq('sort');
	
		             $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=0",  localize('_f0',getlocal()) );
					 $attr[] = "left;10%";							  
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=1" , localize('_f1',getlocal()) );
					 $attr[] = "left;12%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=2" , localize('_f3',getlocal()) );
					 //$attr[] = "left;12%";
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=2" , localize('_f3',getlocal()) . "-" . localize('_f4',getlocal()) );
					 $attr[] = "left;36%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=4" , localize('_f4',getlocal()) );
					 //$attr[] = "left;12%";
					 //$data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=5" , localize('_f5',getlocal()) );
					 //$attr[] = "left;12%";
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=3" , localize('_f6',getlocal()) );
					 $attr[] = "left;12%";					 
					 $data[] = seturl("t=$t&a=$a&g=$g&p=$p&sort=$sort&col=4" , localize('_f7',getlocal()) );
					 $attr[] = "left;12%";					 

					 $mytitle = new window('',$data,$attr);
					 $out = $mytitle->render(" ::100%::0::group_form_headtitle::center;100%;::");
					 unset ($data);
					 unset ($attr);	
	   
	   return ($out);
	}	
	
	function iam() {
	
	  return 'my name is smdr';
	}	
	
};
}
//}
//else die("DATABASE DPC REQUIRED! (" .__FILE__ . ")");
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
$__DPCSEC['REMOTEPRINT_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("REMOTEPRINT_DPC")) {//&& (seclevel('TEST_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("REMOTEPRINT_DPC",true);

$__DPC['REMOTEPRINT_DPC'] = 'remoteprint';

class remoteprint {


	function remoteprint($env=null) {
	
	  $this->env = $env;
	  
	}
	
    function rprint($message,$printserver) {

	  $this->printout = $this->env->get_agent('resources')->get_resource('printer');
   
      if ($this->printout)   
	    printer_write($this->printout,$message."\n\r");  
    }	
	
	function agents() {
	
	  print_r($this->env->agn_addr);
	}	
	
};	
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
$__DPCSEC['LOCALPRINT_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("LOCALPRINT_DPC")) {//&& (seclevel('TEST_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("LOCALPRINT_DPC",true);

$__DPC['LOCALPRINT_DPC'] = 'localprint';

class localprint {


	function localprint($env=null) {
	
	  //var_dump($env->agn_addr);	
	  $this->env = $env;
	  
	  //$this->resources = new resources($env);
	}
	
    function lprint($message) {
	     
      printer_write($this->env->get_agent('resources')->get_resource('printer'), $message."\n\r");  
		
    }	
	
	function agents() {
	
	  print_r($this->env->agn_addr);
	}		
	
};	
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
$__DPCSEC['SCHEDULEDTASK_DPC']='1;1;1;1;1;1;1;1;2';

if (!defined("SCHEDULEDTASK_DPC")) {//&& (seclevel('TEST_DPC',decode(GetSessionParam('UserSecID')))) ) {
define("SCHEDULEDTASK_DPC",true);

$__DPC['SCHEDULEDTASK_DPC'] = 'scheduledtask';

class scheduledtask {

    var $env, $resources;
	var $value, $printer;

	function scheduledtask($env=null) {
	
	  //var_dump($env->agn_addr);
	  //var_dump($env->agn_length);  
	  
	  $this->env = $env;

	  //$this->resources = new resources($env);
	  
	  $this->value = 100;
	  $this->x = 222;
	  
	  //$env->scheduler->schedule('scheduledtask.scheduleprint','every','10');
	  //agent now
	  $sh = $this->env->get_agent('scheduler');
	  $sh->schedule('scheduledtask.scheduleprint','every','10');
	  //$sh->schedule('batch/askbill.ash','every','25'); 			  
	  //$this->env->update_agent($sh,'scheduler'); //done in sh->schedule
	  
	  //print_r($this->env->get_agent('scheduler')->timeline); 	  
	}
	
	function agents() {
	
	  print_r($this->env->agn_addr);
	  
	  //$this->x =  $this->env->get_agent('resources')->get_resource('variable');		  
	  //$this->env->update_agent($this,'scheduledtask');
	}
	
    function scheduleprint() {
	
	  $this->value = 200; //ok
      //$this->printer = $this->env->get_agent('resources')->get_resource('printer');   
	  //printer_write($this->printer, date("l dS of F Y h:i:s A")."\n\r");  
	  
	  echo @file_get_contents($this->env->ldscheme . "/www.e-basis.gr/pdo.php");
	  echo date("l dS of F Y h:i:s A")."\n\r";  
	  //out of scheme dpc (load in data area)
	  //echo @file_get_contents($this->env->ldscheme . "/gui/ajax.dpc.php");
		
	  //print_r($this->env->get_agent('resources')->_resptr);
	  //print_r($this->env->get_agent('resources')->_resources);	  
	  //echo $this->printer;//lost?????????????????
	  //echo "\n",$this->x,"........................\n"; 
	  
	  //$this->env->update_agent($this,'scheduleprint');	  	
	  //$this->x =  $this->env->get_agent('resources')->get_resource('variable');			
	  //xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    }		
	
};	
}
?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php


/**********************************************************************
 *     class.daemon.php - Copyright, N.Suraj Kumar                    *
 *                                                                    *
 *     This code is released under the terms of the                   *
 *     GNU General Public License.                                    *
 *                                                                    *
 *     For more details read: http://www.gnu.org/licenses/gpl.html    *
 *                                                                    *
 **********************************************************************/

/* What does this class do?

        This class can help you create easy to use TCP Daemons that can
        listen on a specified port. 

        The main aim of writing this class was to help ppl easily define
        their own FTP-like protocols where they can create apps that can read
        commands and respond in return.

        See sample code at the end of the this file for more details.

*/      


define ("VERBOSE", true);
define ("VERBOSE_LEVEL", 2);//5
define ("DAEMON_BUFFER", 1024);
define ("MAX_CONNECTIONS", 4);//4
define ("SILENCE",1);//0

/* can be set to 'standalone' for listening on specified port. When run
 * as an inetd service, this class reads from stdin and outputs to
 * stdout. and hence the address/port doesn't make any sense in the
 * inetd context
 */

//define ("SERVER_TYPE", 'standalone'); //and oh, this can be _anything_
                                                                                                  //if you wanted this to do sockets...

//define ("SHOW_PROMPT", true); //should a prompt be displayed? 

class daemon {
        
        var $stdin;
        var $stdout;

        // and for the standalone version...
        var $socket;
        var $msg_socket;
        var $first_time = true;
        var $Address;
        var $Port;

        var $Header;
        var $PromptString = 'phpdac5> ';
		
		//added by me
		var $Echo = 1;//0;
		var $silent = 0;//client silent..server silence defined ..		
        protected $clientFD;	
		protected $cliendInfo;
		protected $clients;	
		protected $active;
		protected $timeout;
		protected $idle_timeout;
		
		var $cpool;
		
        function daemon($type='standalone',$prompt=true,$env=null) {
		
                define ("SERVER_TYPE", $type);//added by me!
                define ("SHOW_PROMPT", $prompt); //should a prompt be displayed? 
				$this->active = null;
				$this->timeout = 1*30;//=secs
				$this->idle_timeout = 1*30;//=secs				
				
		        if (!extension_loaded('sockets')) dl('php_sockets.dll');
                set_time_limit (0); 
                ob_implicit_flush ();

        }

        function verbose ($level, $msg) {
                if (VERBOSE && $level <= VERBOSE_LEVEL && SERVER_TYPE != 'inetd') {
                        echo str_repeat ("*", $level) . " $msg " . str_repeat ("*", $level)
                        . "\n";
                }
        }

        function setAddress ($ipaddr) {
                $this->Address = $ipaddr;
        }

        function setPort ($port) {
                $this->Port = $port;
        }
				
		function setEcho($echo,$id=null) {
		        if (!$id) $id = $this->active; 
				
		        //if ($this->clientInfo[$id])
			      //$this->clientInfo[$id]['Echo'] = $echo;			
				$this->cpool[$id]->session['Echo'] = $echo;  
        }		
		//hide messages and header (client usage)
		function setSilence($silence,$id=null) {
		        if (!$id) $id = $this->active; 
				
			    $this->cpool[$id]->session['Silent'] = $silence;			
        }		

        function start ($PromptString=null) {	
		
		        if ($PromptString) $this->PromptString = $PromptString;
                
                if (SERVER_TYPE == 'inetd') {
                  /* This daemon is already listening to a socket. Thanks to inetd.
                   * we just output to stdout and read from stdin.
                   */
                  $this->stdin = fopen ('php://stdin', 'r');
                } else {
				        //prepare pool
						for ($i=0;$i<MAX_CONNECTIONS;$i++)
				           $this->cpool[$i] = new connect_pool();	
						   
						   
                        $this->verbose (1, "Server Ready for connections");
                        /* This is being run as a standalone server. lets create a socket
                         */
                        $sock = socket_create (AF_INET, SOCK_STREAM, SOL_TCP);
                        $this->verbose (3, "Socket created");
                        if ($sock < 0) {
                                //error!
                                $this->sock_die ('Couldn\'t create a socket!', $sock);
                        }
                        socket_setopt($sock, SOL_SOCKET, SO_REUSEADDR, 1);
                        $this->verbose (3, "Making socket reuseable");

                        $ret = socket_bind ($sock, $this->Address, $this->Port);
                        if ($ret < 0) {
                                //error!
                                $this->sock_die ('Couldn\'t bind socket!', $ret);
                        }
                        $this->verbose (3, "Socket bind complete");

                        $ret = socket_listen ($sock, MAX_CONNECTIONS);
                        if ($ret < 0) {
                                //error!
                                $this->sock_die ('listen failed!', $ret);
                        }

                        $this->socket = $sock;
                        //$this->sock_message_socket_create ();//master
                }
        }

        function sock_message_socket_create ($i) {//=null) {second method
		
				// for ($i = 0; $i <= count($this->cpool); $i ++) {
                  //  if (!isset ($this->cpool[$i]->resource) || $this->cpool[$i]->resource == null) {
					  
                      $this->cpool[$i]->resource = socket_accept($this->socket);
                      if ($this->cpool[$i]->resource < 0) {
                        //error
                        $this->sock_die ('socket accept failed!', $this->cpool[$i]->resource);
                      }					  
					  
                      socket_setopt($this->cpool[$i]->resource, SOL_SOCKET, SO_REUSEADDR, 1);
                      $peer_host = "";
                      $peer_port = "";
                      socket_getpeername($this->cpool[$i]->resource, $peer_host, $peer_port);
                      $this->cpool[$i]->session = array ("host" => $peer_host, 
					                                     "port" => $peer_port, 
												   	     "connectOn" => time(),
													     "First_time"=>true,
					                                     "PromptString"=>$this->PromptString,
													     "Echo"=>$this->Echo,
														 "Silent"=>$this->silent);
					  //at connection....									 
					  $this->active = $i;
					  if ((!SILENCE) || (!$this->cpool[$i]->session['Silent'])) {
                        $this->ShowHeader($i);
					    if (SHOW_PROMPT) {
                          $this->showPrompt($i);
                        }
					  }
  					  //return $i; 
					//}
				  //}	                    

        }
		

        function sock_reset ($id) {

                $this->close ($id);
                $this->sock_message_socket_create($id);
        }

        function close ($id) {
		        //echo 'silence:',SILENCE,'<>',$this->cpool[$id]->session['Silent'],'<';
				
     			if ((!SILENCE) || (!$this->cpool[$id]->session['Silent']))//if no silence
                  $this->Println ('goodbye!',$id);		
		
		        if (SERVER_TYPE == 'inetd') {
                        exit;
                } 
				else {
                //if (SERVER_TYPE != 'inetd') {
				        //if (!$socket) $socket = $this->msg_socket;
						socket_getpeername ($this->cpool[$id]->resource, $peer_addr, $peer_port);
                        $this->verbose (1, "---------------Connection closed from $id>$peer_addr:$peer_port ------------");
                        //socket_shutdown ($this->clientFD[$id]);
						socket_close($this->cpool[$id]->resource);

                        //$this->clientFD[$id] = null;
                        //unset ($this->clientInfo[$id]);
                        //$this->clients--;
						
						//$this->cpool[$id]->reset_client();	
						$this->cpool[$id]->resource = null;
					    $this->cpool[$id]->session['First_time'] = true;//->reset_client();	                    
						

                }
        }
		//alias
		function closeConnection($id) {
		
		  $this->close($id);
		}
		
        function resetConnection ($id) {
		
		        //if (!$id) $id = $this->active;
			    if ((!SILENCE) || (!$this->cpool[$id]->session['Silent']))//if no silence
                  $this->Println ('goodbye!',$id);
				
                if (SERVER_TYPE == 'inetd') {
                        exit;
                } else {
                        $this->cpool[$id]->session['First_time'] = true;				
                        $this->sock_reset ($id);
                }
        }	
		
		function refuseConnection($id) {
		    
			   echo 'Connection refused!';
			   //$this->closeConnection();
		}	

        function shutdown () {
                if (SERVER_TYPE != 'inetd') { //because it just doesn't make sense
                                                                                                
  	           //      to have an 'inetd' service shut
               //      itself down... ;-/
			   
              /*          $maxFD = count($this->clientFD);
                        for ($i = 0; $i < $maxFD; $i ++) {
                            $this->close($i);
                        }	*/	
						for ($i=0;$i<MAX_CONNECTIONS;$i++) {
		                  if ($this->cpool[$i]->resource == '') {
			                break;
			              }   
			              else {
			               $this->closeConnection($i);
			              }
		                }	   
			   
                        //$this->println ('*** Server Shutting down ***');
						$this->BroadPrint ('*** Server Shutting down ***');
                        $this->verbose (1, '=======Server Shutdown=========');
                        //$this->close ();
						//socket_shutdown ($this->socket);
						socket_close($this->socket);
									 						
                } 
        }

        function sock_die ($msg, $return_code, $to_be_closed) {
                echo "$msg: " . socket_strerror ($return_code);
                if ($to_be_closed===true) {
                        socket_close($this->active);// ($this->msg_socket);//=master!!!!!!!!!!!!!!!!!
                }
				elseif ($to_be_closed) {//exist
				        socket_close ($to_be_closed);//=client
				}
                exit;
        }


        function Read ($id) {
                if (SERVER_TYPE == 'inetd') {
                        return trim (fgets ($this->stdin, DAEMON_BUFFER));
                } else {
				        //if (!$socket) $socket = $this->msg_socket;
                        /*if (FALSE == ($buf = socket_read ($this->cpool[$id]->resource,DAEMON_BUFFER))) {
                                //error reading socket
                                $this->sock_die ('Error Reading from socket!', $buf, $this->cpool[$id]->resource);
                                //true makes sock_die to close the socket in the end
                        } else {
                                $this->verbose (5, '<<' . $buf);
                                return trim ($buf);
                        }*/
						//added by me
						//2000!!!!!!
                        $data = "";
                        while (socket_recv($this->cpool[$id]->resource,$buf,DAEMON_BUFFER,0) !== false) {
						
						  $this->active = $id;
						  
                          $data .= $buf;
						  if ((!SILENCE) || (!$this->cpool[$id]->session['Silent'])) 
						    if ($this->cpool[$id]->session['Echo']) 
						      $this->_Print ($buf,$id);
						  
                          if (preg_match("'\r\n$'s", $data)) {
                                //$this->verbose (5, '<<' . $data);
                                return trim ($data);						  
						  }
                        }	
						$this->active = $id;
                        /*$data = '';//XP!!!!!!
                        // read data from socket
                        while ($buf = socket_read($this->cpool[$id]->resource, DAEMON_BUFFER, PHP_BINARY_READ)) {
                          $data .= $buf;

                          if ($buf == NULL || strlen($buf) < DAEMON_BUFFER) {
                            break;
                          }

                          if ($buf === false) {  
                          }
                        }*/

                        return $data;											
                }//else
        }

        function _Print ($string,$id=null) {

//              fputs ($this->stdout, $string);
                if (SERVER_TYPE == 'inetd') {
                        echo $string;
                } else {
						if ($id==null) $id = $this->active;//$this->msg_socket;
                        $this->verbose (5, '>>' . $string);
						
						if (is_resource($this->cpool[$id]->resource))
						  socket_write ($this->cpool[$id]->resource, $string, strlen ($string));
                        /*if (!@socket_write ($this->cpool[$id]->resource, $string, strlen ($string))) {
						  $this->resetConnection($id);
						  //$this->closeConnection($id);
						}*/
                }
        }
		
        function Println ($string,$id=null) {
                if ($id==null) $id = $this->active;
				
                $this->_Print ($string . "\n",$id);
        }		
		
        function BroadPrint($data, $exclude = array ()) {
          /*if (!empty ($exclude) && !is_array($exclude)) {
            $exclude = array ($exclude);
          }

          for ($i = 0; $i < count($this->clientFD); $i ++) {
            if (isset ($this->clientFD[$i]) && $this->clientFD[$i] != null && !in_array($i, $exclude)) {
                //if (!@ socket_write($this->clientFD[$i], $data)) {
                //}
				$this->Println($data,$i);
            }
          }*/
		  for ($i=0;$i<MAX_CONNECTIONS;$i++) {
		    if ($this->cpool[$i]->resource == '') {
			  break;
			}
			else {
			  $this->Println($data,$i);
			}
		  }
        }	
		
        function ShowHeader ($id) {
		
		        if (SERVER_TYPE != 'inetd') {

                  if ($this->cpool[$id]->session['First_time']==true) {
				        //if (!$socket) $socket = $this->msg_socket;
                        socket_getpeername ($this->cpool[$id]->resource, $peer_addr, $peer_port);
                        $this->verbose (1, "---------Connection from $id>$peer_addr:$peer_port-----------");
                        $this->Println ($this->Header,$id);
                  }
                  $this->cpool[$id]->session['First_time'] = false;
				}
				elseif ((!SILENCE) || (!$this->cpool[$id]->session['Silent']))//if no silence
				  $this->Println ($this->Header,$id);
        }			

        function showError ($Severity, $ErrorString,$id=null) {
				//if (!$socket) $socket = $this->msg_socket;
				
		        if (!$id) $id = $this->active;
				
				if ((!SILENCE) || (!$this->cpool[$id]->session['Silent']))//if no silence
                  $this->Println ($Severity . ':' . $ErrorString,$id);
        }
		
        function showPrompt ($id) {

 	            //if (!$id) $id = $this->active;
		        if (SERVER_TYPE != 'inetd') {				
				  if ($this->cpool[$id]->session['Echo']) {
                    $this->_Print ($this->cpool[$id]->session['PromptString'],$id);
				  }
			    }
				elseif ((!SILENCE) || (!$this->cpool[$id]->session['Silent']))//if no silence
				   $this->_Print ($this->PromptString,$id);	  
        }
		
		function changePrompt($newprompt='phpdac5>',$id=null) {
			
               if ($id==null) $id = $this->active;
			   
		       if (SERVER_TYPE != 'inetd') {				   
		         $this->cpool[$id]->session['PromptString'] = $newprompt;
			   }	 
			   else
			   	 $this->PromptString = $newprompt;
		}		
		
		

        function isValidCommand ($cmd) {        
                if (in_array (strtoupper ($cmd), $this->valid_commands)) {
                        return true;
                } else {
                        return false;
                }
        }

        function Tokenise ($command_line,$upper=null) {//upper added by me
                $raw_tokens = explode (' ', trim ($command_line));
                //the first one is the command
                $command = $raw_tokens[0];
                //the rest are all parameters to the command
                $params = array_slice ($raw_tokens, 1);
				
                $tokens['command'] = (isset($upper)? strtoupper ($command) : $command);
				
                $tokens['params'] = $params;

                return $tokens;
        }

        function Tokenize ($command_line) {
                //this function is just an alias for tokenise
                return $this->Tokenise ($command_line);
        }

        function setCommands ($array) {
                $this->valid_commands = array();
                foreach ($array as $item) {
                        $this->valid_commands[] = strtoupper ($item);
                }
        }
        
        function CommandAction ($command, $callback = false) {
                static $defined_functions;
        
                /* the function ($callback) that is registered will be called back
                   when the specified command is encountered.

                        callback_function (string $command, array $params, daemon
                        $this);

                        daemon $this can be used to perform more actions here.. such as
                        $this->CloseConnection(), etc.,
                */

                if ($this->isValidCommand ($command)) {
                        //command is valid. see if the name of a callback function was
                        //passed to us...
                        $command = strtoupper ($command);
						
						if (is_array($callback)) {//ADDED TO SUPPORT CLASS METHOD CALLS...
						        
                                $this->callbacks[$command][] = $callback;										
						}
                        elseif ($callback) {
                                if (!isset ($defined_functions)) {
                                        $defined_functions = get_defined_functions();
                                }
                                
                                if (in_array ($callback, $defined_functions['user'])) {
                                        $this->callbacks[$command][] = $callback;
                                        $this->callbacks[$command] = array_unique ($this->callbacks[$command]);
                                } else {
                                        $this->showError ('FATAL', 'Could not call `' . $callback . '()` Function not defined!');
                                        $this->closeConnection();
                                        exit;
                                }
                        }
						else {
                                //no call back function was passed. Let's return the list of
                                //callback functions that this command has...
                                if (empty ($this->callbacks[$command])) {
                                        return array();
                                } else {
                                        return $this->callbacks[$command];
                                }
                        }
                }
        }

		
		function dispatch($command_line,$id) {
		
                                $this->verbose (4, "Received $command_line");
                        
                                $command_set = $this->Tokenise ($command_line);//command called without strtoupper(!=default cmds) so upper cmd at execute (see below)
                                $cmd = $command_set['command'];
                                $params = $command_set['params'];
                                //$this->Println ( $command_set['command']);
                                //if ($this->isValidCommand ($cmd)) {
                                        //see if this is registered in our callback function set
                                        
                                        $callbacks = $this->CommandAction ($cmd);
	                                       //aded by me (isvalidcommand &&)
                                        if (($this->isValidCommand (strtoupper($cmd))) && (!empty ($callbacks))) {
                                                //has callback functions... lets call them one by one
                                                
                                                foreach ($callbacks as $function) {
												    
													if (is_array($function)) {//ADDED TO SUPPORT CLASS METHOD CALLS...
													    //echo 'zzz';
													    $status = $function[0]->$function[1] (strtoupper($command_set['command']), $command_set['params'], $this); 
                                                        if (false == $status) {
                                                                //function says that we should exit...
                                                                //$this->resetConnection($id);
																$this->closeConnection($id);
                                                                //exit;
                                                        }														
													}
													else {//default global functions!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                                                        //call the callback function
                                                        $status = $function ($command_set['command'], $command_set['params'], $this); 
                                                        if (false == $status) {
                                                                //function says that we should exit...
                                                                //$this->resetConnection($id);
																$this->closeConnection($id);
                                                                //exit;
                                                        }
												   } 		
                                                }

                                        } 
										elseif ($function = $this->CommandAction ("***")) {////check phpdac(kernel) dispatcher ADDED BY ME TO SUPPORT PHPDAC CMDS
										    //print_r($this->callbacks['***'][0]); 
											//$this->Println ( $function[0][0].'.'.$function[0][1]);
                                            $status = $function[0][0]->$function[0][1] ($command_set['command'], $command_set['params'], $this); 
                                            if (false == $status) {
                                               //function says that we should exit...
                                               //$this->resetConnection($id);
											   $this->closeConnection($id);
                                               //exit;
                                            }	
										}
										else {
                                                //NO EVENTS... 
                                                $this->Println ('`' . $command_set['command'] . '\' defined but not implemented');
                                                $this->verbose (1, '`' . $command_set['command'] . '\'
                                                not implemented!');
                                        }
                                /*} else {
                                        $this->showError ('NOTIFY', 'Command `' .
                                        $command_set['command'] . '\' is unrecognized');
                                }*/		
		}
		
		//!!!!!! get the first active client id !!!!
		/*function getActive() {
		
               // check all clients for the first active 
               for ($i = 0; $i < count($this->clientFD); $i ++) {
                          if (!isset ($this->clientFD[$i])) {
                            continue;
                          }
                          return ($i); 
			   }  	  
		}*/
		
		function null_sort($ar1,$ar2) {
		
		  if ((is_resource($ar1->resource)) AND (is_resource($ar2->resource))) {
		    return 0;
		  }
		  elseif ((is_resource($ar1->resource)) AND (!is_resource($ar2->resource))) {
		    return -1;
		  }
		  else {
		    return 1;
		  }
		}

        function listen($timeout=null) {		
declare(ticks=10) {		
                if (SERVER_TYPE == 'inetd') {
		          $this->showHeader(null);
				  
                  while (true) {
						if (SHOW_PROMPT) {
							  $this->showPrompt(null);
                        }					
                        $command_line = $this->Read(null);
                        if (!empty ($command_line)) {
                               $this->dispatch($command_line,null);
                        }			
						//Gtk::main();
						/*while (Gtk::events_pending()) {
                         Gtk::main_iteration();//(false);
                        }*/
				  }	
				}
                else {		
				  //declare(ticks=2) {		
                  while (true) {
				        if (SERVER_TYPE == 'standalone') {  
				          /*while (Gtk::events_pending()) {
                           Gtk::main_iteration();//(false);
                          }*/
						}//else gtk error by the server (start))
				        //echo '0'; 
                        $current = array ();
                        array_push($current, $this->socket);
                        // fetch all clients that are awaiting connections
                        for ($i = 0; $i < count($this->cpool); $i ++) {
                          if (isset ($this->cpool[$i]->resource))
                            array_push($current, $this->cpool[$i]->resource);
							$this->active = $i;
                        } 	
				        /*unset($current);
						$current[0] = $this->socket;						
						for ($i=0;$i<MAX_CONNECTIONS;$i++) {
						  if ($this->cpool[$i]->resource!=null) {
						    $current[$i+1] = $this->cpool[$i]->resource;
							$this->active = $i;
						  } 
						}	*/										
						//echo '1'; 
                        // block and wait for data or new connection
                        $ready =  socket_select($current, $this->null, $this->null, $timeout);//null);
                        if ($ready === false) {
                          $this->shutdown();
                        }	
						//echo '2';
						// check for new connection
                        /*if (in_array($this->socket, $current)) {
						  $newclient = $this->sock_message_socket_create();
                          // check for maximum amount of connections
                          //if (count($current) > 0) {
                            if (count($current) > MAX_CONNECTIONS) {

                              $this->closeConnection($newclient);
                            }
                          //}

                          if (-- $ready <= 0) {
                            continue;
                          }
                        }*/
						if (in_array($this->socket,$current)) {
                          for ($i=0;$i<MAX_CONNECTIONS;$i++) {
				            if ($this->cpool[$i]->resource == null) {
					          $this->sock_message_socket_create($i);
							  break;
							}
							if ($i == MAX_CONNECTIONS -1) {
							  break;
							}
						  }	   
						}
						//sort nulls at end
						usort($this->cpool,array($this,'null_sort'));				
						//echo '3';
                        // check all clients for incoming data
                        /*for ($i = 0; $i < count($this->clientFD); $i ++) {
                          if (!isset ($this->clientFD[$i])) {
                            continue;
                          }
						  if (in_array($this->clientFD[$i], $readFDs)) {
						     						
						
						
                            $command_line = $this->Read($i);
                            if (!empty ($command_line)) {
                               $this->dispatch($command_line,$i);
                            }//no empty cmd
						  }//is in array
						}//for all clients*/
						for ($i=0;$i<MAX_CONNECTIONS;$i++) {
						  //all valid connections procceded, stop here
						  //if ($this->cpool[$i]->resource==null) {
						  if (!is_resource($this->cpool[$i]->resource)) {
						    break;
						  }
						  if (in_array($this->cpool[$i]->resource,$current)) {
	
                            $command_line = $this->Read($i);
                            if (!empty ($command_line)) {
                               $this->dispatch($command_line,$i);
                            }
							if ((!SILENCE) || (!$this->cpool[$i]->session['Silent'])) {
							  if (SHOW_PROMPT) {
                                if ($this->cpool[$i]->resource)//?????
								  $this->showPrompt($i);
							  }	  
                            }						  
						  }
						}
						//echo '4';
                  }//while
				  //}//declare
				}
}//declare
        }//end of function
		
		function RegisterAction($action) {
		
		  register_tick_function($action,true);
		}
		
		
        function show_connections() {
		
		  //echo "<pre>";
		  //print_r($this->cpool);
		  //echo "</pre>";
		  if (is_array($this->cpool)) {
            foreach ($this->cpool as $i=>$conn) {
		      if (is_array($conn->session)) {	
			    //$sessions[] = $conn->session;
				if ($i==0)
					echo implode("\t",array_keys($conn->session)) . "\n";
			    echo implode("\t",$conn->session) . "\n";
			  }	
		    }	
		    
            //echo "<pre>";
		    //print_r($sessions);
		    //echo "</pre>";
			
		  }		  	  
		  
		  return ($sessions);
        }		
//END OF CLASS
}

class connect_pool {

  var $login;
  var $password;
  var $id;
  var $connected;
  var $last_transmit;
  var $name;
  var $resource;
  var $session; 
  
  function connect_pool() {
    $this->resource = null;
  }
  
  function reset_client() {
  
    $this->login = null;
    $this->password = null;
    $this->id = null;
    $this->connected = null;	
    $this->last_transmit = null;
    $this->name = null;
    $this->resource = null;			
	$this->session = array();
  }
  
}

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php
if (!defined("ASKBILL_DPC")) {
define("ASKBILL_DPC",true);

$__DPC['ASKBILL_DPC'] = 'askbill';

require ("phpdac5://localhost:19123/askbill/gengtk.gtk.php");
//$d = GetGlobal('controller')->require_dpc('askbill/gengtk.lib.php');
//require_once($d); 
require ("askbill/mbox.gtk.php");
//$e = GetGlobal('controller')->require_dpc('askbill/mbox.lib.php');
//require_once($e); 
require ("askbill/excel.lib.php");
//$z = GetGlobal('controller')->require_dpc('askbill/excel.lib.php');
//require_once($z); 


class askbill {  
   
   var $action;
   var $path;
   var $proj;


   function askbill($env=null) {	
      global $argv; 
	  
	  $this->proj = null;  
	  $this->path = null;
	  
	  $this->env = $env;
	  
    /*  if (!class_exists('gtk')) {	  
      if (strtoupper(substr(PHP_OS, 0, 3)) == 'WIN') 
        dl('php_gtk.dll'); 
      else 
        dl('php_gtk.so');   
	  }	*/
   
      //define ('STDIN',fopen("php://stdin","r"));
   }  

   function render($arg1=null,$arg2=null,$arg3=false) {      	   
	   $executed = false;

	   while (!0) { 

          echo $this->proj."ASKBILL $>"; 

		  //$this->action = trim(fgets(STDIN,256)); //echo $action;
		  if (($arg1) && (!$executed)) {
			  //echo $cmd . "----\n";
			  $command = array($arg1,$arg2,$arg3); 
			  //print_r($command);
			  $this->action = $arg1; //$command[0];
			  $executed = true;
		  }
		  else {//echo $i++ , $arg1 , $arg3, $executed;
		      if ($arg3) break; //exit code for arg3
			  
              $command = explode(" ",trim(fgets(STDIN,256)));
			  $this->action = $command[0]; 
		  }
  
          switch ($this->action) {
			  
		   case 'http' :
				//require_once($this->env->ldscheme . "/tcp/saslclient.lib.php");
				//require_once($this->env->ldscheme . "/tcp/httpclient.lib.php");
				//include at agents.ini
				$http=new httpclient($this->env);
				$http->timeout=0;
				$http->data_timeout=0;
				$http->debug=1;
				$http->html_debug=1;				
				$http->user_agent="Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)";
				$http->follow_redirect=0;
				$http->prefer_curl=0;
				$user="info@e-basis.gr";
				$password="basis2012!@";
				$realm="";       /* Authentication realm or domain      */
				$workstation=""; /* Workstation for NTLM authentication */
				$authentication=(strlen($user) ? UrlEncode($user).":".UrlEncode($password)."@" : "");
				
				$url="http://".$authentication.$command[1];//"www.php.net/";
				
				$error=$http->GetRequestArguments($url,$arguments);

				if(strlen($realm))
					$arguments["AuthRealm"]=$realm;

				if(strlen($workstation))
					$arguments["AuthWorkstation"]=$workstation;

				$http->authentication_mechanism=""; // force a given authentication mechanism;
				$arguments["Headers"]["Pragma"]="nocache";
				
				echo "Opening connection to:\n",HtmlSpecialChars($arguments["HostName"]),"\n";
				flush();
				$error=$http->Open($arguments);
				
	if($error=="")
	{
		echo "Sending request for page:\n";
		echo HtmlSpecialChars($arguments["RequestURI"]),"\n";
		if(strlen($user))
			echo "\nLogin:    ",$user,"\nPassword: ",str_repeat("*",strlen($password));
		echo "\n";
		flush();
		$error=$http->SendRequest($arguments);
		echo "\n";

		if($error=="")
		{
			echo "Request:\n\n".HtmlSpecialChars($http->request)."\n";
			echo "Request headers:\n\n";
			for(Reset($http->request_headers),$header=0;$header<count($http->request_headers);Next($http->request_headers),$header++)
			{
				$header_name=Key($http->request_headers);
				if(GetType($http->request_headers[$header_name])=="array")
				{
					for($header_value=0;$header_value<count($http->request_headers[$header_name]);$header_value++)
						echo $header_name.": ".$http->request_headers[$header_name][$header_value],"\r\n";
				}
				else
					echo $header_name.": ".$http->request_headers[$header_name],"\r\n";
			}
			echo "\n";
			flush();

			$headers=array();
			$error=$http->ReadReplyHeaders($headers);
			echo "\n";
			if($error=="")
			{
				echo "Response status code:\n".$http->response_status;
				switch($http->response_status)
				{
					case "301":
					case "302":
					case "303":
					case "307":
						echo " (redirect to ".$headers["location"].")\nSet the follow_redirect variable to handle redirect responses automatically.";
						break;
				}
				echo "\n";
				echo "Response headers:\n\n";
				for(Reset($headers),$header=0;$header<count($headers);Next($headers),$header++)
				{
					$header_name=Key($headers);
					if(GetType($headers[$header_name])=="array")
					{
						for($header_value=0;$header_value<count($headers[$header_name]);$header_value++)
							echo $header_name.": ".$headers[$header_name][$header_value],"\r\n";
					}
					else
						echo $header_name.": ".$headers[$header_name],"\r\n";
				}
				echo "\n";
				flush();

				echo "Response body:\n\n";
				/*You can read the whole reply body at once or
				block by block to not exceed PHP memory limits.
				*/
				/*
				$error = $http->ReadWholeReplyBody($body);
				if(strlen($error) == 0)
					echo HtmlSpecialChars($body);
				*/

				for(;;)
				{
					$error=$http->ReadReplyBody($body,1000);
					if($error!=""
					|| strlen($body)==0)
						break;
					echo $body;//HtmlSpecialChars($body);
				}

				echo "\n";
				flush();
			}
		}
		$http->Close();
	}
	if(strlen($error))
		echo "Error: ",$error,"\n";
                //MEM ALLOC ERROR (intime)
				//$this->env->get_agent('resources')->set_resource('httpvar',$body);
                break;	

				
			  
		   case 'printipp' : 	 
		        require_once($this->env->ldscheme . "/tcp/PrintIPP.lib.php");
				if ($text = $command[1]) {						
					$ipp = new PrintIPP();

					//$ipp->setUnix();

					$ipp->setHost($command[2] ? $command[2] : 'www.e-basis.gr');
					$ipp->setPort($command[3] ? $command[3] : 80);

					//$ipp->setPrinterUri("ipp://localhost:631/printers/Parallel_Port_1");
					//$ipp->setPrinterUri("http://www.stereobit.gr/e-Enterprise.printer");
					$ipp->setPrinterUri("http://www.e-basis.gr/e-Enterprise.printer");

					$ipp->setData($text);
					//$ipp->setUserName('info@e-basis.gr');

					//$ipp->setCharset('utf-8');
					//$ipp->setLanguage($language);

					//$ipp->setAuthentication('info@e-basis.gr','basis2012!@');

					echo "printing job: ", $ipp->printJob(), "\n";
					unset($ipp);
				}
				else
					echo "No text specified.\n";
			               break;
						   
           case 'level'  : $ret = $this->userLevelID; break;
           case 'ver'    : $ret =  'shell script engine V0.01 on PHP'. phpversion(); break;
		   case 'time'   : 
           case 'date'   : $ret = date("d-M-Y H:i:s", time()); break;
           case 'foo'    : $ret = 'bar'; break;	
           case 'q'      : $this->quit();		   
		   case 'quit'   :			 
							//exit(); break;
							break(2);

		   case 'mis'    : $ret = $this->exportCrystalReportToPDF($command[1],$command[2]); break;		   
		   case 'explore': $ret = $this->iexplorer($command[1]); break;
		   case 'supply' : $ret = $this->search_excel($command[1]); break;	
		   	   					   
			   
           default       : //$ret = $this->exe_project($command[0]);
		                   //$ret = $this->search_excel($command[0]);
						   
						   $ret = shell_exec($command[0]);
          }		
		  
		  if ($ret) echo $ret . "\n";  
       }
   } 
   
   function quit() {
   
       fclose(STDIN);
	   die("\nAskbill died!\n");
   }
   
   function use_project($path,$proj) {   
   
      if (is_dir($path.$proj)) {

        $this->path = $path;
		$this->proj = $proj;	
		
		//unset ($this->project); //if is any
		//$this->project = new startup($this->path,$this->proj); 
		
		$ret = 'Done!';
	  }
	  else
	    $ret = 'NOT Done!!!';
		
	  return ($ret);	
   }
   
   function exe_project($cmd) {
   
    /*  if ((isset($this->path) && isset($this->proj)) &&
	      (is_dir($this->path.$this->proj)) && ($cmd)) { 
	  
	    //echo $this->path,$this->proj,'<<<<<';
        $pr = new startup($this->path,$this->proj);
        $pr->render('SH',$cmd);   
		unset($pr);
		
	    $ret = 'ok!';
	  }
	  else 
	    $ret = '<>';*/
	  
	  return ($ret);
   }
   
   function search_excel($cmd) {
   
     $result = null;
	 $sheet = null;
   
     $x = new excel();
	 $ret = "----------- Searhing AANKAL...\n";
	 $ret .= $x->search('N:\ASKBILL\bin\aankal.xls',$cmd,$result['AANKAL'],$sheet['AANKAL']);
	 $ret .= "----------- Searhing KPG...\n";	 
	 $ret .= $x->search('N:\ASKBILL\bin\kpg.xls',$cmd,$result['KPG'],$sheet['KPG']);
	 $ret .= "----------- Searhing IASON...\n";	 
	 $ret .= $x->search('N:\ASKBILL\bin\iason.xls',$cmd,$result['IASON'],$sheet['IASON']);
	 
	 
	 //print_r ($result);
	 
	 $ret .= $this->search_best_price($result,$sheet);
	 	 
	 return $ret;
   } 
   
   function search_best_price($recarray,$sheet) {
   
     $offset['AANKAL'] = 3;
     $offset['KPG'] = 3;	 
     $offset['IASON'] = 4;	 
   
     $index=null;
	 $best=99999999.99;
     foreach ($recarray as $id=>$record) {
	
	   if (is_array($record)) {
	
         //reduce prise	   
         if ($id=='IASON') 
	         $percent = 20;  
         elseif ($id=='AANKAL') {
           if (($sheet[$id]=='hp') || ($sheet[$id]=='HP'))
	         $percent = 8; 
	       else		  
             $percent = 10;
	     }		 
		 elseif ($id=='KPG')
		   $percent = 2;  
		   	   
		   
		 $ret .= "PERSENT ($id):".$percent."\n";  

	     $current_offset = $offset[$id];
	     $p = trim($record[$current_offset]);//str_replace(',','.',trim($record[$current_offset]));		 
		 $_price = floatval($p);
		 $price = ($p - ($p*$percent)/100);
		 //echo $price,">>>>>>>\n";
		 if ($price<=$best) {
	         $index = $id;
		     $best = $price;
			 //echo 'best ',$best,' ',$price;		 
		 }
		/* 
	     //echo $id;
	     foreach ($record as $i=>$rec) {
	       //echo "\n\n",$rec,"\n\n";
		   if (is_float(str_replace(',','.',trim($rec)))) {//(strstr($rec,',')) {//has ,
		   
		   echo $rec, ' ';
		   $current = floatval(str_replace(',','.',$rec)); 
		   //echo $current;
	       if (is_float($current) && ($current<=$best)) {echo $current,'>>>>>>>>>>>>>>>>',"\n";
	         $index = $id;
		     $best = $current;
			 echo 'best ',$best;
	       }	 
		   }
	     }*/
	   }	   
	 }
	 
	 $ret .= $index;
	 
	 $msg = "The best price is " . $best . " from supplier " . $index;
     //$nAnswer = MessageBox( $msg, "Answer", MB_OK + MB_ICONQUESTION + MB_DEFBUTTON2 + MB_CENTER);
	    
     $ret = $msg;
	 

      /*  $dialog = new GtkMessageDialog(Gtk::GtkWindow, Gtk::DIALOG_MODAL | Gtk::DIALOG_DESTROY_WITH_PARENT,Gtk::MESSAGE_INFO, Gtk::BUTTONS_OK,$ret);

        $dialog->run();

        $dialog->destroy();*/
	 
	 return ($ret);
   }
   
   
   function iexplorer($url) {
   
     //open PDF Documents with Internet Explorer

     $browser = new COM("InternetExplorer.Application");
     $browser->Visible = true;
     $browser->Navigate($url);   
   }
   
function exportCrystalReportToPDF( $my_report, $my_pdf )
{
  $my_report = 'c:\\panik_b_ekptoseis.rpt';
  $my_pdf = 'c:\\ppdf.pdf';

  // by dfcp/mar/06
  $ObjectFactory= New COM("CrystalReports8.ObjectFactory.1");
  $crapp = $ObjectFactory->CreateObject("CrystalDesignRunTime.Application");
  $creport = $crapp->OpenReport($my_report, 1);

  $creport->ExportOptions->DiskFileName=$my_pdf;
  $creport->ExportOptions->PDFExportAllPages=true;
  $creport->ExportOptions->DestinationType=1; // Export to File
  $creport->ExportOptions->FormatType=31; // Type: PDF
  $creport->Export(false);
  
  
  
  $this->iexplorer($my_pdf);
}    

function cr() {

$crapp = new COM("CrystalDesignRunTime.Application");
$creport = $crapp->OpenReport("d:\\athermal\\reports\\backlog.rpt", 1);
$creport->SelectPrinter("winspool", "HP LaserJet 1200 Series PCL",
"Ne01:");
$creport->PaperOrientation = 0;
$creport->PrintOut(False);
}   
     
};
}

//$sh = new askbill();
//$sh->render();
//unset($sh);

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
class GTK_window {

   var $parent;
   var $popwin;

   function GTK_window($xmltree,$title,$modal=false,
                                $winx=400,$winy=150,$border=10,
								$shrink=false,$grow=false,$auto_shrink=false,
								$noclose=false,$reconnect=false) {
						
	 global $cligtk;
	 							
	 $this->parent = $cligtk;							
   
     $this->_gtkwindow($xmltree,$title,$modal,
                                $winx,$winy,$border,
								$shrink,$grow,$auto_shrink,
								$noclose,$reconnect);   
   }
   
   //GTKWINDOW /////////////////////////////////////////////////////////////// 
   //noclose allow close window by X when false and don't allow when true'
   //reconnect : re-open the window aften any submit when true else remain closed for ever (until exit)     
   function _gtkwindow($xmltree,$title,$modal=false,
                                $winx=400,$winy=150,$border=10,
								$shrink=false,$grow=false,$auto_shrink=false,
								$noclose=false,$reconnect=false) {
   
	 
    // if ($this->{$title}==null) {
	 
       /* Creation of the window */ 
       $this->popwin = &new GtkWindow(); 
	   //$this->{$title} = & $this->popwin;
	   //$this->parent->__WINDOW[$title] = $this->popwin; 	   
	 
       $this->popwin->set_name($title); 
       $this->popwin->set_title($title); 
       $this->popwin->set_usize($winx, $winy);   
       $this->popwin->set_border_width($border); 
       $this->popwin->set_position(GTK_WIN_POS_CENTER); 
	   if ($modal==true) 
	     $this->popwin->set_modal($modal);
	   $this->popwin->set_default_size(180, 100);
	   $this->popwin->set_policy($shrink, $grow, $auto_shrink);	 
	   if ($noclose) //dont close window
	     $this->popwin->connect("delete-event",array( &$this, "OnDelete"));
	   else //close window and make null the pointer 		 	 		 	 
	     $this->popwin->connect("delete-event",array( &$this, "OnHide"),$reconnect);
	   
       $box = &new GtkVBox();
	   $this->popwin->add($box);		 
	 	
	   foreach ($xmltree as $id=>$child)
	     $this->parent->gtkxslt($box,$child);
     
       /* Tells the window to show all elements */ 
       $this->popwin->show_all();  	 
	// }
	// else {
	//   $this->popwin = & $this->{$title}; //point to current	 	 
	// }  
	 	   
   }
   
	//Don't allow the user to close the window with the (x)
	//called by the gtk dialog
	function OnDelete() {
	
		return true;	
	} 
	
	//close the window and delete the instance
	//called by gtk windows
	function OnHide($objwindow,$nWindow,$reconnect) {
	
	    $pointer = $objwindow->get_name(); //echo $pointer;    
		
		//if reconnect  is true make win pointer null to reopenit else let it hiding until end
		if ($reconnect) {
		  $this->{$pointer} = null;
	      //$this->__WINDOW[$pointer] = null;	//out of manager  
		}  
		
		$objwindow->hide(); //HIDE		
		//return false;	//DESTROY
	}	
  
}

class GTK_dialog extends GTK_window {

    var $parent;
	var $popwin;
   
    function GTK_dialog($xmltree,$title,$modal=false,
                                $winx=400,$winy=150,$border=10,
								$shrink=false,$grow=false,$auto_shrink=false) {
								
	 global $cligtk;
	 							
	 $this->parent = $cligtk;							
   
     $this->_gtkwindow($xmltree,$title,$modal,
                                $winx,$winy,$border,
								$shrink,$grow,$auto_shrink,
								true,false); 								
	}
}

class statusbar {
  
   var $sbar; //statusbar
   var $sctx; //statusbar contexts
  
   function statusbar($container) {

     $this->sbar = &new GtkStatusbar();
     $this->sctx = $this->sbar->get_context_id('foo');
     $this->sbar->push($this->sctx,'Initialize Connection ...');
     $container->pack_start($this->sbar);
     $this->sbar->show();	  
   }
   
   //add to bar stuck
   function push($context) {

     $this->sbar->push($this->sctx,$context);
   }

   // extranct from bar stuck
   function pop() {

     $this->sbar->pop($this->sctx);
   }   
   
   
}


?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
/*
 * basic_sasl_client.php
 *
 * @(#) $Id: basic_sasl_client.php,v 1.1 2004/11/17 08:01:23 mlemos Exp $
 *
 */

define("SASL_BASIC_STATE_START",    0);
define("SASL_BASIC_STATE_DONE",     1);

class basic_sasl_client_class
{
	var $credentials=array();
	var $state=SASL_BASIC_STATE_START;

	Function Initialize(&$client)
	{
		return(1);
	}

	Function Start(&$client, &$message, &$interactions)
	{
		if($this->state!=SASL_BASIC_STATE_START)
		{
			$client->error="Basic authentication state is not at the start";
			return(SASL_FAIL);
		}
		$this->credentials=array(
			"user"=>"",
			"password"=>""
		);
		$defaults=array(
		);
		$status=$client->GetCredentials($this->credentials,$defaults,$interactions);
		if($status==SASL_CONTINUE)
		{
			$message=$this->credentials["user"].":".$this->credentials["password"];
			$this->state=SASL_BASIC_STATE_DONE;
		}
		else
			Unset($message);
		return($status);
	}

	Function Step(&$client, $response, &$message, &$interactions)
	{
		switch($this->state)
		{
			case SASL_BASIC_STATE_DONE:
				$client->error="Basic authentication was finished without success";
				return(SASL_FAIL);
			default:
				$client->error="invalid Basic authentication step state";
				return(SASL_FAIL);
		}
		return(SASL_CONTINUE);
	}
};

?>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                